<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta name="version" content="2.1.0-premium-ui">
<title>旅のしおり</title>
<style>
/* ===== CSS Custom Properties — 2026 Premium Travel UI ===== */
/* Inspired by FlightNetwork, premium airline UIs, deep navy + gold accents */
:root {
  --c-primary: #1a237e;
  --c-primary-light: #3949ab;
  --c-primary-dark: #000051;
  --c-primary-glow: rgba(26,35,126,0.15);
  --c-gold: #c9a84c;
  --c-gold-light: #e2c36b;
  --c-gold-dark: #a68a3a;
  --c-danger: #e5443a;
  --c-danger-dark: #c0362e;
  --c-success: #00c853;
  --c-bg: #f4f5f8;
  --c-surface: rgba(255,255,255,0.88);
  --c-surface-solid: #ffffff;
  --c-text: #0d1b2a;
  --c-text2: #5c6b7a;
  --c-border: rgba(0,0,0,0.06);
  --c-jpy: #e5443a;
  --c-aud: #1a237e;
  --c-accent: #0277bd;
  --sp-xs: 4px;
  --sp-sm: 8px;
  --sp-md: 16px;
  --sp-lg: 24px;
  --sp-xl: 32px;
  --font: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
  --fs-xs: 0.6875rem;
  --fs-sm: 0.8125rem;
  --fs-base: 0.9375rem;
  --fs-lg: 1.0625rem;
  --fs-xl: 1.25rem;
  --radius-xs: 8px;
  --radius-sm: 12px;
  --radius-md: 20px;
  --radius-lg: 28px;
  --radius-full: 9999px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 16px -4px rgba(13,27,42,0.10), 0 2px 6px rgba(0,0,0,0.04);
  --shadow-lg: 0 12px 32px -8px rgba(13,27,42,0.14), 0 4px 12px rgba(0,0,0,0.04);
  --shadow-gold: 0 4px 16px -4px rgba(201,168,76,0.25);
  --header-h: 56px;
  --tab-h: 64px;
  --max-w: 560px;
  --tap: 44px;
  --glass-blur: 20px;
  --t-fast: 0.18s cubic-bezier(0.4,0,0.2,1);
  --t-spring: 0.35s cubic-bezier(0.34,1.56,0.64,1);
  --t-smooth: 0.3s cubic-bezier(0.4,0,0.2,1);
}

/* ===== Reset & Base ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
body {
  font-family: var(--font);
  font-size: var(--fs-base);
  background: var(--c-bg);
  color: var(--c-text);
  padding-top: var(--header-h);
  padding-bottom: calc(var(--tab-h) + env(safe-area-inset-bottom, 0px));
  min-height: 100dvh;
  -webkit-tap-highlight-color: transparent;
  line-height: 1.55;
  -webkit-font-smoothing: antialiased;
}
input, select, button, textarea { font-family: inherit; font-size: inherit; }
a { color: var(--c-primary); text-decoration: none; }
a:hover { text-decoration: underline; }

/* ===== Header — premium deep navy ===== */
.app-header {
  position: fixed; top: 0; left: 0; right: 0;
  height: var(--header-h);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 var(--sp-lg);
  background: linear-gradient(135deg, #000040 0%, #0a0f5c 40%, #1a237e 100%);
  backdrop-filter: saturate(180%) blur(var(--glass-blur));
  -webkit-backdrop-filter: saturate(180%) blur(var(--glass-blur));
  color: #fff;
  z-index: 150;
  border-bottom: 1px solid rgba(201,168,76,0.25);
  box-shadow: 0 2px 20px -2px rgba(0,0,40,0.4);
}
.app-title {
  font-size: var(--fs-xl); font-weight: 800; letter-spacing: 0.02em;
  background: linear-gradient(135deg, var(--c-gold-light) 0%, var(--c-gold) 50%, var(--c-gold-light) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: none;
}
.header-actions { display: flex; align-items: center; gap: 8px; }
.icon-btn {
  width: 38px; height: 38px;
  display: flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.08); border: 1px solid rgba(201,168,76,0.2);
  border-radius: var(--radius-sm);
  color: rgba(255,255,255,0.9); font-size: 1.1rem; cursor: pointer;
  transition: background var(--t-fast), transform var(--t-fast), border-color var(--t-fast);
}
.icon-btn:hover { background: rgba(201,168,76,0.15); border-color: rgba(201,168,76,0.4); }
.icon-btn:active { transform: scale(0.92); }

/* ===== Tab Navigation — premium bottom bar ===== */
.tab-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  height: var(--tab-h);
  display: flex;
  background: rgba(255,255,255,0.85);
  backdrop-filter: saturate(200%) blur(var(--glass-blur));
  -webkit-backdrop-filter: saturate(200%) blur(var(--glass-blur));
  border-top: 1px solid rgba(26,35,126,0.08);
  padding-bottom: env(safe-area-inset-bottom, 0px);
  z-index: 100;
  box-shadow: 0 -2px 12px rgba(0,0,40,0.06);
}
.tab-btn {
  flex: 1;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 3px;
  background: none; border: none;
  color: var(--c-text2);
  font-size: var(--fs-xs);
  cursor: pointer;
  transition: color var(--t-fast), transform var(--t-fast);
  position: relative;
  -webkit-tap-highlight-color: transparent;
  padding: 0 2px;
  font-weight: 500;
}
.tab-btn:active { transform: scale(0.93); }
.tab-btn.active { color: var(--c-primary); font-weight: 700; }
.tab-btn.active .tab-icon {
  background: rgba(26,35,126,0.1);
  border-radius: var(--radius-full);
  padding: 2px 12px;
}
.tab-btn::before {
  content: '';
  position: absolute; top: 0; left: 50%; transform: translateX(-50%) scaleX(0);
  width: 24px; height: 3px;
  background: linear-gradient(90deg, var(--c-primary), var(--c-gold));
  border-radius: 0 0 3px 3px;
  transition: transform var(--t-spring);
}
.tab-btn.active::before { transform: translateX(-50%) scaleX(1); }
.tab-icon { font-size: 1.2rem; line-height: 1; transition: background var(--t-fast), padding var(--t-fast), transform var(--t-spring); padding: 2px 0; }
.tab-btn.active .tab-icon { transform: translateY(-1px); }

/* ===== Tab Content ===== */
.tab-content {
  display: none;
  max-width: var(--max-w);
  margin: 0 auto;
  padding: var(--sp-md);
  overflow-x: hidden;
  animation: fadeIn 0.25s ease;
}
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

/* ===== Card — premium glass surface ===== */
.card {
  background: var(--c-surface);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border: 1px solid rgba(255,255,255,0.6);
  border-radius: var(--radius-md);
  padding: var(--sp-lg);
  margin-bottom: var(--sp-md);
  box-shadow: var(--shadow-md);
  transition: box-shadow var(--t-smooth), border-color var(--t-smooth), transform var(--t-smooth);
}
.card-title {
  font-size: var(--fs-lg);
  font-weight: 800;
  margin-bottom: var(--sp-md);
  display: flex; align-items: center; gap: var(--sp-sm);
  letter-spacing: -0.01em;
  color: var(--c-primary);
}
.card-desc { font-size: var(--fs-sm); color: var(--c-text2); margin-bottom: var(--sp-md); line-height: 1.5; }

/* ===== Forms — soft rounded ===== */
.form-input {
  width: 100%; max-width: 100%;
  min-height: var(--tap);
  padding: 10px 14px;
  border: 1.5px solid rgba(0,0,0,0.08);
  border-radius: var(--radius-sm);
  background: rgba(255,255,255,0.7);
  color: var(--c-text);
  transition: border-color var(--t-fast), box-shadow var(--t-fast), background var(--t-fast);
}
.form-input:focus {
  outline: none;
  border-color: var(--c-primary);
  box-shadow: 0 0 0 3px rgba(26,35,126,0.08), 0 0 0 1px rgba(201,168,76,0.15);
  background: #fff;
}
.form-input::placeholder { color: #a0aab4; }
/* date/time inputs: Safari/WebKit overflow fix for all screen sizes */
input[type="date"].form-input,
input[type="time"].form-input {
  -webkit-appearance: none;
  appearance: none;
  min-width: 0;
  max-width: 100%;
}
textarea.form-input { min-height: 60px; resize: vertical; }
.inline-form { display: flex; gap: var(--sp-sm); }
.inline-form .form-input { flex: 1; }
.form-group { margin-bottom: var(--sp-md); }
.form-group > label {
  display: block; font-size: var(--fs-sm); font-weight: 600;
  color: var(--c-text2); margin-bottom: 6px;
  letter-spacing: 0.01em;
}
.form-row { display: flex; gap: var(--sp-md); align-items: flex-end; }
.form-row .form-group { margin-bottom: var(--sp-md); }
.flex-grow { flex: 1; min-width: 0; }
.form-actions { margin-top: var(--sp-md); display: flex; flex-direction: column; gap: var(--sp-sm); }

/* ===== Buttons — pill-shaped primary ===== */
.btn {
  display: inline-flex; align-items: center; justify-content: center;
  min-height: var(--tap);
  padding: 10px var(--sp-lg);
  border: none; border-radius: var(--radius-sm);
  font-weight: 700; cursor: pointer;
  transition: background var(--t-fast), transform 0.12s, box-shadow var(--t-fast);
  white-space: nowrap;
  letter-spacing: 0.01em;
}
.btn:active { transform: scale(0.96); }
.btn-primary {
  background: linear-gradient(135deg, var(--c-primary) 0%, var(--c-primary-light) 100%);
  color: #fff;
  box-shadow: 0 4px 14px -2px rgba(26,35,126,0.35);
  position: relative;
  overflow: hidden;
}
.btn-primary::before { content:''; position:absolute; inset:0; background:linear-gradient(135deg, transparent 0%, rgba(201,168,76,0.12) 100%); opacity:0; transition:opacity var(--t-fast); }
.btn-primary:hover { box-shadow: 0 6px 20px -2px rgba(26,35,126,0.45); }
.btn-primary:hover::before { opacity:1; }
.btn-secondary { background: rgba(0,0,0,0.05); color: var(--c-text); border: 1px solid rgba(0,0,0,0.08); }
.btn-secondary:hover { background: rgba(0,0,0,0.08); }
.btn-danger {
  background: linear-gradient(135deg, var(--c-danger) 0%, #f06050 100%);
  color: #fff;
  box-shadow: 0 4px 12px -2px rgba(229,68,58,0.3);
}
.btn-danger:hover { box-shadow: 0 6px 16px -2px rgba(229,68,58,0.4); }
.btn-block { width: 100%; }
.btn-sm {
  min-height: 32px; padding: 6px 12px;
  font-size: var(--fs-sm); border-radius: var(--radius-xs);
  background: rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.06);
  cursor: pointer; font-weight: 600;
  transition: background var(--t-fast), transform 0.1s;
}
.btn-sm:hover { background: rgba(0,0,0,0.07); }
.btn-sm:active { transform: scale(0.96); }
.btn-icon-sm {
  width: 34px; height: 34px;
  display: inline-flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.06);
  border-radius: var(--radius-xs);
  cursor: pointer; font-size: 0.9rem; color: var(--c-text2);
  transition: background var(--t-fast), transform 0.1s, color var(--t-fast), border-color var(--t-fast);
}
.btn-icon-sm:hover { background: rgba(0,0,0,0.06); }
.btn-icon-sm:active { transform: scale(0.9); }
.btn-icon-sm.danger:hover { background: #fef2f2; color: var(--c-danger); border-color: var(--c-danger); }

/* ===== Currency Toggle — pill style ===== */
.currency-toggle {
  display: inline-flex;
  border-radius: var(--radius-sm);
  overflow: hidden;
  border: 2px solid rgba(0,0,0,0.06);
  background: rgba(0,0,0,0.03);
}
.toggle-btn {
  padding: 10px var(--sp-md);
  min-height: var(--tap);
  border: none;
  background: transparent;
  font-weight: 700;
  cursor: pointer;
  transition: background var(--t-fast), color var(--t-fast), transform 0.1s;
  font-size: var(--fs-base);
}
.toggle-btn:active { transform: scale(0.95); }
.toggle-btn.active-jpy { background: var(--c-jpy); color: #fff; border-radius: var(--radius-xs); }
.toggle-btn.active-aud { background: var(--c-aud); color: #fff; border-radius: var(--radius-xs); }

/* ===== Checkbox Grid — soft chips ===== */
.split-controls { display: flex; gap: var(--sp-sm); margin-bottom: var(--sp-sm); }
.checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: var(--sp-sm);
}
.checkbox-grid label {
  display: flex; align-items: center; gap: var(--sp-sm);
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  background: rgba(0,0,0,0.03);
  border: 1.5px solid transparent;
  min-height: var(--tap);
  cursor: pointer;
  font-weight: 600;
  transition: background var(--t-fast), border-color var(--t-fast), transform 0.1s;
}
.checkbox-grid label:active { transform: scale(0.97); }
.checkbox-grid label:has(input:checked) {
  background: rgba(26,35,126,0.08);
  border-color: rgba(26,35,126,0.3);
}
.checkbox-grid input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--c-primary); cursor: pointer; border-radius: 4px; }

/* ===== Item Lists ===== */
.item-list { list-style: none; }
.list-item {
  display: flex; align-items: center; gap: var(--sp-sm);
  padding: 14px 0;
  border-bottom: 1px solid rgba(0,0,0,0.04);
  transition: background var(--t-fast);
}
.list-item:last-child { border-bottom: none; }
.member-name { font-weight: 700; flex: 1; cursor:pointer; border-bottom:1px dashed transparent; transition:border-color var(--t-fast); }
.member-name:hover { border-bottom-color:rgba(0,0,0,0.2); }
.member-name-edit { flex:1; font-size:var(--fs-sm); font-weight:700; padding:2px 6px; border:1.5px solid var(--c-primary); border-radius:var(--radius-xs); outline:none; min-width:0; }
.member-color-dot {
  width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  transition: transform var(--t-fast), box-shadow var(--t-fast);
}
.list-item:hover .member-color-dot { transform: scale(1.2); }
.member-color-picker {
  width: 30px; height: 30px; border: none; padding: 0;
  border-radius: var(--radius-xs); cursor: pointer; background: none;
}
.member-badge {
  display: inline-block; padding: 3px 10px; border-radius: var(--radius-full);
  font-size: 0.7rem; font-weight: 700; color: #fff; margin-right: 4px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.12);
}
.empty-msg { text-align: center; color: var(--c-text2); padding: var(--sp-xl) 0; font-size: var(--fs-sm); }

/* ===== Expense Items ===== */
.expense-item {
  padding: 14px 0;
  border-bottom: 1px solid rgba(0,0,0,0.04);
  transition: background var(--t-fast);
}
.expense-item:last-child { border-bottom: none; }
.exp-show-all-btn { display:block; width:100%; padding:10px; margin-top:var(--sp-sm); background:rgba(26,35,126,0.06); color:var(--c-primary); border:none; border-radius:var(--radius-sm); font-size:var(--fs-sm); font-weight:700; cursor:pointer; transition:background var(--t-fast); }
.exp-show-all-btn:hover { background:rgba(26,35,126,0.12); }
.expense-top { display: flex; align-items: flex-start; justify-content: space-between; gap: var(--sp-sm); }
.expense-info { flex: 1; min-width: 0; }
.expense-memo { font-weight: 700; word-break: break-word; }
.expense-detail { font-size: var(--fs-sm); color: var(--c-text2); margin-top: 3px; }
.expense-right { text-align: right; flex-shrink: 0; }
.expense-amount { font-size: var(--fs-lg); font-weight: 800; letter-spacing: -0.02em; }
.expense-amount.jpy { color: var(--c-jpy); }
.expense-amount.aud { color: var(--c-aud); }
.expense-date { font-size: var(--fs-sm); color: var(--c-text2); }
.expense-actions { display: flex; gap: 6px; margin-top: var(--sp-sm); justify-content: flex-end; }
.summary-bar {
  background: rgba(26,35,126,0.06); border-radius: var(--radius-sm);
  padding: 10px var(--sp-md);
  margin-bottom: var(--sp-md);
  font-size: var(--fs-sm); font-weight: 700;
  text-align: center;
}
.summary-bar:empty { display: none; }

/* ===== Settlement — soft cards ===== */
.exchange-rate-form {
  display: flex; align-items: center; gap: var(--sp-sm);
  font-weight: 700;
}
.exchange-rate-form .form-input { width: 100px; text-align: center; }
.rate-status { font-size: var(--fs-sm); color: var(--c-text2); margin-top: var(--sp-sm); }
.rate-status.success { color: var(--c-success); }
.rate-status.error { color: var(--c-danger); }
.settlement-currency { margin-top: var(--sp-sm); }
.balance-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid rgba(0,0,0,0.04);
}
.balance-item:last-child { border-bottom: none; }
.balance-name { font-weight: 700; }
.balance-amount { font-weight: 800; font-size: var(--fs-lg); letter-spacing: -0.02em; }
.balance-amount.positive { color: var(--c-success); }
.balance-amount.negative { color: var(--c-danger); }
.settlement-item {
  display: flex; align-items: center;
  padding: 14px var(--sp-md);
  margin-bottom: var(--sp-sm);
  background: rgba(26,35,126,0.04);
  border-radius: var(--radius-sm);
  border-left: 4px solid var(--c-primary);
  gap: var(--sp-sm);
  flex-wrap: wrap;
  transition: background var(--t-fast);
}
.settlement-from, .settlement-to { font-weight: 700; }
.settlement-arrow { color: var(--c-text2); font-size: 1.2rem; }
.settlement-amount { margin-left: auto; font-weight: 800; color: var(--c-primary); font-size: var(--fs-lg); }

/* ===== Itinerary (スケジュール) — refined timeline ===== */
.itin-day-group { margin-bottom: var(--sp-lg); }
.itin-day-header {
  display: flex; align-items: center; gap: var(--sp-sm);
  padding: 10px var(--sp-md);
  background: linear-gradient(135deg, #000040 0%, var(--c-primary) 50%, var(--c-primary-light) 100%);
  color: #fff;
  border-radius: var(--radius-sm);
  font-weight: 800;
  font-size: var(--fs-base);
  margin-bottom: var(--sp-sm);
  position: sticky; top: var(--header-h); z-index: 10;
  box-shadow: 0 4px 16px -3px rgba(0,0,40,0.3);
  letter-spacing: 0.01em;
  border-bottom: 2px solid rgba(201,168,76,0.3);
}
.itin-day-header.today {
  background: linear-gradient(135deg, #004d40 0%, var(--c-success) 50%, #00e676 100%);
  box-shadow: 0 4px 16px -3px rgba(0,200,83,0.3);
  border-bottom-color: rgba(0,200,83,0.4);
}
.itin-day-label { font-size: var(--fs-sm); font-weight: 500; opacity: 0.9; margin-left: auto; }
.itin-timeline { position: relative; padding-left: 38px; }
.itin-timeline::before {
  content: '';
  position: absolute; left: 15px; top: 0; bottom: 0;
  width: 2px; background: rgba(0,0,0,0.06);
  border-radius: 1px;
}
.itin-event {
  position: relative;
  background: var(--c-surface);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.5);
  border-radius: var(--radius-md);
  padding: var(--sp-md);
  margin-bottom: 10px;
  box-shadow: var(--shadow-sm);
  border-left: 4px solid rgba(26,35,126,0.12);
  transition: box-shadow var(--t-smooth), transform var(--t-smooth), border-color var(--t-smooth);
}
.itin-event:active { transform: scale(0.99); }
.itin-event.next-up {
  border-left-color: var(--c-success);
  box-shadow: 0 0 0 2px rgba(0,200,83,0.15), var(--shadow-md);
}
.itin-event-dot {
  position: absolute;
  left: -30px; top: 16px;
  width: 26px; height: 26px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.8rem;
  background: var(--c-surface-solid);
  border: 2.5px solid rgba(0,0,0,0.08);
  border-radius: 50%;
  z-index: 1;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  transition: border-color var(--t-fast), box-shadow var(--t-fast);
}
.itin-event.next-up .itin-event-dot { border-color: var(--c-success); box-shadow: 0 0 0 3px rgba(34,197,94,0.15); }
.itin-event-cat-flight { border-left-color: #3b82f6; }
.itin-event-cat-flight .itin-event-dot { border-color: #3b82f6; }
.itin-event-cat-hotel { border-left-color: #a855f7; }
.itin-event-cat-hotel .itin-event-dot { border-color: #a855f7; }
.itin-event-cat-sightseeing { border-left-color: #f59e0b; }
.itin-event-cat-sightseeing .itin-event-dot { border-color: #f59e0b; }
.itin-event-cat-food { border-left-color: #ef4444; }
.itin-event-cat-food .itin-event-dot { border-color: #ef4444; }
.itin-event-cat-transport { border-left-color: #06b6d4; }
.itin-event-cat-transport .itin-event-dot { border-color: #06b6d4; }
.itin-event-cat-other { border-left-color: var(--c-text2); }
.itin-event-cat-other .itin-event-dot { border-color: var(--c-text2); }
.itin-event-top { display: flex; align-items: flex-start; gap: var(--sp-sm); }
.itin-event-body { flex: 1; min-width: 0; }
.itin-event-time { font-size: var(--fs-sm); color: var(--c-text2); font-weight: 700; }
.itin-event-title { font-weight: 800; margin-top: 3px; word-break: break-word; letter-spacing: -0.01em; }
.itin-event-location { font-size: var(--fs-sm); color: var(--c-text2); margin-top: 3px; }
.itin-event-participants { font-size: 0.75rem; color: var(--c-primary); margin-top: 6px; display: flex; align-items: center; flex-wrap: wrap; gap: 3px; }
.itin-event-memo {
  font-size: var(--fs-sm); color: var(--c-text2); margin-top: var(--sp-sm);
  white-space: pre-wrap; word-break: break-word;
  background: rgba(26,35,126,0.04); border-radius: var(--radius-sm);
  padding: 10px 14px;
  display: none; border-left: 3px solid var(--c-primary);
  animation: fadeIn 0.2s ease;
}
.itin-event-memo.open { display: block; }
.itin-memo-badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 6px 10px;
  background: rgba(26,35,126,0.06); border-radius: var(--radius-xs);
  font-size: var(--fs-sm); font-weight: 600;
  color: var(--c-primary); cursor: pointer; min-height: 32px;
  user-select: none; transition: background var(--t-fast), transform 0.1s;
}
.itin-memo-badge:hover { background: rgba(26,35,126,0.1); }
.itin-memo-badge:active { transform: scale(0.96); }
.itin-memo-badge.open { background: rgba(26,35,126,0.12); }
.itin-event-links { display: flex; gap: var(--sp-sm); margin-top: var(--sp-sm); flex-wrap: wrap; }
.itin-link {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 6px 10px;
  background: rgba(26,35,126,0.06);
  border-radius: var(--radius-xs);
  font-size: var(--fs-sm); font-weight: 600;
  color: var(--c-primary);
  text-decoration: none;
  min-height: 32px;
  transition: background var(--t-fast), transform 0.1s;
}
.itin-link:hover { background: rgba(26,35,126,0.1); text-decoration: none; }
.itin-link:active { transform: scale(0.96); }
.itin-event-actions { display: flex; gap: 6px; margin-top: var(--sp-sm); justify-content: flex-end; }
@keyframes badgePulse {
  0%, 100% { box-shadow: 0 2px 6px rgba(0,200,83,0.25); }
  50% { box-shadow: 0 2px 14px rgba(0,200,83,0.5); }
}
.next-badge {
  display: inline-block;
  background: linear-gradient(135deg, #004d40 0%, var(--c-success) 50%, #69f0ae 100%);
  color: #fff;
  font-size: 0.65rem; font-weight: 800;
  padding: 3px 10px; border-radius: var(--radius-full);
  animation: badgePulse 2s ease-in-out infinite;
  margin-left: var(--sp-sm);
  box-shadow: 0 2px 6px rgba(0,200,83,0.25);
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

/* ===== Itinerary Filter — pill chips ===== */
.itin-filter {
  display: flex; gap: 8px; margin-bottom: var(--sp-md);
  flex-wrap: wrap;
}
.filter-btn {
  padding: 6px 14px; border-radius: var(--radius-full);
  border: 1.5px solid rgba(0,0,0,0.08); background: rgba(255,255,255,0.6);
  font-size: var(--fs-sm); font-weight: 600; cursor: pointer;
  transition: background var(--t-fast), border-color var(--t-fast), transform 0.1s, box-shadow var(--t-fast);
}
.filter-btn:hover { background: rgba(255,255,255,0.9); }
.filter-btn:active { transform: scale(0.95); }
.filter-btn.active {
  font-weight: 800;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

/* ===== Sync Dot (inside button) ===== */
.sync-dot {
  position: absolute; top: 3px; right: 3px;
  width: 9px; height: 9px;
  border-radius: 50%;
  background: #64748b;
  border: 2px solid rgba(255,255,255,0.9);
  transition: background 0.3s;
  pointer-events: none;
}
.sync-dot.synced { background: #22c55e; }
.sync-dot.syncing { background: #f59e0b; animation: pulse 1s infinite; }
.sync-dot.error { background: #ef4444; }
.sync-dot.off { background: #94a3b8; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
@keyframes spin { to { transform: rotate(360deg); } }
.icon-btn.syncing { animation: spin 1s linear infinite; }

/* ===== Modal — glass card ===== */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  display: flex; align-items: center; justify-content: center;
  z-index: 200;
  padding: var(--sp-md);
  animation: fadeIn 0.2s ease;
}
.modal-overlay[hidden] { display: none !important; }
.modal {
  background: var(--c-surface-solid);
  border-radius: var(--radius-lg);
  padding: var(--sp-xl);
  max-width: 360px; width: 100%;
  box-shadow: var(--shadow-lg);
  max-height: calc(100vh - 40px);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  animation: modalPop 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes modalPop { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
.modal-message { font-size: var(--fs-base); font-weight: 600; margin-bottom: var(--sp-lg); line-height: 1.5; }
.modal-actions { display: flex; gap: var(--sp-sm); justify-content: flex-end; }

/* ===== Toast — pill with shadow ===== */
.toast {
  position: fixed;
  bottom: calc(var(--tab-h) + var(--sp-lg) + env(safe-area-inset-bottom, 0px));
  left: 50%; transform: translateX(-50%) translateY(20px);
  opacity: 0;
  background: rgba(26,34,51,0.9);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  color: #fff;
  padding: 10px var(--sp-lg);
  border-radius: var(--radius-full);
  font-size: var(--fs-sm); font-weight: 600;
  transition: opacity 0.3s, transform var(--t-spring);
  z-index: 300;
  pointer-events: none;
  white-space: nowrap;
  box-shadow: var(--shadow-lg);
}
.toast[hidden] { display: none; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ===== Mobile compact ===== */
@media (max-width: 480px) {
  :root {
    --sp-sm: 6px;
    --sp-md: 10px;
    --sp-lg: 14px;
    --sp-xl: 20px;
    --tap: 38px;
    --header-h: 48px;
    --tab-h: 52px;
    --fs-sm: 0.75rem;
    --fs-base: 0.8125rem;
    --fs-lg: 0.9375rem;
    --fs-xl: 1.0625rem;
    --radius-sm: 10px;
    --radius-md: 16px;
    --radius-lg: 24px;
  }
  body { font-size: 0.8125rem; }
  .tab-content { padding: 8px; }
  .card { padding: 14px; margin-bottom: 10px; overflow: hidden; }
  .card-title { font-size: 0.9rem; margin-bottom: 10px; }
  .card-desc { font-size: 0.7rem; margin-bottom: 8px; }
  .form-group { margin-bottom: 10px; }
  .form-group > label { font-size: 0.7rem; margin-bottom: 3px; }
  .form-input { min-height: 36px; padding: 7px 10px; font-size: 0.8rem; }
  input[type="date"].form-input,
  input[type="time"].form-input {
    padding: 7px 6px; font-size: 0.75rem;
    -webkit-appearance: none; appearance: none;
    min-width: 0 !important; max-width: 100% !important;
  }
  textarea.form-input { min-height: 48px; }
  .form-row { gap: 6px; }
  .form-row .form-group { margin-bottom: 10px; overflow: hidden; }
  .card > form, .card form { width: 100%; overflow: hidden; }
  .form-actions { margin-top: 10px; gap: 6px; }
  .btn { min-height: 36px; padding: 7px 14px; font-size: 0.8rem; }
  .btn-sm { min-height: 30px; padding: 4px 10px; font-size: 0.7rem; }
  .btn-icon-sm { width: 30px; height: 30px; font-size: 0.8rem; }
  .inline-form { gap: 6px; }
  .inline-form .btn { padding: 7px 14px; }
  .app-title { font-size: 1rem; }
  .icon-btn { width: 34px; height: 34px; font-size: 1rem; }
  .tab-btn { font-size: 0.6rem; }
  .tab-icon { font-size: 1.1rem; }
  .expense-item { padding: 10px 0; }
  .expense-memo { font-size: 0.8rem; }
  .expense-detail { font-size: 0.7rem; }
  .empty-msg { font-size: 0.8rem; padding: 20px 8px; }
  .item-list li { padding: 10px 0; }
  .modal { padding: 20px; border-radius: var(--radius-lg); }
  .modal-message { font-size: 0.85rem; }
  .itin-event { border-radius: var(--radius-sm); padding: 12px; }
  .itin-day-header { border-radius: var(--radius-xs); }
}

/* ===== Focus accessibility — soft glow ===== */
:focus-visible {
  outline: 2px solid var(--c-primary);
  outline-offset: 2px;
  border-radius: var(--radius-xs);
}
.btn:focus-visible, .btn-sm:focus-visible, .btn-icon-sm:focus-visible, .icon-btn:focus-visible {
  box-shadow: 0 0 0 3px rgba(26,35,126,0.25);
}

/* ===== Smooth entry for list items ===== */
@keyframes slideUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
.expense-item, .list-item, .balance-item, .settlement-item {
  animation: slideUp 0.3s ease both;
}
.itin-event {
  animation: slideUp 0.35s ease both;
}
.itin-day-group:nth-child(1) .itin-event:nth-child(1) { animation-delay: 0s; }
.itin-day-group:nth-child(1) .itin-event:nth-child(2) { animation-delay: 0.04s; }
.itin-day-group:nth-child(1) .itin-event:nth-child(3) { animation-delay: 0.08s; }
.itin-day-group:nth-child(1) .itin-event:nth-child(4) { animation-delay: 0.12s; }
.itin-day-group:nth-child(1) .itin-event:nth-child(5) { animation-delay: 0.16s; }

/* ===== Hover lift for cards (touch devices no-op) ===== */
@media (hover: hover) {
  .itin-event:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    border-color: rgba(201,168,76,0.15);
  }
  .expense-item:hover {
    background: rgba(26,35,126,0.02);
    border-radius: var(--radius-sm);
  }
  .list-item:hover { background: rgba(26,35,126,0.015); }
  .settlement-item:hover { background: rgba(26,35,126,0.08); }
  .balance-item:hover { background: rgba(26,35,126,0.015); }
}

/* ===== Selection colors ===== */
::selection { background: rgba(26,35,126,0.18); color: inherit; }

/* ===== Scrollbar — thin & subtle ===== */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }

/* ===== Empty state illustration ===== */
.empty-msg {
  position: relative;
  padding: var(--sp-xl) var(--sp-md);
}
.empty-msg::before {
  content: '';
  display: block;
  width: 48px; height: 48px;
  margin: 0 auto 12px;
  background: rgba(26,35,126,0.06);
  border-radius: 50%;
}

/* ===== Card title emoji spacing ===== */
.card-title > :first-child { margin-right: 2px; }

/* ===== Day header shimmer for today ===== */
@keyframes todayShimmer {
  0% { background-position: -200% center; }
  100% { background-position: 200% center; }
}
.itin-day-header.today {
  background-size: 200% 100%;
  background-image: linear-gradient(
    90deg,
    #004d40 0%, #00c853 25%, #69f0ae 50%, #00c853 75%, #004d40 100%
  );
  animation: todayShimmer 6s linear infinite;
}

/* ===== Settlement arrow animation ===== */
.settlement-arrow {
  transition: transform var(--t-fast);
}
@media (hover: hover) {
  .settlement-item:hover .settlement-arrow {
    transform: translateX(3px);
  }
}

/* ===== Improved toggle button transitions ===== */
.toggle-btn {
  position: relative;
  overflow: hidden;
}
.toggle-btn::after {
  content: '';
  position: absolute; inset: 0;
  background: rgba(255,255,255,0.15);
  transform: translateX(-100%);
  transition: transform 0.3s ease;
}
.toggle-btn:hover::after {
  transform: translateX(0);
}

/* ===== Checkbox smooth check ===== */
.checkbox-grid input[type="checkbox"] {
  transition: transform 0.15s ease;
}
.checkbox-grid input[type="checkbox"]:checked {
  transform: scale(1.1);
}

/* ===== Desktop ===== */
@media (min-width: 768px) {
  .tab-nav {
    position: static;
    border-top: none;
    border-bottom: 1px solid var(--c-border);
    max-width: var(--max-w);
    margin: 0 auto;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    background: var(--c-surface-solid);
  }
  body { padding-bottom: var(--sp-xl); }
  .toast { bottom: var(--sp-xl); }
  .tab-btn.active::after { top: auto; bottom: 0; border-radius: 3px 3px 0 0; }
  .tab-btn { font-size: var(--fs-sm); }
  .tab-icon { font-size: 1.1rem; }
  .card:hover { box-shadow: var(--shadow-lg); border-color: rgba(201,168,76,0.15); }
}

/* ===== Reduced motion ===== */
/* ===== Accordion (generic toggle) ===== */
.accordion-toggle { display:flex; align-items:center; gap:var(--sp-sm); cursor:pointer; padding:var(--sp-sm) 0; font-weight:600; color:var(--c-text); user-select:none; }
.accordion-toggle .arrow { transition:transform var(--t-fast); font-size:0.7em; }
.accordion-toggle.open .arrow { transform:rotate(90deg); }
.accordion-body { display:none; }
.accordion-body.open { display:block; }

/* ===== Checklist ===== */
.checklist-section { margin-top: var(--sp-md); }
.checklist-progress-bar { height:4px; background:rgba(0,0,0,0.06); border-radius:2px; margin-bottom:var(--sp-sm); overflow:hidden; }
.checklist-progress-fill { height:100%; background:linear-gradient(90deg, var(--c-success) 0%, #34d399 100%); border-radius:2px; transition:width var(--t-smooth); }
#tab-checklist .checklist-body { display:block; }
.cl-form-open-btn { font-size:var(--fs-base); font-weight:700; padding:12px; letter-spacing:0.02em; }
.cl-add-panel { padding-top:var(--sp-md); animation:cl-slide-down 0.25s ease; }
.cl-add-panel[hidden] { display:none; }
.cl-add-btn-active { opacity:0.45; pointer-events:none; transition:opacity var(--t-fast), background var(--t-fast); }
.cl-add-btn-active.enabled { opacity:1; pointer-events:auto; background:var(--c-primary); box-shadow:0 4px 12px -2px rgba(26,35,126,0.35); }
.cl-cat-tabs { display:flex; gap:4px; margin-bottom:var(--sp-sm); flex-wrap:wrap; }
.cl-cat-tab { padding:4px 10px; border-radius:var(--radius-full); border:1px solid rgba(0,0,0,0.08); background:rgba(0,0,0,0.03); font-size:var(--fs-xs); cursor:pointer; transition:background var(--t-fast); }
.cl-cat-tab.active { background:linear-gradient(135deg, var(--c-primary) 0%, var(--c-primary-light) 100%); color:#fff; border-color:var(--c-primary); }
/* Member filter row */
.cl-member-filter { display:flex; gap:4px; margin-bottom:var(--sp-sm); flex-wrap:wrap; align-items:center; }
.cl-member-filter-btn { padding:5px 12px; border-radius:var(--radius-full); font-size:var(--fs-xs); cursor:pointer; transition:all var(--t-fast); color:#fff; font-weight:600; opacity:0.5; border:none; -webkit-tap-highlight-color:transparent; }
.cl-member-filter-btn.active { opacity:1; box-shadow:0 1px 4px rgba(0,0,0,0.15); }
/* Progress summary */
.cl-progress-summary { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:var(--sp-sm); align-items:center; }
.cl-progress-overall { font-size:var(--fs-sm); color:var(--c-text2); margin-right:auto; }
.cl-progress-member { display:inline-flex; align-items:center; gap:3px; padding:2px 8px; border-radius:var(--radius-full); font-size:var(--fs-xs); font-weight:600; color:#fff; opacity:0.75; cursor:pointer; -webkit-tap-highlight-color:transparent; }
.cl-progress-member.done { opacity:1; }
.cl-progress-member.filter-active { opacity:1; box-shadow:0 0 0 2px #fff, 0 0 0 4px currentColor; }
.cl-progress-member .cl-pm-count { font-weight:400; opacity:0.85; }
@keyframes cl-slide-down { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }
.cl-cat-select { padding:4px 8px; border:1px solid rgba(0,0,0,0.1); border-radius:var(--radius-sm); font-size:var(--fs-xs); background:rgba(255,255,255,0.8); min-height:30px; }
.cl-add-member-checks { display:flex; flex-wrap:wrap; gap:4px; }
.cl-add-member-checks label { display:inline-flex; align-items:center; gap:3px; padding:3px 8px; border-radius:var(--radius-full); font-size:var(--fs-xs); background:rgba(0,0,0,0.04); cursor:pointer; }
.cl-add-member-checks input[type=checkbox] { width:16px; height:16px; accent-color:var(--c-success); }
/* Item v2 layout (2-row: main + member dots) */
.cl-item { display:flex; flex-direction:column; gap:4px; padding:8px 4px; border-bottom:1px solid rgba(0,0,0,0.04); }
.cl-item:last-child { border-bottom:none; }
.cl-item-main { display:flex; align-items:center; gap:var(--sp-sm); }
.cl-item .cl-text { flex:1; font-size:var(--fs-sm); transition:opacity var(--t-fast), color var(--t-fast); }
.cl-item.cl-complete .cl-text { text-decoration:line-through; text-decoration-thickness:2px; text-decoration-color:var(--c-success); color:var(--c-text2); opacity:0.55; }
.cl-cat-badge { font-size:0.6rem; padding:1px 6px; border-radius:var(--radius-full); background:rgba(0,0,0,0.05); color:var(--c-text2); white-space:nowrap; flex-shrink:0; }
.cl-item .cl-del { width:24px; height:24px; border:none; background:none; color:var(--c-text2); cursor:pointer; font-size:0.8rem; opacity:0.5; flex-shrink:0; }
.cl-item .cl-del:hover { opacity:1; color:var(--c-danger); }
/* Member dot buttons */
.cl-member-checks { display:flex; gap:10px; padding:8px 4px 4px; flex-wrap:wrap; position:relative; z-index:1; }
.cl-item.cl-complete { background:rgba(0,200,83,0.04); border-radius:var(--radius-sm); }
.cl-member-dot { width:42px; height:42px; border-radius:50%; border:2.5px solid rgba(255,255,255,0.5); display:flex; align-items:center; justify-content:center; font-size:0.85rem; font-weight:800; color:#fff; cursor:pointer; transition:all 0.15s ease; opacity:0.6; position:relative; padding:0; box-shadow:0 1px 4px rgba(0,0,0,0.18); touch-action:manipulation; user-select:none; -webkit-user-select:none; -webkit-tap-highlight-color:rgba(255,255,255,0.2); z-index:2; }
.cl-member-dot * { pointer-events:none; }
.cl-member-dot.checked { opacity:1; border-color:rgba(255,255,255,0.9); box-shadow:0 2px 12px rgba(0,0,0,0.35); transform:scale(1.08); }
.cl-member-dot.checked::after { content:''; position:absolute; inset:-4px; border-radius:50%; border:2.5px solid var(--c-success); pointer-events:none; }
.cl-member-dot .cl-dot-check { display:none; font-size:1rem; pointer-events:none; }
.cl-member-dot.checked .cl-dot-check { display:block; }
.cl-member-dot.checked .cl-dot-initial { display:none; }
.cl-member-dot .cl-dot-initial { pointer-events:none; }
.cl-member-dot:active { transform:scale(0.85); opacity:0.9; }

/* ===== Share / Copy Button ===== */
.btn-share { display:inline-flex; align-items:center; gap:4px; padding:6px 14px; border-radius:var(--radius-full); background:rgba(0,0,0,0.05); border:1px solid rgba(0,0,0,0.08); font-size:var(--fs-sm); cursor:pointer; color:var(--c-text); transition:background var(--t-fast); }
.btn-share:active { background:rgba(0,0,0,0.12); }

/* ===== Dashboard (spending chart) ===== */
/* Stacked daily chart */

/* ===== Trip Banner — Hero Section ===== */
.trip-banner { position:relative; border-radius:var(--radius-lg); overflow:hidden; margin-bottom:var(--sp-md); padding:var(--sp-xl) var(--sp-lg) var(--sp-lg); background:linear-gradient(160deg, #000040 0%, #0a0f5c 30%, #1a237e 60%, #283593 100%); color:#fff; min-height:140px; display:flex; flex-direction:column; justify-content:flex-end; box-shadow:var(--shadow-lg); }
.trip-banner::after { content:''; position:absolute; inset:0; background:linear-gradient(180deg, transparent 30%, rgba(0,0,30,0.6) 100%); z-index:0; pointer-events:none; }
.trip-banner-bg { position:absolute; inset:0; background-size:cover; background-position:center; opacity:0.35; z-index:0; transition:opacity var(--t-smooth); }
.trip-banner:hover .trip-banner-bg { opacity:0.45; }
.trip-banner-content { position:relative; z-index:1; }
.trip-banner-title { font-size:1.4rem; font-weight:800; letter-spacing:0.01em; text-shadow:0 2px 8px rgba(0,0,0,0.4); }
.trip-banner-dest { font-size:var(--fs-base); font-weight:600; opacity:0.95; margin-top:4px; display:flex; align-items:center; gap:6px; }
.trip-banner-dest::before { content:'✈'; font-size:0.9em; }
.trip-banner-dates { font-size:var(--fs-sm); opacity:0.85; margin-top:var(--sp-xs); letter-spacing:0.02em; }
.trip-banner-countdown { display:inline-flex; align-items:center; gap:6px; margin-top:var(--sp-sm); padding:5px 14px; background:rgba(201,168,76,0.2); border:1px solid rgba(201,168,76,0.35); border-radius:var(--radius-full); font-size:var(--fs-sm); font-weight:700; color:var(--c-gold-light); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); }
.trip-banner-countdown .countdown-num { font-size:var(--fs-lg); font-weight:800; color:#fff; }
@keyframes bannerShimmer { 0%{background-position:-200% center;} 100%{background-position:200% center;} }
.trip-banner-title { background-size:200% auto; background-image:linear-gradient(90deg, #fff 0%, #fff 40%, var(--c-gold-light) 50%, #fff 60%, #fff 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; animation:bannerShimmer 8s linear infinite; }
/* ===== Home Tab ===== */
.home-welcome-card { text-align:center; padding:var(--sp-xl) var(--sp-lg); }
.home-welcome-icon { font-size:3rem; margin-bottom:var(--sp-sm); }
.home-welcome-title { font-size:var(--fs-xl); font-weight:800; color:var(--c-primary); margin-bottom:var(--sp-sm); }
.home-welcome-desc { font-size:var(--fs-sm); color:var(--c-text2); margin-bottom:var(--sp-md); }
.home-welcome-btn { margin:0 auto; }
.home-card { cursor:pointer; transition:box-shadow var(--t-smooth), transform var(--t-smooth); }
.home-card:active { transform:scale(0.98); box-shadow:var(--shadow-sm); }
.home-card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:var(--sp-sm); }
.home-card-title { font-size:var(--fs-lg); font-weight:800; color:var(--c-primary); display:flex; align-items:center; gap:var(--sp-sm); margin:0; }
.home-card-arrow { font-size:var(--fs-base); color:var(--c-text2); opacity:0.4; transition:transform var(--t-fast); }
.home-card:active .home-card-arrow { transform:translateX(3px); }
/* Home: Itinerary events */
.home-event { display:flex; align-items:flex-start; gap:var(--sp-sm); padding:var(--sp-sm) 0; border-bottom:1px solid var(--c-border); }
.home-event:last-child { border-bottom:none; }
.home-event-icon { flex-shrink:0; font-size:1rem; width:24px; text-align:center; }
.home-event-time { font-size:var(--fs-xs); color:var(--c-text2); font-weight:700; min-width:42px; flex-shrink:0; }
.home-event-title { font-size:var(--fs-sm); font-weight:600; color:var(--c-text); flex:1; line-height:1.35; }
.home-event.next-up { background:rgba(26,35,126,0.04); border-radius:var(--radius-xs); padding:var(--sp-sm); margin:2px calc(-1 * var(--sp-sm)); }
.home-next-badge { display:inline-block; font-size:0.55rem; font-weight:700; color:#fff; background:linear-gradient(135deg, var(--c-primary), var(--c-gold)); padding:1px 6px; border-radius:var(--radius-full); margin-left:6px; vertical-align:middle; letter-spacing:0.04em; }
.home-event-empty { text-align:center; color:var(--c-text2); font-size:var(--fs-sm); padding:var(--sp-md) 0; }
.home-more-link { text-align:center; font-size:var(--fs-xs); color:var(--c-primary); padding:var(--sp-sm) 0 0; font-weight:600; }
/* Home: Checklist progress */
.home-cl-progress { margin-bottom:var(--sp-sm); }
.home-cl-bar-track { height:8px; background:rgba(0,0,0,0.06); border-radius:4px; overflow:hidden; margin-bottom:var(--sp-sm); }
.home-cl-bar-fill { height:100%; background:linear-gradient(90deg, var(--c-success) 0%, #69f0ae 100%); border-radius:4px; transition:width var(--t-smooth); }
.home-cl-stats { display:flex; align-items:center; gap:var(--sp-sm); font-size:var(--fs-sm); color:var(--c-text2); }
.home-cl-pct { font-size:var(--fs-xl); font-weight:800; color:var(--c-primary); }
.home-cl-members { display:flex; flex-wrap:wrap; gap:6px; margin-top:var(--sp-sm); }
.home-cl-member-badge { display:inline-flex; align-items:center; gap:3px; padding:3px 10px; border-radius:var(--radius-full); font-size:var(--fs-xs); font-weight:600; color:#fff; }
.home-cl-member-badge.done { opacity:1; }
.home-cl-member-badge:not(.done) { opacity:0.65; }
/* Home: Money summary */
.home-money-grid { display:grid; grid-template-columns:1fr 1fr; gap:var(--sp-sm); margin-bottom:var(--sp-md); }
.home-money-stat { text-align:center; padding:var(--sp-sm); background:rgba(0,0,0,0.02); border-radius:var(--radius-xs); border:1px solid rgba(0,0,0,0.04); }
.home-money-val { font-size:var(--fs-lg); font-weight:800; color:var(--c-primary); letter-spacing:-0.02em; }
.home-money-label { font-size:var(--fs-xs); color:var(--c-text2); margin-top:2px; }
.home-money-bars { display:flex; flex-direction:column; gap:4px; }
.home-money-bar-row { display:flex; align-items:center; gap:6px; font-size:var(--fs-xs); }
.home-money-bar-name { width:50px; text-align:right; flex-shrink:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.home-money-bar-track { flex:1; height:12px; background:rgba(0,0,0,0.04); border-radius:6px; overflow:hidden; min-width:30px; }
.home-money-bar-fill { height:100%; border-radius:6px; transition:width var(--t-smooth); }
.home-money-bar-val { width:60px; flex-shrink:0; text-align:right; color:var(--c-text2); }

/* ===== Map Auto Link ===== */
.itin-link-auto { background:rgba(0,139,183,0.08); color:var(--c-accent); border:1px dashed rgba(0,139,183,0.3); }
.itin-link-auto:hover { background:rgba(0,139,183,0.14); }
/* ===== Input with Action ===== */
.input-with-action { display:flex; gap:var(--sp-xs); align-items:center; }
.input-with-action .form-input { flex:1; min-width:0; }
/* ===== Weather ===== */
.weather-badge { display:inline-flex; align-items:center; gap:3px; font-size:var(--fs-xs); padding:2px 8px; border-radius:var(--radius-full); background:rgba(255,255,255,0.6); margin-left:var(--sp-sm); vertical-align:middle; }
.weather-badge .w-temp { font-weight:600; }

/* ===== Templates ===== */
.tpl-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:var(--sp-sm); margin-bottom:var(--sp-md); }
.tpl-card { padding:var(--sp-sm) var(--sp-md); background:rgba(0,0,0,0.02); border:1.5px solid rgba(0,0,0,0.06); border-radius:var(--radius-sm); cursor:pointer; transition:border-color var(--t-fast), background var(--t-fast); text-align:center; }
.tpl-card:active, .tpl-card:hover { border-color:var(--c-primary); background:rgba(26,35,126,0.06); }
.tpl-card .tpl-icon { font-size:1.4rem; }
.tpl-card .tpl-name { font-size:var(--fs-xs); margin-top:2px; color:var(--c-text); }

/* ===== Premium gold accent on active filter ===== */
.filter-btn.active { border-color: var(--c-primary); background: rgba(26,35,126,0.06); }
.filter-btn.active::after { content:''; display:block; width:100%; height:2px; background:linear-gradient(90deg, var(--c-primary), var(--c-gold)); border-radius:1px; margin-top:2px; }

/* ===== Scroll progress indicator ===== */
@keyframes goldPulse { 0%,100%{opacity:0.6;} 50%{opacity:1;} }

/* ===== Card title color (ensure emoji not clipped) ===== */
.card-title { color: var(--c-primary-dark); }

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
</style>
</head>
<body>

<!-- ===== Header ===== -->
<header class="app-header">
  <h1 class="app-title">旅のしおり</h1>
  <div class="header-actions">
    <button id="btn-sync" class="icon-btn" title="クラウドから取得" style="position:relative;">
      &#x1F504;
      <span id="sync-status" class="sync-dot" title="同期状態"></span>
    </button>
    <button id="btn-cloud-upload" class="icon-btn" title="クラウドに保存">&#x2601;</button>
    <button id="btn-cloud-settings" class="icon-btn" title="設定">&#x2699;</button>
  </div>
</header>

<!-- ===== Tab Navigation ===== -->
<nav class="tab-nav" role="tablist">
  <button class="tab-btn active" data-tab="home" role="tab">
    <span class="tab-icon">&#x1F3E0;</span>
    <span class="tab-label">ホーム</span>
  </button>
  <button class="tab-btn" data-tab="itinerary" role="tab">
    <span class="tab-icon">&#x1F5FA;</span>
    <span class="tab-label">旅程</span>
  </button>
  <button class="tab-btn" data-tab="checklist" role="tab">
    <span class="tab-icon">&#x1F9F3;</span>
    <span class="tab-label">持ち物</span>
  </button>
  <button class="tab-btn" data-tab="money" role="tab">
    <span class="tab-icon">&#x1F4B0;</span>
    <span class="tab-label">お金</span>
  </button>
  <button class="tab-btn" data-tab="settings" role="tab">
    <span class="tab-icon">&#x2699;</span>
    <span class="tab-label">設定</span>
  </button>
</nav>

<!-- ===== Tab: ホーム（ダッシュボード） ===== -->
<section id="tab-home" class="tab-content active">
  <div id="home-banner"></div>
  <div id="home-welcome" class="card home-welcome-card" hidden>
    <div class="home-welcome-icon">&#x2708;&#xFE0F;</div>
    <h2 class="home-welcome-title">旅のしおりへようこそ</h2>
    <p class="home-welcome-desc">設定タブで旅行情報を登録して始めましょう</p>
    <button class="btn btn-primary home-welcome-btn" data-home-goto="settings">&#x2699; 設定を開く</button>
  </div>
  <div id="home-itinerary-card" class="card home-card" hidden data-home-goto="itinerary">
    <div class="home-card-header">
      <h3 class="home-card-title">&#x1F5FA; 今日の予定</h3>
      <span class="home-card-arrow">&#x276F;</span>
    </div>
    <div id="home-itinerary-body"></div>
  </div>
  <div id="home-checklist-card" class="card home-card" hidden data-home-goto="checklist">
    <div class="home-card-header">
      <h3 class="home-card-title">&#x1F9F3; 持ち物チェック</h3>
      <span class="home-card-arrow">&#x276F;</span>
    </div>
    <div id="home-checklist-body"></div>
  </div>
  <div id="home-money-card" class="card home-card" hidden data-home-goto="money">
    <div class="home-card-header">
      <h3 class="home-card-title">&#x1F4B0; 支出サマリー</h3>
      <span class="home-card-arrow">&#x276F;</span>
    </div>
    <div id="home-money-body"></div>
  </div>
</section>

<!-- ===== Tab: 旅程（スケジュール閲覧＋編集） ===== -->
<section id="tab-itinerary" class="tab-content">
  <div id="trip-banner" class="trip-banner" hidden></div>
  <!-- 予定の追加・編集（アコーディオン） -->
  <div class="card">
    <div id="itin-edit-toggle" class="accordion-toggle">
      <span class="arrow">▶</span>
      ✏️ 予定を追加・編集
      <span style="font-weight:400;font-size:var(--fs-sm);color:var(--c-text2);margin-left:auto;">(<span id="itin-count">0</span>件)</span>
    </div>
    <div id="itin-edit-body" class="accordion-body">
      <!-- テンプレート -->
      <div style="margin-top:var(--sp-md);">
        <p style="font-size:var(--fs-sm);font-weight:600;margin-bottom:var(--sp-sm);">📝 テンプレートから追加</p>
        <div class="tpl-grid" id="template-grid"></div>
      </div>
      <!-- 追加/編集フォーム -->
      <div style="margin-top:var(--sp-md);">
        <p style="font-size:var(--fs-sm);font-weight:600;margin-bottom:var(--sp-sm);" id="itin-form-title">予定を追加</p>
        <form id="form-itinerary">
          <input type="hidden" id="itin-edit-id" value="">
          <div class="form-row">
            <div class="form-group flex-grow">
              <label for="itin-date">日付</label>
              <input type="date" id="itin-date" class="form-input" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group flex-grow">
              <label for="itin-time">開始時刻</label>
              <input type="time" id="itin-time" class="form-input">
            </div>
            <div class="form-group flex-grow">
              <label for="itin-endtime">終了時刻</label>
              <input type="time" id="itin-endtime" class="form-input">
            </div>
          </div>
          <div class="form-group">
            <label for="itin-title">タイトル</label>
            <input type="text" id="itin-title" class="form-input" required placeholder="例: 成田→シドニー JQ12" maxlength="100" autocomplete="off">
          </div>
          <div class="form-group">
            <label for="itin-category">カテゴリ</label>
            <select id="itin-category" class="form-input">
              <option value="flight">✈️ 飛行機</option>
              <option value="hotel">🏨 宿泊</option>
              <option value="sightseeing">🗺️ 観光</option>
              <option value="food">🍽️ 食事</option>
              <option value="transport">🚃 交通</option>
              <option value="other">📌 その他</option>
            </select>
          </div>
          <div class="form-group">
            <label>参加メンバー</label>
            <div class="split-controls">
              <button type="button" id="btn-itin-select-all" class="btn-sm">全選択</button>
              <button type="button" id="btn-itin-deselect-all" class="btn-sm">全解除</button>
            </div>
            <div id="itin-participants" class="checkbox-grid"></div>
          </div>
          <div class="form-group">
            <label for="itin-memo">メモ</label>
            <textarea id="itin-memo" class="form-input" placeholder="詳細メモ（任意）" maxlength="500" rows="2"></textarea>
          </div>
          <div class="form-group">
            <label for="itin-url">リンクURL</label>
            <input type="url" id="itin-url" class="form-input" placeholder="Googleドライブ等のURL（任意）" autocomplete="off">
          </div>
          <div class="form-group">
            <label for="itin-location">場所名</label>
            <div class="input-with-action">
              <input type="text" id="itin-location" class="form-input" placeholder="例: シドニー・オペラハウス（任意）" maxlength="100" autocomplete="off">
              <button type="button" id="btn-map-preview" class="btn-icon-sm" title="地図で確認">🗺️</button>
            </div>
          </div>
          <div class="form-group">
            <label for="itin-mapurl">Google Maps URL</label>
            <input type="url" id="itin-mapurl" class="form-input" placeholder="Google Mapsの共有URL（任意）" autocomplete="off">
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-block" id="itin-submit-btn">追加する</button>
            <button type="button" id="btn-cancel-itin-edit" class="btn btn-secondary btn-block" style="display:none;">キャンセル</button>
          </div>
        </form>
      </div>
      <!-- 予定一覧（編集用） -->
      <div style="margin-top:var(--sp-md);">
        <p style="font-size:var(--fs-sm);font-weight:600;margin-bottom:var(--sp-sm);">予定一覧</p>
        <div id="itin-edit-list"></div>
        <p id="itin-edit-empty" class="empty-msg">予定がありません</p>
      </div>
    </div>
  </div>
  <!-- スケジュール表示 -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--sp-sm);">
      <h2 class="card-title" style="margin-bottom:0;">📋 スケジュール</h2>
      <button id="btn-share-schedule" class="btn-share" title="今日の予定をコピー">📤 共有</button>
    </div>
    <div id="itin-filter" class="itin-filter"></div>
    <div id="itinerary-list"></div>
    <p id="itinerary-empty" class="empty-msg">予定がありません<br><small style="color:var(--c-text2)">上の「✏️ 予定を追加・編集」を開いて追加してください</small></p>
  </div>
</section>

<!-- ===== Tab: 持ち物（チェックリスト） ===== -->
<section id="tab-checklist" class="tab-content">
  <!-- 持ち物を追加 -->
  <div class="card">
    <button id="cl-form-open-btn" class="btn btn-primary btn-block cl-form-open-btn">＋ 持ち物を追加する</button>
    <div id="cl-add-panel" class="cl-add-panel" hidden>
      <div class="form-group">
        <label for="cl-new-item">アイテム名</label>
        <input type="text" id="cl-new-item" class="form-input" placeholder="例: パスポート、充電器..." maxlength="50" autocomplete="off">
      </div>
      <div class="form-group">
        <label for="cl-cat-select">カテゴリ</label>
        <select id="cl-cat-select" class="form-input cl-cat-select">
          <option value="essential">必需品</option>
          <option value="clothes">衣類</option>
          <option value="electronics">電子機器</option>
          <option value="toiletry">日用品</option>
          <option value="medicine">医薬品</option>
          <option value="food">食品</option>
          <option value="other" selected>その他</option>
        </select>
      </div>
      <div class="form-group">
        <label>対象メンバー</label>
        <div id="cl-add-member-checks" class="cl-add-member-checks"></div>
      </div>
      <div class="form-actions" style="gap:var(--sp-sm);">
        <button id="cl-add-btn" class="btn btn-primary btn-block cl-add-btn-active" disabled>追加する</button>
        <button id="cl-form-cancel-btn" type="button" class="btn btn-secondary btn-block">閉じる</button>
      </div>
    </div>
  </div>
  <!-- チェックリスト一覧（アコーディオン） -->
  <div class="card">
    <div id="cl-list-toggle" class="accordion-toggle open">
      <span class="arrow">▶</span>
      🧳 チェックリスト
      <span style="font-weight:400;font-size:var(--fs-sm);color:var(--c-text2);margin-left:auto;" id="cl-list-count"></span>
    </div>
    <div id="cl-list-body" class="accordion-body open">
      <div class="checklist-progress-bar"><div id="checklist-progress-fill" class="checklist-progress-fill" style="width:0%"></div></div>
      <div id="cl-progress-summary" class="cl-progress-summary"></div>
      <div id="checklist-body" class="checklist-body">
        <!-- メンバーフィルタ -->
        <div id="cl-member-filter" class="cl-member-filter"></div>
        <!-- カテゴリフィルタ -->
        <div class="cl-cat-tabs" id="cl-cat-tabs">
          <span class="cl-cat-tab active" data-cl-cat="all">すべて</span>
          <span class="cl-cat-tab" data-cl-cat="essential">必需品</span>
          <span class="cl-cat-tab" data-cl-cat="clothes">衣類</span>
          <span class="cl-cat-tab" data-cl-cat="electronics">電子機器</span>
          <span class="cl-cat-tab" data-cl-cat="toiletry">日用品</span>
          <span class="cl-cat-tab" data-cl-cat="medicine">医薬品</span>
          <span class="cl-cat-tab" data-cl-cat="food">食品</span>
          <span class="cl-cat-tab" data-cl-cat="other">その他</span>
        </div>
        <div id="checklist-list"></div>
      </div>
    </div>
  </div>
</section>

<!-- ===== Tab: お金（支払い＋精算） ===== -->
<section id="tab-money" class="tab-content">
  <!-- 支払いフォーム -->
  <div class="card">
    <h2 class="card-title" id="expense-form-title">支払いを追加</h2>
    <form id="form-expense">
      <input type="hidden" id="expense-edit-id" value="">
      <div class="form-group">
        <label for="expense-date">日付</label>
        <input type="date" id="expense-date" class="form-input" required>
      </div>
      <div class="form-group">
        <label for="expense-payer">支払った人</label>
        <select id="expense-payer" class="form-input" required>
          <option value="">選択してください</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group flex-grow">
          <label for="expense-amount">金額</label>
          <input type="number" id="expense-amount" class="form-input" min="0" step="any" required placeholder="0" inputmode="decimal">
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <div class="currency-toggle" id="currency-toggle">
            <button type="button" class="toggle-btn active-jpy" data-currency="JPY">JPY</button>
            <button type="button" class="toggle-btn" data-currency="AUD">AUD</button>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="expense-memo">メモ</label>
        <input type="text" id="expense-memo" class="form-input" placeholder="何に使った？" maxlength="100" autocomplete="off">
      </div>
      <div class="form-group">
        <label>割り勘メンバー</label>
        <div class="split-controls">
          <button type="button" id="btn-select-all" class="btn-sm">全選択</button>
          <button type="button" id="btn-deselect-all" class="btn-sm">全解除</button>
        </div>
        <div id="split-members" class="checkbox-grid"></div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary btn-block" id="expense-submit-btn">追加する</button>
        <button type="button" id="btn-cancel-edit" class="btn btn-secondary btn-block" style="display:none;">キャンセル</button>
      </div>
    </form>
  </div>
  <!-- 支払い一覧（アコーディオン） -->
  <div class="card">
    <div id="money-list-toggle" class="accordion-toggle open">
      <span class="arrow">▶</span>
      📋 支払い一覧
      <span style="font-weight:400;font-size:var(--fs-sm);color:var(--c-text2);margin-left:auto;" id="money-list-count"></span>
    </div>
    <div id="money-list-body" class="accordion-body open">
      <div id="expense-summary" class="summary-bar"></div>
      <div id="expense-list"></div>
      <p id="expense-empty" class="empty-msg">支払い記録がありません</p>
    </div>
  </div>
  <!-- 精算（アコーディオン：個人収支＋精算プラン統合） -->
  <div class="card">
    <div id="money-settle-toggle" class="accordion-toggle">
      <span class="arrow">▶</span>
      🔄 精算
    </div>
    <div id="money-settle-body" class="accordion-body">
      <div style="margin-top:var(--sp-sm);">
        <p style="font-size:var(--fs-sm);font-weight:600;margin-bottom:var(--sp-sm);">個人収支</p>
        <div id="balance-list"></div>
        <p id="balance-empty" class="empty-msg">データがありません</p>
      </div>
      <div style="margin-top:var(--sp-md);padding-top:var(--sp-md);border-top:1px solid rgba(0,0,0,0.06);">
        <p style="font-size:var(--fs-sm);font-weight:600;margin-bottom:var(--sp-sm);">精算プラン</p>
        <p class="card-desc" style="margin-bottom:var(--sp-sm);">最小限の送金回数で精算します</p>
        <div id="settlement-plan"></div>
        <p id="settlement-empty" class="empty-msg">精算するデータがありません</p>
      </div>
    </div>
  </div>
</section>

<!-- ===== Tab: 設定 ===== -->
<section id="tab-settings" class="tab-content">
  <!-- 旅行基本情報 -->
  <div class="card">
    <h2 class="card-title">🌍 旅行基本情報</h2>
    <form id="form-trip-info">
      <div class="form-group">
        <label for="trip-title">旅行タイトル</label>
        <input type="text" id="trip-title" class="form-input" placeholder="例: オーストラリア旅行 2025" maxlength="100" autocomplete="off">
      </div>
      <div class="form-group">
        <label for="trip-destination">行き先</label>
        <input type="text" id="trip-destination" class="form-input" placeholder="例: シドニー, オーストラリア" maxlength="100" autocomplete="off">
      </div>
      <div class="form-row">
        <div class="form-group flex-grow">
          <label for="trip-start-date">出発日</label>
          <input type="date" id="trip-start-date" class="form-input">
        </div>
        <div class="form-group flex-grow">
          <label for="trip-end-date">帰国日</label>
          <input type="date" id="trip-end-date" class="form-input">
        </div>
      </div>
      <div class="form-group">
        <label for="trip-image-url">カバー画像URL（任意）</label>
        <input type="url" id="trip-image-url" class="form-input" placeholder="https://example.com/cover.jpg" autocomplete="off">
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary btn-block">保存する</button>
      </div>
    </form>
  </div>
  <!-- 通貨・為替設定 -->
  <div class="card">
    <h2 class="card-title">💱 通貨・為替設定</h2>
    <div class="form-group">
      <label>為替レート</label>
      <div class="exchange-rate-form">
        <span>1 AUD =</span>
        <input type="number" id="exchange-rate" class="form-input" min="0.01" step="0.01" value="95" inputmode="decimal">
        <span>円</span>
      </div>
      <div id="rate-status" class="rate-status"></div>
    </div>
    <div class="form-group" style="margin-top:var(--sp-md);">
      <label>精算通貨</label>
      <div class="currency-toggle" id="settle-currency-toggle">
        <button type="button" class="toggle-btn active-jpy" data-settle="JPY">JPY で精算</button>
        <button type="button" class="toggle-btn" data-settle="AUD">AUD で精算</button>
      </div>
    </div>
  </div>
  <!-- メンバー管理 -->
  <div class="card">
    <h2 class="card-title">👥 メンバー管理</h2>
    <form id="form-add-member" class="inline-form" style="margin-bottom:var(--sp-md);">
      <input type="text" id="input-member-name" placeholder="名前を入力" class="form-input" required maxlength="20" autocomplete="off">
      <button type="submit" class="btn btn-primary">追加</button>
    </form>
    <h3 style="font-size:var(--fs-sm);font-weight:600;color:var(--c-text2);margin-bottom:var(--sp-sm);">メンバー一覧 <span style="font-weight:400">(<span id="member-count">0</span>人)</span></h3>
    <ul id="member-list" class="item-list"></ul>
    <p id="member-empty" class="empty-msg">メンバーがいません</p>
  </div>
  <div class="card">
    <h2 class="card-title">☁️ クラウド同期</h2>
    <p style="font-size:0.75rem;color:var(--c-text2);margin-bottom:12px;line-height:1.4;">スプレッドシートと同期中。🔄で取得、☁で保存できます。</p>
    <div id="spreadsheet-link-area" style="margin-bottom:8px;">
      <a id="spreadsheet-link" href="#" target="_blank" rel="noopener" class="btn btn-secondary" style="width:100%;font-size:var(--fs-sm);text-decoration:none;text-align:center;display:none;">📊 スプレッドシートを開く</a>
    </div>
  </div>
  <div class="card">
    <h2 class="card-title">📁 データ管理</h2>
    <div style="display:flex;gap:8px;">
      <button id="btn-export" class="btn btn-secondary" style="flex:1;font-size:var(--fs-sm);">📤 書き出し</button>
      <button id="btn-import" class="btn btn-secondary" style="flex:1;font-size:var(--fs-sm);">📥 読み込み</button>
    </div>
    <input type="file" id="import-file" accept=".json" hidden>
  </div>
</section>

<!-- ===== Modal ===== -->
<div id="modal-overlay" class="modal-overlay" hidden>
  <div class="modal" role="dialog" aria-modal="true">
    <p id="modal-message" class="modal-message"></p>
    <div class="modal-actions">
      <button id="modal-cancel" class="btn btn-secondary">キャンセル</button>
      <button id="modal-confirm" class="btn btn-danger">削除する</button>
    </div>
  </div>
</div>

<!-- ===== GAS URL Settings Modal (開発者向け) ===== -->
<div id="cloud-modal-overlay" class="modal-overlay" hidden>
  <div class="modal" role="dialog" aria-modal="true" style="max-width:400px;">
    <p class="modal-message" style="font-weight:700;margin-bottom:12px;">GAS URL設定</p>
    <div class="form-group" style="margin-bottom:8px;">
      <input type="url" id="gas-url-input" class="form-input" placeholder="https://script.google.com/macros/s/..." autocomplete="off" style="font-size:0.75rem;">
    </div>
    <div style="display:flex;gap:6px;margin-bottom:16px;">
      <button id="cloud-modal-save" class="btn btn-primary" style="flex:1;font-size:var(--fs-sm);">URL保存</button>
      <button id="cloud-modal-clear" class="btn btn-danger" style="font-size:0.75rem;padding:6px 10px;">削除</button>
    </div>
    <div class="modal-actions">
      <button id="cloud-modal-cancel" class="btn btn-secondary" style="width:100%;">閉じる</button>
    </div>
  </div>
</div>

<!-- ===== Toast ===== -->
<div id="toast" class="toast" hidden></div>

<script>
/* ===== Constants ===== */
const APP_KEY = 'travel-expense-splitter-v1';

const CATEGORY_ICONS = {
  flight: '✈️', hotel: '🏨', sightseeing: '🗺️',
  food: '🍽️', transport: '🚃', other: '📌'
};
const CATEGORY_LABELS = {
  flight: '飛行機', hotel: '宿泊', sightseeing: '観光',
  food: '食事', transport: '交通', other: 'その他'
};
const DAY_NAMES = ['日','月','火','水','木','金','土'];
const MEMBER_COLORS = ['#4466ce','#e05688','#16a34a','#e97c1f','#8b5cf6','#0891b2','#dc2626','#6d28d9'];

/* ===== State ===== */
let state = createDefaultState();
let modalCallback = null;
let currentCurrency = 'JPY';

function createDefaultState() {
  return {
    members: [],
    expenses: [],
    itinerary: [],
    checklist: [],
    exchangeRate: 95,
    settleCurrency: 'JPY',
    nextMemberId: 1,
    nextExpenseId: 1,
    nextItineraryId: 1,
    nextChecklistId: 1,
    tripTitle: '',
    tripDestination: '',
    tripStartDate: '',
    tripEndDate: '',
    tripImageUrl: '',
    weatherLat: '',
    weatherLon: ''
  };
}

/* ===== Persistence ===== */
function loadState() {
  try {
    const raw = localStorage.getItem(APP_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      if (parsed && Array.isArray(parsed.members) && Array.isArray(parsed.expenses)) {
        state = parsed;
        if (!Array.isArray(state.itinerary)) state.itinerary = [];
        if (!Array.isArray(state.checklist)) state.checklist = [];
        if (!state.nextItineraryId) state.nextItineraryId = 1;
        const maxClIdLocal = state.checklist.length > 0 ? Math.max(...state.checklist.map(i => Number(i.id) || 0)) : 0;
        if (!state.nextChecklistId || state.nextChecklistId <= maxClIdLocal) state.nextChecklistId = maxClIdLocal + 1;
        // ID型を数値に統一
        state.members.forEach(m => { m.id = Number(m.id) || m.id; });
        state.checklist.forEach(item => {
          if (Array.isArray(item.members)) {
            // Fix NaN members: replace with actual member IDs
            const hasNaN = item.members.some(mid => mid !== mid); // NaN !== NaN is true
            if (hasNaN) {
              item.members = state.members.map(m => m.id);
              // Rebuild checkedBy with correct keys
              const newCB = {};
              item.members.forEach(mid => { newCB[String(mid)] = false; });
              item.checkedBy = newCB;
            } else {
              item.members = item.members.map(mid => Number(mid) || mid);
            }
          }
        });
        state.expenses.forEach(e => {
          e.payerId = Number(e.payerId) || e.payerId;
          if (Array.isArray(e.splitWith)) e.splitWith = e.splitWith.map(id => Number(id) || id);
        });
        state.itinerary.forEach(e => {
          if (Array.isArray(e.participants)) e.participants = e.participants.map(id => Number(id) || id);
        });
        // Ensure all members have a color
        state.members.forEach((m, i) => {
          if (!m.color) m.color = MEMBER_COLORS[i % MEMBER_COLORS.length];
        });
        // Migrate old checklist format to per-member format
        migrateChecklistItems();
      }
    }
  } catch (e) { /* keep default */ }
}

let cloudSyncReady = false; // syncFromCloud完了まではsyncToCloudを抑制
function saveState() {
  localStorage.setItem(APP_KEY, JSON.stringify(state));
  // クラウド初回読み込み完了後は自動アップロード（1.5秒デバウンス）
  if (cloudSyncReady) debouncedSyncToCloud();
}

/* ===== Cloud Sync (GAS) ===== */
const GAS_URL_KEY = 'travel-app-gas-url';
const DEFAULT_GAS_URL = 'https://script.google.com/macros/s/AKfycbwWpVNnc-BoLD5e5OA6b43hFvp2YL6579aOfIw34pIznhkQRBNl2_OAz2LInwDsR6pc/exec';
const DEFAULT_SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/1p3axqRtW8ePEyhFHh0KSIcCfn9Zil-9krnvXBAZt0do/edit';
let syncTimer = null;

function getGasUrl() {
  return localStorage.getItem(GAS_URL_KEY) || DEFAULT_GAS_URL;
}

function setGasUrl(url) {
  if (url) localStorage.setItem(GAS_URL_KEY, url);
  else localStorage.removeItem(GAS_URL_KEY);
}

function setSyncStatus(status) {
  const el = document.getElementById('sync-status');
  if (!el) return;
  el.className = 'sync-dot ' + status;
  const titles = { off: '未設定', syncing: '同期中...', synced: '同期済', error: '同期エラー' };
  el.title = titles[status] || '';
  // Sync button spin animation
  const btn = document.getElementById('btn-sync');
  if (btn) {
    if (status === 'syncing') btn.classList.add('syncing');
    else btn.classList.remove('syncing');
  }
}

function debouncedSyncToCloud() {
  if (!getGasUrl()) return;
  clearTimeout(syncTimer);
  syncTimer = setTimeout(() => syncToCloud(), 1500);
}

async function syncToCloud() {
  const url = getGasUrl();
  if (!url) return;
  setSyncStatus('syncing');
  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(state),
      signal: AbortSignal.timeout(15000)
    });
    const result = await res.json();
    if (result.success) {
      setSyncStatus('synced');
    } else {
      setSyncStatus('error');
      console.error('Sync save error:', result.error);
    }
  } catch (e) {
    setSyncStatus('error');
    console.error('Sync save failed:', e);
  }
}

async function syncFromCloud() {
  const url = getGasUrl();
  if (!url) { setSyncStatus('off'); return; }
  setSyncStatus('syncing');
  try {
    const res = await fetch(url + '?action=load', { signal: AbortSignal.timeout(15000) });
    const result = await res.json();
    if (result.success && result.data) {
      const cloud = result.data;
      // Save spreadsheet URL if provided
      if (cloud.spreadsheetUrl) {
        localStorage.setItem('travel-app-spreadsheet-url', cloud.spreadsheetUrl);
        updateSpreadsheetLink();
      }
      // === クラウドを正とする: クラウドにデータがあれば常にローカルを上書き ===
      // Workaround: GASのヘッダーずれでparticipants列が空文字キー""に格納される問題への対策
      if (Array.isArray(cloud.itinerary)) {
        cloud.itinerary.forEach(e => {
          if ((!e.participants || e.participants.length === 0) && e[''] && typeof e[''] === 'string') {
            try { e.participants = JSON.parse(e['']); } catch(ex) {}
            delete e[''];
          }
          if (typeof e.participants === 'string' && e.participants) {
            try { e.participants = JSON.parse(e.participants); } catch(ex) { e.participants = []; }
          }
          if (!Array.isArray(e.participants)) e.participants = [];
        });
      }
      // 同様にexpensesのsplitWithも修復
      if (Array.isArray(cloud.expenses)) {
        cloud.expenses.forEach(e => {
          if ((!e.splitWith || e.splitWith.length === 0) && e[''] && typeof e[''] === 'string') {
            try { e.splitWith = JSON.parse(e['']); } catch(ex) {}
            delete e[''];
          }
          if (typeof e.splitWith === 'string' && e.splitWith) {
            try { e.splitWith = JSON.parse(e.splitWith); } catch(ex) { e.splitWith = []; }
          }
          if (!Array.isArray(e.splitWith)) e.splitWith = [];
        });
      }
      // checklistも修復 (new per-member format: members[], checkedBy{})
      if (Array.isArray(cloud.checklist)) {
        cloud.checklist.forEach(e => {
          // Parse members if JSON string from GAS
          if (typeof e.members === 'string') {
            try { e.members = JSON.parse(e.members); } catch(ex) { e.members = []; }
          }
          if (!Array.isArray(e.members)) e.members = [];
          // Parse checkedBy if JSON string from GAS
          if (typeof e.checkedBy === 'string') {
            try { e.checkedBy = JSON.parse(e.checkedBy); } catch(ex) { e.checkedBy = {}; }
          }
          if (!e.checkedBy || typeof e.checkedBy !== 'object' || Array.isArray(e.checkedBy)) e.checkedBy = {};
          // Legacy: old boolean checked field → will be handled by migrateChecklistItems()
          if (typeof e.checked === 'string') e.checked = e.checked === 'true' || e.checked === 'TRUE';
        });
      }

      // クラウドのデータでstateを完全上書き
      state = cloud;
      if (!Array.isArray(state.members)) state.members = [];
      if (!Array.isArray(state.expenses)) state.expenses = [];
      if (!Array.isArray(state.itinerary)) state.itinerary = [];
      if (!Array.isArray(state.checklist)) state.checklist = [];
      // members.id を数値に統一（GASからは文字列で来る場合がある）
      state.members.forEach(m => { m.id = Number(m.id) || m.id; });
      // checklist.members[] / checkedBy のキーも数値に統一 + NaN修正
      state.checklist.forEach(item => {
        if (Array.isArray(item.members)) {
          const hasNaN = item.members.some(mid => mid !== mid);
          if (hasNaN) {
            item.members = state.members.map(m => m.id);
            const newCB = {};
            item.members.forEach(mid => { newCB[String(mid)] = false; });
            item.checkedBy = newCB;
          } else {
            item.members = item.members.map(mid => Number(mid) || mid);
          }
        }
      });
      // expenses.payerId / splitWith も数値に統一
      state.expenses.forEach(e => {
        e.payerId = Number(e.payerId) || e.payerId;
        if (Array.isArray(e.splitWith)) e.splitWith = e.splitWith.map(id => Number(id) || id);
      });
      // itinerary.participants も数値に統一
      state.itinerary.forEach(e => {
        if (Array.isArray(e.participants)) e.participants = e.participants.map(id => Number(id) || id);
      });
      // nextChecklistId: GASから正しく返らない場合、既存データから算出
      const maxClId = state.checklist.length > 0 ? Math.max(...state.checklist.map(i => Number(i.id) || 0)) : 0;
      if (!state.nextChecklistId || state.nextChecklistId <= maxClId) state.nextChecklistId = maxClId + 1;
      // Ensure all members have a color
      state.members.forEach((m, i) => {
        if (!m.color) m.color = MEMBER_COLORS[i % MEMBER_COLORS.length];
      });
      console.log('[sync] checklist items:', state.checklist.length, 'members:', state.members.length);
      // Trip info defaults
      if (!state.tripTitle) state.tripTitle = '';
      if (!state.tripDestination) state.tripDestination = '';
      if (!state.tripStartDate) state.tripStartDate = '';
      if (!state.tripEndDate) state.tripEndDate = '';
      if (!state.tripImageUrl) state.tripImageUrl = '';
      if (!state.weatherLat) state.weatherLat = '';
      if (!state.weatherLon) state.weatherLon = '';
      // Sync weather coords to localStorage for backward compat
      if (state.weatherLat && state.weatherLon) {
        localStorage.setItem('travel-app-weather-lat', state.weatherLat);
        localStorage.setItem('travel-app-weather-lon', state.weatherLon);
      }
      // Migrate old checklist format to per-member format
      migrateChecklistItems();
      localStorage.setItem(APP_KEY, JSON.stringify(state));
      renderAll();
      setSyncStatus('synced');
      console.log('[sync] クラウドからデータ取得完了 (クラウド=正)');
    } else {
      setSyncStatus('error');
    }
  } catch (e) {
    setSyncStatus('error');
    console.error('Sync load failed:', e);
  }
  cloudSyncReady = true;
}

/* ===== Utilities ===== */
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function getTodayString() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const [y, m, d] = dateStr.split('-');
  return `${Number(m)}/${Number(d)}`;
}

function formatDateFull(dateStr) {
  if (!dateStr) return '';
  const [y, m, d] = dateStr.split('-');
  const date = new Date(Number(y), Number(m) - 1, Number(d));
  return `${Number(m)}/${Number(d)}(${DAY_NAMES[date.getDay()]})`;
}

function getMemberName(id) {
  const m = state.members.find(m => m.id === id);
  return m ? m.name : '不明';
}

function roundForCurrency(amount, currency) {
  if (currency === 'JPY') return Math.round(amount);
  return Math.round(amount * 100) / 100;
}

function formatAmount(amount, currency) {
  if (currency === 'JPY') return '¥' + Math.round(amount).toLocaleString('ja-JP');
  return 'A$' + amount.toFixed(2);
}

function generateMemberId() { return 'm' + (state.nextMemberId++); }
function generateExpenseId() { return state.nextExpenseId++; }
function generateItineraryId() { return state.nextItineraryId++; }

/* ===== Toast ===== */
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.hidden = false;
  requestAnimationFrame(() => { toast.classList.add('show'); });
  clearTimeout(toast._timer);
  toast._timer = setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => { toast.hidden = true; }, 300);
  }, 2200);
}

/* ===== Modal ===== */
function showModal(message, confirmLabel, onConfirm) {
  document.getElementById('modal-message').textContent = message;
  document.getElementById('modal-confirm').textContent = confirmLabel || '削除する';
  document.getElementById('modal-overlay').hidden = false;
  modalCallback = onConfirm;
}

function closeModal() {
  document.getElementById('modal-overlay').hidden = true;
  modalCallback = null;
}

/* ===== Member Management ===== */
function addMember(name) {
  const trimmed = name.trim();
  if (!trimmed) { showToast('名前を入力してください'); return false; }
  if (state.members.some(m => m.name === trimmed)) { showToast('同じ名前のメンバーがいます'); return false; }
  const colorIdx = state.members.length % MEMBER_COLORS.length;
  state.members.push({ id: generateMemberId(), name: trimmed, color: MEMBER_COLORS[colorIdx] });
  saveState();
  return true;
}

function getMemberColor(memberId) {
  const m = state.members.find(m => m.id === memberId);
  if (m && m.color) return m.color;
  const idx = state.members.findIndex(m => m.id === memberId);
  return MEMBER_COLORS[idx >= 0 ? idx % MEMBER_COLORS.length : 0];
}

function removeMember(memberId) {
  const hasExpenses = state.expenses.some(e => e.payerId === memberId || e.splitWith.includes(memberId));
  if (hasExpenses) {
    showToast('支払い記録に含まれているため削除できません');
    return false;
  }
  state.members = state.members.filter(m => m.id !== memberId);
  saveState();
  return true;
}

/* ===== Expense Management ===== */
function addExpense(data) {
  if (!data.payerId) { showToast('支払った人を選択してください'); return false; }
  if (!data.amount || data.amount <= 0) { showToast('金額を入力してください'); return false; }
  if (!data.splitWith || data.splitWith.length === 0) { showToast('割り勘メンバーを選択してください'); return false; }
  state.expenses.push({
    id: generateExpenseId(),
    date: data.date || getTodayString(),
    payerId: data.payerId,
    amount: Number(data.amount),
    currency: data.currency || 'JPY',
    memo: data.memo || '',
    splitWith: [...data.splitWith]
  });
  saveState();
  return true;
}

function updateExpense(expenseId, data) {
  const idx = state.expenses.findIndex(e => e.id === expenseId);
  if (idx === -1) return false;
  if (!data.payerId) { showToast('支払った人を選択してください'); return false; }
  if (!data.amount || data.amount <= 0) { showToast('金額を入力してください'); return false; }
  if (!data.splitWith || data.splitWith.length === 0) { showToast('割り勘メンバーを選択してください'); return false; }
  state.expenses[idx] = { ...state.expenses[idx], ...data, amount: Number(data.amount) };
  saveState();
  return true;
}

function deleteExpense(expenseId) {
  state.expenses = state.expenses.filter(e => e.id !== expenseId);
  saveState();
}

/* ===== Itinerary Management ===== */
function addItineraryEvent(data) {
  if (!data.date) { showToast('日付を入力してください'); return false; }
  if (!data.title || !data.title.trim()) { showToast('タイトルを入力してください'); return false; }
  state.itinerary.push({
    id: generateItineraryId(),
    date: data.date,
    time: data.time || '',
    endTime: data.endTime || '',
    title: data.title.trim(),
    category: data.category || 'other',
    memo: data.memo || '',
    url: data.url || '',
    location: data.location || '',
    mapUrl: data.mapUrl || '',
    participants: data.participants || []
  });
  saveState();
  return true;
}

function updateItineraryEvent(eventId, data) {
  const idx = state.itinerary.findIndex(e => e.id === eventId);
  if (idx === -1) return false;
  if (!data.date) { showToast('日付を入力してください'); return false; }
  if (!data.title || !data.title.trim()) { showToast('タイトルを入力してください'); return false; }
  state.itinerary[idx] = { ...state.itinerary[idx], ...data, title: data.title.trim() };
  saveState();
  return true;
}

function deleteItineraryEvent(eventId) {
  state.itinerary = state.itinerary.filter(e => e.id !== eventId);
  saveState();
}

/* ===== Settlement Algorithm ===== */
function calculateNetBalances() {
  const rate = state.exchangeRate || 95;
  const sc = state.settleCurrency || 'JPY';
  const balances = {};
  state.members.forEach(m => { balances[m.id] = 0; });
  state.expenses.forEach(exp => {
    let amt;
    if (sc === 'JPY') { amt = exp.currency === 'JPY' ? exp.amount : exp.amount * rate; }
    else { amt = exp.currency === 'AUD' ? exp.amount : exp.amount / rate; }
    if (balances[exp.payerId] !== undefined) { balances[exp.payerId] += amt; }
    const share = amt / exp.splitWith.length;
    exp.splitWith.forEach(mid => { if (balances[mid] !== undefined) { balances[mid] -= share; } });
  });
  return balances;
}

function calculateSettlementPlan(balances) {
  const sc = state.settleCurrency || 'JPY';
  const debtors = [], creditors = [];
  Object.entries(balances).forEach(([id, bal]) => {
    const r = roundForCurrency(bal, sc);
    if (r < (sc === 'JPY' ? -0.5 : -0.005)) debtors.push({ id, amount: Math.abs(r) });
    else if (r > (sc === 'JPY' ? 0.5 : 0.005)) creditors.push({ id, amount: r });
  });
  debtors.sort((a, b) => b.amount - a.amount);
  creditors.sort((a, b) => b.amount - a.amount);
  const transactions = [];
  let di = 0, ci = 0;
  while (di < debtors.length && ci < creditors.length) {
    const d = debtors[di], c = creditors[ci];
    const transfer = Math.min(d.amount, c.amount);
    if (transfer > (sc === 'JPY' ? 0.5 : 0.005)) {
      transactions.push({ from: d.id, fromName: getMemberName(d.id), to: c.id, toName: getMemberName(c.id), amount: roundForCurrency(transfer, sc), currency: sc });
    }
    d.amount -= transfer; c.amount -= transfer;
    if (d.amount < (sc === 'JPY' ? 0.5 : 0.005)) di++;
    if (c.amount < (sc === 'JPY' ? 0.5 : 0.005)) ci++;
  }
  return transactions;
}

/* ===== Rendering: Members ===== */
function renderMembers() {
  const list = document.getElementById('member-list');
  const empty = document.getElementById('member-empty');
  document.getElementById('member-count').textContent = state.members.length;
  if (state.members.length === 0) { list.innerHTML = ''; empty.hidden = false; return; }
  empty.hidden = true;
  list.innerHTML = state.members.map(m => {
    const color = m.color || getMemberColor(m.id);
    return `
    <li class="list-item">
      <span class="member-color-dot" style="background:${color}"></span>
      <span class="member-name" data-member-id="${m.id}" style="color:${color};font-weight:700;" title="タップで名前を編集">${escapeHtml(m.name)}</span>
      <input type="color" class="member-color-picker" data-color-member="${m.id}" value="${color}" title="テーマカラー変更">
      <button class="btn-icon-sm danger" data-delete-member="${m.id}" title="削除">&#x2716;</button>
    </li>`;
  }).join('');
}

/* ===== Rendering: Expenses ===== */
function renderPayerSelect() {
  const sel = document.getElementById('expense-payer');
  const current = sel.value;
  sel.innerHTML = '<option value="">選択してください</option>' +
    state.members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
  if (current && state.members.some(m => m.id === current)) sel.value = current;
}

function renderSplitCheckboxes(selected) {
  const container = document.getElementById('split-members');
  const allIds = selected || state.members.map(m => m.id);
  container.innerHTML = state.members.map(m => `
    <label><input type="checkbox" name="split" value="${m.id}" ${allIds.includes(m.id) ? 'checked' : ''}> ${escapeHtml(m.name)}</label>
  `).join('');
}

function renderItinParticipants(selected) {
  const container = document.getElementById('itin-participants');
  const allIds = selected || state.members.map(m => m.id);
  container.innerHTML = state.members.map(m => `
    <label><input type="checkbox" name="itin-participant" value="${m.id}" ${allIds.includes(m.id) ? 'checked' : ''}> ${escapeHtml(m.name)}</label>
  `).join('');
}

function getParticipantNames(participantIds) {
  if (!participantIds || participantIds.length === 0) return '';
  if (participantIds.length === state.members.length) return '';
  return participantIds.map(id => {
    const m = state.members.find(m => m.id === id);
    return m ? m.name : '';
  }).filter(Boolean).join(', ');
}

function getParticipantBadges(participantIds) {
  if (!participantIds || participantIds.length === 0) return '';
  if (participantIds.length === state.members.length) return '';
  return participantIds.map(id => {
    const m = state.members.find(m => m.id === id);
    if (!m) return '';
    const color = getMemberColor(m.id);
    return `<span class="member-badge" style="background:${color}">${escapeHtml(m.name)}</span>`;
  }).filter(Boolean).join('');
}

const EXP_PREVIEW_COUNT = 3;
let expShowAll = false;

function renderExpenses() {
  const container = document.getElementById('expense-list');
  const empty = document.getElementById('expense-empty');
  const summary = document.getElementById('expense-summary');
  // Update accordion count
  const moneyCountEl = document.getElementById('money-list-count');
  if (moneyCountEl) moneyCountEl.textContent = '(' + state.expenses.length + '件)';
  if (state.expenses.length === 0) { container.innerHTML = ''; empty.hidden = false; summary.innerHTML = ''; expShowAll = false; return; }
  empty.hidden = true;
  const totalJPY = state.expenses.filter(e => e.currency === 'JPY').reduce((s, e) => s + e.amount, 0);
  const totalAUD = state.expenses.filter(e => e.currency === 'AUD').reduce((s, e) => s + e.amount, 0);
  const parts = [];
  if (totalJPY > 0) parts.push(`<span style="color:var(--c-jpy)">${formatAmount(totalJPY, 'JPY')}</span>`);
  if (totalAUD > 0) parts.push(`<span style="color:var(--c-aud)">${formatAmount(totalAUD, 'AUD')}</span>`);
  summary.innerHTML = parts.length > 0 ? `合計: ${parts.join(' / ')} (${state.expenses.length}件)` : '';
  const sorted = [...state.expenses].sort((a, b) => {
    if (a.date !== b.date) return b.date.localeCompare(a.date);
    return b.id - a.id;
  });
  const needCollapse = sorted.length > EXP_PREVIEW_COUNT;
  const visible = (needCollapse && !expShowAll) ? sorted.slice(0, EXP_PREVIEW_COUNT) : sorted;
  let html = visible.map(e => {
    const splitNames = e.splitWith.map(id => getMemberName(id)).join(', ');
    return `
    <div class="expense-item">
      <div class="expense-top">
        <div class="expense-info">
          <div class="expense-memo">${escapeHtml(e.memo || '(メモなし)')}</div>
          <div class="expense-detail">${escapeHtml(getMemberName(e.payerId))} が支払い → ${escapeHtml(splitNames)}</div>
        </div>
        <div class="expense-right">
          <div class="expense-amount ${e.currency.toLowerCase()}">${formatAmount(e.amount, e.currency)}</div>
          <div class="expense-date">${formatDate(e.date)}</div>
        </div>
      </div>
      <div class="expense-actions">
        <button class="btn-icon-sm" data-edit-expense="${e.id}" title="編集">&#x270E;</button>
        <button class="btn-icon-sm danger" data-delete-expense="${e.id}" title="削除">&#x2716;</button>
      </div>
    </div>`;
  }).join('');
  if (needCollapse) {
    if (expShowAll) {
      html += `<button class="exp-show-all-btn" id="btn-exp-toggle">▲ 折りたたむ</button>`;
    } else {
      const remaining = sorted.length - EXP_PREVIEW_COUNT;
      html += `<button class="exp-show-all-btn" id="btn-exp-toggle">▼ すべて表示（残り${remaining}件）</button>`;
    }
  }
  container.innerHTML = html;
}

/* ===== Rendering: Settlement ===== */
function renderSettlement() {
  const rateInput = document.getElementById('exchange-rate');
  state.exchangeRate = Number(rateInput.value) || 95;
  saveState();
  const sc = state.settleCurrency;
  const balances = calculateNetBalances();
  const plan = calculateSettlementPlan(balances);
  const balanceEl = document.getElementById('balance-list');
  const balanceEmpty = document.getElementById('balance-empty');
  if (state.members.length === 0) { balanceEl.innerHTML = ''; balanceEmpty.hidden = false; }
  else {
    balanceEmpty.hidden = true;
    balanceEl.innerHTML = state.members.map(m => {
      const bal = roundForCurrency(balances[m.id] || 0, sc);
      const cls = bal >= 0 ? 'positive' : 'negative';
      const sign = bal > 0 ? '+' : '';
      return `<div class="balance-item"><span class="balance-name">${escapeHtml(m.name)}</span><span class="balance-amount ${cls}">${sign}${formatAmount(bal, sc)}</span></div>`;
    }).join('');
  }
  const planEl = document.getElementById('settlement-plan');
  const settleEmpty = document.getElementById('settlement-empty');
  if (plan.length === 0) {
    planEl.innerHTML = '';
    if (state.expenses.length > 0 && state.members.length > 0) { settleEmpty.hidden = false; settleEmpty.textContent = '精算不要です（全員均等です）'; }
    else { settleEmpty.hidden = state.expenses.length === 0 && state.members.length === 0; settleEmpty.textContent = '精算するデータがありません'; }
    return;
  }
  settleEmpty.hidden = true;
  planEl.innerHTML = plan.map(t => `
    <div class="settlement-item">
      <span class="settlement-from">${escapeHtml(t.fromName)}</span>
      <span class="settlement-arrow">&#x27A1;</span>
      <span class="settlement-to">${escapeHtml(t.toName)}</span>
      <span class="settlement-amount">${formatAmount(t.amount, t.currency)}</span>
    </div>
  `).join('');
}

/* ===== Rendering: Itinerary ===== */
let itinFilterMember = 'all';

function renderItinFilter() {
  const container = document.getElementById('itin-filter');
  if (state.members.length === 0) { container.innerHTML = ''; return; }
  let html = `<button class="filter-btn ${itinFilterMember === 'all' ? 'active' : ''}" data-filter="all">全員</button>`;
  state.members.forEach(m => {
    const color = getMemberColor(m.id);
    const isActive = itinFilterMember === m.id;
    const style = isActive
      ? `background:${color};color:#fff;border-color:${color}`
      : `border-color:${color};color:${color}`;
    html += `<button class="filter-btn ${isActive ? 'active' : ''}" data-filter="${m.id}" style="${style}">${escapeHtml(m.name)}</button>`;
  });
  container.innerHTML = html;
}

function isEventForMember(ev, memberId) {
  if (memberId === 'all') return true;
  if (!ev.participants || ev.participants.length === 0) return true;
  return ev.participants.includes(memberId);
}

function renderItinerary() {
  const container = document.getElementById('itinerary-list');
  const empty = document.getElementById('itinerary-empty');

  renderItinFilter();

  // Filter by selected member
  const filtered = state.itinerary.filter(ev => isEventForMember(ev, itinFilterMember));

  if (filtered.length === 0) {
    container.innerHTML = '';
    empty.hidden = false;
    if (state.itinerary.length > 0 && itinFilterMember !== 'all') {
      empty.innerHTML = 'このメンバーの予定はありません';
    } else {
      empty.innerHTML = '予定がありません<br><small style="color:var(--c-text2)">「✏️ 編集」タブから予定を追加してください</small>';
    }
    return;
  }
  empty.hidden = true;

  const today = getTodayString();
  const now = new Date();
  const nowTime = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');

  // Sort by date then time
  const sorted = [...filtered].sort((a, b) => {
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    return (a.time || '99:99').localeCompare(b.time || '99:99');
  });

  // Group by date
  const groups = {};
  sorted.forEach(ev => {
    if (!groups[ev.date]) groups[ev.date] = [];
    groups[ev.date].push(ev);
  });

  // Find "next up" event: first event today/future whose time hasn't passed
  let nextUpId = null;
  for (const ev of sorted) {
    if (ev.date > today || (ev.date === today && (!ev.time || ev.time >= nowTime))) {
      nextUpId = ev.id;
      break;
    }
  }

  // Calculate day numbers from first date
  const dates = Object.keys(groups).sort();
  const firstDate = dates[0];

  let html = '';
  dates.forEach(date => {
    const isToday = date === today;
    const dayNum = Math.floor((new Date(date) - new Date(firstDate)) / 86400000) + 1;

    html += `<div class="itin-day-group">`;
    html += `<div class="itin-day-header ${isToday ? 'today' : ''}">`;
    html += `Day ${dayNum} - ${formatDateFull(date)}`;
    if (isToday) html += `<span class="itin-day-label">TODAY</span>`;
    html += `</div>`;
    html += `<div class="itin-timeline">`;

    groups[date].forEach(ev => {
      const isNext = ev.id === nextUpId;
      const catClass = 'itin-event-cat-' + (ev.category || 'other');
      const icon = CATEGORY_ICONS[ev.category] || '📌';

      html += `<div class="itin-event ${catClass} ${isNext ? 'next-up' : ''}">`;
      html += `<div class="itin-event-dot">${icon}</div>`;
      html += `<div class="itin-event-top">`;
      html += `<div class="itin-event-body">`;

      // Time
      if (ev.time) {
        let timeStr = ev.time;
        if (ev.endTime) timeStr += ' - ' + ev.endTime;
        html += `<div class="itin-event-time">${escapeHtml(timeStr)}`;
        if (isNext) html += `<span class="next-badge">NEXT</span>`;
        html += `</div>`;
      } else if (isNext) {
        html += `<div class="itin-event-time"><span class="next-badge">NEXT</span></div>`;
      }

      // Title
      html += `<div class="itin-event-title">${escapeHtml(ev.title)}</div>`;

      // Participants (show only when not all members)
      const pBadges = getParticipantBadges(ev.participants);
      if (pBadges) {
        html += `<div class="itin-event-participants">👥 ${pBadges}</div>`;
      }

      // Location
      if (ev.location) {
        html += `<div class="itin-event-location">📍 ${escapeHtml(ev.location)}</div>`;
      }

      // Links & Memo badge row (auto-generate map link if location exists but no mapUrl)
      const effectiveMapUrl = ev.mapUrl || (ev.location ? generateMapUrl(ev.location) : '');
      const isAutoMap = !ev.mapUrl && !!ev.location;
      const hasLinks = ev.url || effectiveMapUrl;
      if (hasLinks || ev.memo) {
        html += `<div class="itin-event-links">`;
        if (ev.url) html += `<a href="${escapeHtml(ev.url)}" target="_blank" rel="noopener" class="itin-link">📎 リンク</a>`;
        if (effectiveMapUrl) {
          if (isAutoMap) {
            html += `<a href="${escapeHtml(effectiveMapUrl)}" target="_blank" rel="noopener" class="itin-link itin-link-auto">🔍 地図検索</a>`;
          } else {
            html += `<a href="${escapeHtml(effectiveMapUrl)}" target="_blank" rel="noopener" class="itin-link">📍 地図</a>`;
          }
        }
        if (ev.memo) html += `<span class="itin-memo-badge" data-memo-toggle="${ev.id}">📝 メモあり</span>`;
        html += `</div>`;
      }

      // Memo (hidden by default, toggled by badge tap)
      if (ev.memo) {
        html += `<div class="itin-event-memo" id="itin-memo-${ev.id}">${escapeHtml(ev.memo)}</div>`;
      }

      html += `</div></div>`; // close body, top

      // Edit / Delete actions on schedule view
      html += `<div class="itin-event-actions">`;
      html += `<button class="btn-icon-sm" data-view-edit-itin="${ev.id}" title="編集">&#x270E;</button>`;
      html += `<button class="btn-icon-sm danger" data-view-delete-itin="${ev.id}" title="削除">&#x2716;</button>`;
      html += `</div>`;

      html += `</div>`; // close event
    });

    html += `</div></div>`; // close timeline, day-group
  });

  container.innerHTML = html;

  // Auto-scroll to today or next-up
  if (nextUpId) {
    const nextEl = container.querySelector('.itin-event.next-up');
    if (nextEl) {
      setTimeout(() => nextEl.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
    }
  }

  // Inject weather badges (async, non-blocking)
  injectWeatherBadges();
}

/* ===== Rendering: Itinerary Edit List ===== */
function renderItinEditList() {
  const container = document.getElementById('itin-edit-list');
  const empty = document.getElementById('itin-edit-empty');
  const countEl = document.getElementById('itin-count');
  countEl.textContent = state.itinerary.length;

  if (state.itinerary.length === 0) {
    container.innerHTML = '';
    empty.hidden = false;
    return;
  }
  empty.hidden = true;

  const sorted = [...state.itinerary].sort((a, b) => {
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    return (a.time || '99:99').localeCompare(b.time || '99:99');
  });

  container.innerHTML = sorted.map(ev => {
    const icon = CATEGORY_ICONS[ev.category] || '📌';
    const timeStr = ev.time ? ev.time + (ev.endTime ? '-' + ev.endTime : '') : '';
    return `
    <div class="expense-item">
      <div class="expense-top">
        <div class="expense-info">
          <div class="expense-memo">${icon} ${escapeHtml(ev.title)}</div>
          <div class="expense-detail">${formatDate(ev.date)} ${timeStr ? timeStr : ''} ${ev.location ? '📍' + escapeHtml(ev.location) : ''}${getParticipantBadges(ev.participants) ? '<br>👥 ' + getParticipantBadges(ev.participants) : ''}</div>
        </div>
      </div>
      <div class="expense-actions">
        <button class="btn-icon-sm" data-edit-itin="${ev.id}" title="編集">&#x270E;</button>
        <button class="btn-icon-sm" data-clone-itin="${ev.id}" title="複製して作成">&#x1F4CB;</button>
        <button class="btn-icon-sm danger" data-delete-itin="${ev.id}" title="削除">&#x2716;</button>
      </div>
    </div>`;
  }).join('');
}

/* ===== Currency Toggle Helper ===== */
function updateCurrencyToggle(container, activeCurrency, dataAttr) {
  container.querySelectorAll('.toggle-btn').forEach(btn => {
    const val = btn.dataset[dataAttr];
    btn.classList.remove('active-jpy', 'active-aud');
    if (val === activeCurrency) {
      btn.classList.add(activeCurrency === 'JPY' ? 'active-jpy' : 'active-aud');
    }
  });
}

/* ===== Expense Form Helpers ===== */
function getExpenseFormData() {
  const splitChecks = document.querySelectorAll('#split-members input[type="checkbox"]:checked');
  return {
    date: document.getElementById('expense-date').value,
    payerId: document.getElementById('expense-payer').value,
    amount: document.getElementById('expense-amount').value,
    currency: currentCurrency,
    memo: document.getElementById('expense-memo').value,
    splitWith: Array.from(splitChecks).map(cb => cb.value)
  };
}

function resetExpenseForm() {
  document.getElementById('expense-edit-id').value = '';
  document.getElementById('expense-date').value = getTodayString();
  document.getElementById('expense-payer').value = '';
  document.getElementById('expense-amount').value = '';
  document.getElementById('expense-memo').value = '';
  currentCurrency = 'JPY';
  updateCurrencyToggle(document.getElementById('currency-toggle'), 'JPY', 'currency');
  renderSplitCheckboxes();
  document.getElementById('expense-form-title').textContent = '支払いを追加';
  document.getElementById('expense-submit-btn').textContent = '追加する';
  document.getElementById('btn-cancel-edit').style.display = 'none';
}

function startEditExpense(expenseId) {
  const exp = state.expenses.find(e => e.id === expenseId);
  if (!exp) return;
  document.getElementById('expense-edit-id').value = expenseId;
  document.getElementById('expense-date').value = exp.date;
  document.getElementById('expense-payer').value = exp.payerId;
  document.getElementById('expense-amount').value = exp.amount;
  document.getElementById('expense-memo').value = exp.memo;
  currentCurrency = exp.currency;
  updateCurrencyToggle(document.getElementById('currency-toggle'), currentCurrency, 'currency');
  renderSplitCheckboxes(exp.splitWith);
  document.getElementById('expense-form-title').textContent = '支払いを編集';
  document.getElementById('expense-submit-btn').textContent = '更新する';
  document.getElementById('btn-cancel-edit').style.display = '';
  document.getElementById('expense-form-title').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* ===== Itinerary Form Helpers ===== */
function getItineraryFormData() {
  const participantChecks = document.querySelectorAll('#itin-participants input[type="checkbox"]:checked');
  const participants = Array.from(participantChecks).map(cb => cb.value);
  return {
    date: document.getElementById('itin-date').value,
    time: document.getElementById('itin-time').value,
    endTime: document.getElementById('itin-endtime').value,
    title: document.getElementById('itin-title').value,
    category: document.getElementById('itin-category').value,
    memo: document.getElementById('itin-memo').value,
    url: document.getElementById('itin-url').value,
    location: document.getElementById('itin-location').value,
    mapUrl: document.getElementById('itin-mapurl').value,
    participants: participants
  };
}

function resetItineraryForm() {
  document.getElementById('itin-edit-id').value = '';
  document.getElementById('itin-date').value = getTodayString();
  document.getElementById('itin-time').value = '';
  document.getElementById('itin-endtime').value = '';
  document.getElementById('itin-title').value = '';
  document.getElementById('itin-category').value = 'other';
  document.getElementById('itin-memo').value = '';
  document.getElementById('itin-url').value = '';
  document.getElementById('itin-location').value = '';
  document.getElementById('itin-mapurl').value = '';
  document.getElementById('itin-form-title').textContent = '予定を追加';
  document.getElementById('itin-submit-btn').textContent = '追加する';
  document.getElementById('btn-cancel-itin-edit').style.display = 'none';
  renderItinParticipants(); // 全選択
}

function startEditItineraryEvent(eventId) {
  const ev = state.itinerary.find(e => e.id === eventId);
  if (!ev) return;
  document.getElementById('itin-edit-id').value = eventId;
  document.getElementById('itin-date').value = ev.date;
  document.getElementById('itin-time').value = ev.time || '';
  document.getElementById('itin-endtime').value = ev.endTime || '';
  document.getElementById('itin-title').value = ev.title;
  document.getElementById('itin-category').value = ev.category || 'other';
  document.getElementById('itin-memo').value = ev.memo || '';
  document.getElementById('itin-url').value = ev.url || '';
  document.getElementById('itin-location').value = ev.location || '';
  document.getElementById('itin-mapurl').value = ev.mapUrl || '';
  document.getElementById('itin-form-title').textContent = '予定を編集';
  document.getElementById('itin-submit-btn').textContent = '更新する';
  document.getElementById('btn-cancel-itin-edit').style.display = '';
  renderItinParticipants(ev.participants && ev.participants.length > 0 ? ev.participants : null);
  document.getElementById('itin-form-title').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* ===== Export / Import ===== */
function handleExport() {
  const dataStr = JSON.stringify(state, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'travel-expenses-' + getTodayString() + '.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('データを書き出しました');
}

function handleImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const imported = JSON.parse(ev.target.result);
      if (!imported.members || !imported.expenses) throw new Error('Invalid');
      state = imported;
      if (!Array.isArray(state.itinerary)) state.itinerary = [];
      if (!state.nextItineraryId) state.nextItineraryId = 1;
      saveState();
      renderAll();
      showToast('データを読み込みました');
    } catch (err) {
      showToast('読み込み失敗: 不正なファイルです');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

/* ===== Spreadsheet Link ===== */
function updateSpreadsheetLink() {
  const url = localStorage.getItem('travel-app-spreadsheet-url') || DEFAULT_SPREADSHEET_URL;
  const link = document.getElementById('spreadsheet-link');
  link.href = url;
  link.style.display = 'block';
}

/* ===== Feature 1: Checklist (持ち物チェックリスト) ===== */
let clFilterCat = 'all';
let clFilterMember = 'all';

function generateChecklistId() { return state.nextChecklistId++; }

/* --- Auto-category keyword dictionary (~170 words) --- */
const CL_CATEGORY_KEYWORDS = {
  essential: [
    'パスポート','財布','さいふ','鍵','かぎ','キー','チケット','航空券','免許証',
    '保険証','ビザ','現金','クレジットカード','カード','身分証','証明書',
    'スマホ','携帯','ウォレット','搭乗券','予約確認','旅券','ETASイータス'
  ],
  clothes: [
    'Tシャツ','シャツ','パンツ','ズボン','靴下','くつした','下着','したぎ',
    'ジャケット','コート','パーカー','セーター','ニット','スカート','ワンピース',
    '水着','パジャマ','靴','くつ','スニーカー','サンダル','帽子','ぼうし',
    'マフラー','手袋','てぶくろ','ベルト','ネクタイ','スーツ','ドレス',
    'ショートパンツ','短パン','レインコート','カーディガン','上着','羽織',
    'アウター','インナー','肌着','ストッキング','タイツ'
  ],
  electronics: [
    '充電器','じゅうでんき','カメラ','イヤホン','ヘッドホン','PC','パソコン',
    'ノートパソコン','タブレット','iPad','モバイルバッテリー','バッテリー',
    'ケーブル','USBケーブル','USB','変換アダプタ','変換プラグ','アダプター',
    'コンセント変換','三脚','さんきゃく','SDカード','メモリーカード',
    'Kindle','キンドル','スピーカー','ドライヤー','ヘアアイロン','電源タップ',
    'WiFi','ポケットWiFi','ルーター','GoPro','自撮り棒','延長コード'
  ],
  toiletry: [
    '歯ブラシ','はぶらし','歯磨き粉','はみがき','シャンプー','リンス',
    'コンディショナー','ボディソープ','石鹸','せっけん','タオル','たおる',
    'バスタオル','化粧品','けしょうひん','メイク','スキンケア','日焼け止め',
    'ひやけどめ','リップ','クリーム','洗顔','せんがん','コンタクト',
    'コンタクトレンズ','眼鏡','めがね','ヘアブラシ','くし','髭剃り',
    'ひげそり','カミソリ','制汗剤','デオドラント','ティッシュ',
    'ウェットティッシュ','綿棒','めんぼう','ハンカチ','生理用品','爪切り','つめきり'
  ],
  medicine: [
    '薬','くすり','常備薬','風邪薬','かぜぐすり','頭痛薬','胃薬',
    '酔い止め','よいどめ','鎮痛剤','目薬','めぐすり','絆創膏','ばんそうこう',
    '消毒液','体温計','虫除け','むしよけ','虫刺され','サプリ','サプリメント',
    'ビタミン','マスク','包帯','塗り薬','軟膏','アレルギー薬','下痢止め','整腸剤'
  ],
  food: [
    'お菓子','おかし','水筒','すいとう','ボトル','おにぎり','パン',
    'カップ麺','インスタント','レトルト','ふりかけ','お茶','おちゃ',
    'コーヒー','飴','あめ','ガム','チョコ','チョコレート','ナッツ',
    'ドライフルーツ','エナジーバー','プロテインバー','箸','はし','スプーン',
    'フォーク','弁当箱','タッパー','保冷バッグ','水','ミネラルウォーター'
  ]
};

const CL_CAT_LABELS = {
  essential:'必需品', clothes:'衣類', electronics:'電子機器',
  toiletry:'日用品', medicine:'医薬品', food:'食品', other:'その他'
};

function detectChecklistCategory(text) {
  const n = text.trim().toLowerCase();
  for (const [cat, keywords] of Object.entries(CL_CATEGORY_KEYWORDS)) {
    for (const kw of keywords) {
      if (n.includes(kw.toLowerCase())) return cat;
    }
  }
  return 'other';
}

/* --- Data migration: old format → new per-member format --- */
function migrateChecklistItems() {
  if (!Array.isArray(state.checklist)) return;
  const allMemberIds = state.members.map(m => m.id);
  state.checklist.forEach(item => {
    // Already migrated?
    if (Array.isArray(item.members) && item.checkedBy && typeof item.checkedBy === 'object' && !Array.isArray(item.checkedBy)) {
      delete item.checked; delete item.assignee;
      return;
    }
    const wasChecked = !!item.checked;
    // Determine members
    if (item.assignee) {
      const aid = Number(item.assignee) || item.assignee;
      item.members = allMemberIds.includes(aid) ? [aid] : [...allMemberIds];
    } else {
      item.members = [...allMemberIds];
    }
    // Build checkedBy
    item.checkedBy = {};
    item.members.forEach(mid => { item.checkedBy[String(mid)] = wasChecked; });
    // Validate category
    if (!item.category || !Object.keys(CL_CAT_LABELS).includes(item.category)) {
      item.category = 'other';
    }
    delete item.checked; delete item.assignee;
  });
}

/* --- Render helpers --- */
function renderChecklistMemberFilter() {
  const c = document.getElementById('cl-member-filter');
  if (!c) return;
  if (state.members.length === 0) { c.innerHTML = ''; return; }
  const allCls = clFilterMember === 'all' ? 'active' : '';
  let h = `<span class="cl-member-filter-btn ${allCls}" data-cl-member="all" style="background:var(--c-text)">全員</span>`;
  state.members.forEach(m => {
    const active = clFilterMember === m.id ? 'active' : '';
    h += `<span class="cl-member-filter-btn ${active}" data-cl-member="${m.id}" style="background:${m.color||'#888'}">${escapeHtml(m.name)}</span>`;
  });
  c.innerHTML = h;
}

function renderChecklistAddMembers() {
  const c = document.getElementById('cl-add-member-checks');
  if (!c) return;
  c.innerHTML = state.members.map(m =>
    `<label style="border-left:3px solid ${m.color||'#888'}"><input type="checkbox" name="cl-member" value="${m.id}" checked> ${escapeHtml(m.name)}</label>`
  ).join('');
}

function renderChecklist() {
  const list = document.getElementById('checklist-list');
  const fillEl = document.getElementById('checklist-progress-fill');
  const summaryEl = document.getElementById('cl-progress-summary');
  const items = state.checklist || [];
  // Update accordion count
  const clCountEl = document.getElementById('cl-list-count');
  if (clCountEl) clCountEl.textContent = '(' + items.length + '件)';

  // Filter by category
  let filtered = clFilterCat === 'all' ? [...items] : items.filter(i => i.category === clFilterCat);
  // Filter by member
  if (clFilterMember !== 'all') {
    filtered = filtered.filter(i => (i.members || []).includes(clFilterMember));
  }

  // Calculate overall progress (total member-checks across all items)
  let totalChecks = 0, doneChecks = 0;
  items.forEach(item => {
    (item.members || []).forEach(mid => {
      totalChecks++;
      if (item.checkedBy && item.checkedBy[String(mid)]) doneChecks++;
    });
  });

  // Per-member progress
  const memberProgress = {};
  state.members.forEach(m => { memberProgress[m.id] = { total: 0, done: 0 }; });
  items.forEach(item => {
    (item.members || []).forEach(mid => {
      if (memberProgress[mid]) {
        memberProgress[mid].total++;
        if (item.checkedBy && item.checkedBy[String(mid)]) memberProgress[mid].done++;
      }
    });
  });

  // Render progress
  const pct = totalChecks > 0 ? Math.round(doneChecks / totalChecks * 100) : 0;
  fillEl.style.width = pct + '%';
  let sumH = `<span class="cl-progress-overall">${doneChecks}/${totalChecks}</span>`;
  state.members.forEach(m => {
    const mp = memberProgress[m.id];
    if (mp && mp.total > 0) {
      const done = mp.done === mp.total;
      const filterActive = clFilterMember === m.id ? ' filter-active' : '';
      sumH += `<span class="cl-progress-member${done ? ' done' : ''}${filterActive}" data-cl-member="${m.id}" style="background:${m.color||'#888'}">${escapeHtml(m.name)} <span class="cl-pm-count">${mp.done}/${mp.total}</span></span>`;
    }
  });
  if (summaryEl) summaryEl.innerHTML = sumH;

  // Render member filter & add-form members
  renderChecklistMemberFilter();

  // Update active category tab
  document.querySelectorAll('.cl-cat-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.clCat === clFilterCat);
  });

  // Render items
  if (filtered.length === 0) {
    const msg = items.length === 0 ? 'アイテムを追加してください' : 'このフィルタに該当するアイテムはありません';
    list.innerHTML = `<p style="text-align:center;color:var(--c-text2);font-size:var(--fs-sm);padding:var(--sp-md) 0;">${msg}</p>`;
    return;
  }

  list.innerHTML = filtered.map(item => {
    const memberIds = item.members || [];
    const allChecked = memberIds.length > 0 && memberIds.every(mid => item.checkedBy && item.checkedBy[String(mid)]);
    const catLabel = CL_CAT_LABELS[item.category] || 'その他';

    const dotsHtml = memberIds.map(mid => {
      const member = state.members.find(m => m.id === mid);
      if (!member) return '';
      const isChecked = item.checkedBy && item.checkedBy[String(mid)];
      const initial = member.name.charAt(0);
      return `<button class="cl-member-dot${isChecked ? ' checked' : ''}" data-cl-toggle="${item.id}" data-cl-member-id="${mid}" style="background:${member.color||'#888'}" title="${escapeHtml(member.name)}${isChecked ? ' ✓' : ''}"><span class="cl-dot-check">✓</span><span class="cl-dot-initial">${escapeHtml(initial)}</span></button>`;
    }).join('');

    return `<div class="cl-item${allChecked ? ' cl-complete' : ''}" data-cl-id="${item.id}">
      <div class="cl-item-main">
        <span class="cl-text">${escapeHtml(item.text)}</span>
        <span class="cl-cat-badge">${catLabel}</span>
        <button class="cl-del" data-cl-delete="${item.id}" title="削除">&times;</button>
      </div>
      <div class="cl-member-checks">${dotsHtml}</div>
    </div>`;
  }).join('');
}

function addChecklistItem(text, category) {
  const trimmed = (text || '').trim();
  if (!trimmed) return false;
  // Auto-detect category
  const detectedCat = detectChecklistCategory(trimmed);
  const finalCat = (category && category !== 'all' && category !== 'other') ? category : detectedCat;
  // Gather selected members from form
  const cbs = document.querySelectorAll('#cl-add-member-checks input[type=checkbox]');
  let selectedMembers = [];
  cbs.forEach(cb => { if (cb.checked) { const v = cb.value; selectedMembers.push(isNaN(Number(v)) ? v : Number(v)); } });
  if (selectedMembers.length === 0) selectedMembers = state.members.map(m => m.id);
  // Init checkedBy
  const checkedBy = {};
  selectedMembers.forEach(mid => { checkedBy[String(mid)] = false; });
  state.checklist.push({
    id: generateChecklistId(),
    text: trimmed,
    members: selectedMembers,
    checkedBy: checkedBy,
    category: finalCat
  });
  saveState();
  return true;
}

function toggleChecklistItem(itemId, memberId) {
  const item = state.checklist.find(i => i.id === itemId);
  if (!item || !item.checkedBy) return;
  const key = String(memberId);
  item.checkedBy[key] = !item.checkedBy[key];
  saveState();
}

function deleteChecklistItem(id) {
  state.checklist = state.checklist.filter(i => i.id !== id);
  saveState();
}

/* ===== Feature 2: Share Today's Schedule (今日の予定をテキストコピー) ===== */
function shareSchedule() {
  const today = getTodayString();
  const todayEvents = state.itinerary
    .filter(ev => ev.date === today)
    .sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));

  if (todayEvents.length === 0) {
    showToast('今日の予定はありません');
    return;
  }

  const dates = [...new Set(state.itinerary.map(e => e.date))].sort();
  const firstDate = dates[0];
  const dayNum = firstDate ? Math.floor((new Date(today) - new Date(firstDate)) / 86400000) + 1 : 1;

  let text = `📋 Day ${dayNum} - ${formatDateFull(today)} の予定\n`;
  text += '━'.repeat(24) + '\n\n';

  todayEvents.forEach(ev => {
    const icon = CATEGORY_ICONS[ev.category] || '📌';
    let line = icon + ' ';
    if (ev.time) {
      line += ev.time;
      if (ev.endTime) line += '〜' + ev.endTime;
      line += '  ';
    }
    line += ev.title;
    text += line + '\n';
    if (ev.location) text += `   📍 ${ev.location}\n`;
    if (ev.memo) text += `   📝 ${ev.memo}\n`;
    text += '\n';
  });

  text += '━'.repeat(24) + '\n';
  text += `✨ 旅のしおりアプリ より`;

  if (navigator.share) {
    navigator.share({ title: `Day ${dayNum} の予定`, text: text }).catch(() => {
      copyToClipboard(text);
    });
  } else {
    copyToClipboard(text);
  }
}

function copyToClipboard(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => {
      showToast('📋 クリップボードにコピーしました');
    }).catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.select();
  try { document.execCommand('copy'); showToast('📋 クリップボードにコピーしました'); }
  catch(e) { showToast('コピーに失敗しました'); }
  document.body.removeChild(ta);
}


/* ===== Feature 4: Weather (天気予報連携) ===== */
let weatherCache = {};

async function fetchWeather(date) {
  // Only fetch for dates within 7 days from now
  const now = new Date();
  const target = new Date(date);
  const diffDays = Math.floor((target - now) / 86400000);
  if (diffDays < -1 || diffDays > 6) return null;

  if (weatherCache[date]) return weatherCache[date];

  try {
    // Open-Meteo free API (no key needed)
    // Priority: state (synced) > localStorage > default Sydney
    const lat = state.weatherLat || localStorage.getItem('travel-app-weather-lat') || '-33.87';
    const lon = state.weatherLon || localStorage.getItem('travel-app-weather-lon') || '151.21';
    const res = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&start_date=${date}&end_date=${date}`,
      { signal: AbortSignal.timeout(5000) }
    );
    if (!res.ok) return null;
    const data = await res.json();
    if (data.daily && data.daily.time && data.daily.time.includes(date)) {
      const idx = data.daily.time.indexOf(date);
      const wcode = data.daily.weathercode[idx];
      const tmax = Math.round(data.daily.temperature_2m_max[idx]);
      const tmin = Math.round(data.daily.temperature_2m_min[idx]);
      const weather = { icon: weatherCodeToEmoji(wcode), tmax, tmin, code: wcode };
      weatherCache[date] = weather;
      return weather;
    }
  } catch(e) { /* ignore */ }
  return null;
}

function weatherCodeToEmoji(code) {
  if (code === 0) return '☀️';
  if (code <= 3) return '⛅';
  if (code <= 48) return '🌫️';
  if (code <= 57) return '🌦️';
  if (code <= 67) return '🌧️';
  if (code <= 77) return '❄️';
  if (code <= 82) return '🌧️';
  if (code <= 86) return '❄️';
  if (code <= 99) return '⛈️';
  return '🌤️';
}

async function injectWeatherBadges() {
  const headers = document.querySelectorAll('.itin-day-header');
  for (const header of headers) {
    // Extract date from header text
    const text = header.textContent;
    // Find the date by matching against itinerary dates
    const dates = [...new Set(state.itinerary.map(e => e.date))].sort();
    const dayMatch = text.match(/Day\s+(\d+)/);
    if (!dayMatch) continue;
    const dayNum = parseInt(dayMatch[1]);
    const firstDate = dates[0];
    if (!firstDate) continue;
    const targetDate = new Date(firstDate);
    targetDate.setDate(targetDate.getDate() + dayNum - 1);
    const dateStr = targetDate.getFullYear() + '-' + String(targetDate.getMonth() + 1).padStart(2, '0') + '-' + String(targetDate.getDate()).padStart(2, '0');

    // Remove existing weather badge
    const existing = header.querySelector('.weather-badge');
    if (existing) existing.remove();

    const weather = await fetchWeather(dateStr);
    if (weather) {
      const badge = document.createElement('span');
      badge.className = 'weather-badge';
      badge.innerHTML = `${weather.icon} <span class="w-temp">${weather.tmin}°〜${weather.tmax}°</span>`;
      header.appendChild(badge);
    }
  }
}

/* ===== Feature 5: Templates (テンプレート機能) ===== */
const TEMPLATES = [
  { icon: '✈️', name: '空港→ホテル', events: [
    { time: '08:00', endTime: '12:00', title: '空港出発 → 到着', category: 'flight' },
    { time: '13:00', endTime: '14:00', title: 'ホテルチェックイン', category: 'hotel' }
  ]},
  { icon: '🗺️', name: '観光1日', events: [
    { time: '09:00', endTime: '12:00', title: '午前の観光スポット', category: 'sightseeing' },
    { time: '12:00', endTime: '13:00', title: 'ランチ', category: 'food' },
    { time: '13:30', endTime: '17:00', title: '午後の観光スポット', category: 'sightseeing' },
    { time: '18:00', endTime: '19:30', title: 'ディナー', category: 'food' }
  ]},
  { icon: '🏖️', name: 'ビーチ日', events: [
    { time: '09:00', endTime: '12:00', title: 'ビーチアクティビティ', category: 'sightseeing' },
    { time: '12:30', endTime: '13:30', title: 'シーサイドランチ', category: 'food' },
    { time: '14:00', endTime: '16:00', title: '自由時間', category: 'other' }
  ]},
  { icon: '🛍️', name: 'ショッピング', events: [
    { time: '10:00', endTime: '12:30', title: 'ショッピングモール', category: 'sightseeing' },
    { time: '12:30', endTime: '13:30', title: 'ランチ', category: 'food' },
    { time: '14:00', endTime: '17:00', title: 'マーケット巡り', category: 'sightseeing' }
  ]},
  { icon: '🏨', name: 'チェックアウト', events: [
    { time: '08:00', endTime: '09:00', title: '朝食', category: 'food' },
    { time: '10:00', endTime: '10:30', title: 'チェックアウト', category: 'hotel' },
    { time: '11:00', endTime: '15:00', title: '空港へ移動 → 出発', category: 'flight' }
  ]},
  { icon: '🍽️', name: 'グルメツアー', events: [
    { time: '09:00', endTime: '10:00', title: 'モーニングカフェ', category: 'food' },
    { time: '11:30', endTime: '13:00', title: 'ローカルフード巡り', category: 'food' },
    { time: '15:00', endTime: '16:00', title: 'スイーツ＆カフェ', category: 'food' },
    { time: '18:30', endTime: '20:00', title: 'ディナーレストラン', category: 'food' }
  ]}
];

function renderTemplates() {
  const grid = document.getElementById('template-grid');
  grid.innerHTML = TEMPLATES.map((tpl, i) => `
    <div class="tpl-card" data-tpl-idx="${i}">
      <div class="tpl-icon">${tpl.icon}</div>
      <div class="tpl-name">${escapeHtml(tpl.name)}</div>
    </div>
  `).join('');
}

function applyTemplate(idx) {
  const tpl = TEMPLATES[idx];
  if (!tpl) return;
  const dateInput = document.getElementById('itin-date');
  const date = dateInput.value || getTodayString();
  const allMembers = state.members.map(m => m.id);

  tpl.events.forEach(ev => {
    addItineraryEvent({
      date: date,
      time: ev.time || '',
      endTime: ev.endTime || '',
      title: ev.title,
      category: ev.category || 'other',
      memo: '',
      url: '',
      location: ev.location || '',
      mapUrl: '',
      participants: [...allMembers]
    });
  });

  renderItinerary();
  renderItinEditList();
  showToast(`「${tpl.name}」テンプレートを追加しました (${tpl.events.length}件)`);
}

/* ===== Render All ===== */
/* ===== Home Dashboard ===== */
function renderHome() {
  const bannerEl = document.getElementById('home-banner');
  const welcomeEl = document.getElementById('home-welcome');
  const itinCard = document.getElementById('home-itinerary-card');
  const clCard = document.getElementById('home-checklist-card');
  const moneyCard = document.getElementById('home-money-card');
  if (!bannerEl) return;

  const { tripTitle, tripDestination, tripStartDate, tripEndDate, tripImageUrl } = state;
  const hasTripInfo = tripTitle || tripDestination;

  // --- Trip Banner ---
  if (hasTripInfo) {
    welcomeEl.hidden = true;
    let bHtml = '';
    if (tripImageUrl) bHtml += `<div class="trip-banner-bg" style="background-image:url('${escapeHtml(tripImageUrl)}')"></div>`;
    bHtml += `<div class="trip-banner-content">`;
    if (tripTitle) bHtml += `<div class="trip-banner-title">${escapeHtml(tripTitle)}</div>`;
    if (tripDestination) bHtml += `<div class="trip-banner-dest">${escapeHtml(tripDestination)}</div>`;
    if (tripStartDate || tripEndDate) {
      const start = tripStartDate ? formatDateFull(tripStartDate) : '';
      const end = tripEndDate ? formatDateFull(tripEndDate) : '';
      bHtml += `<div class="trip-banner-dates">📅 ${start && end ? start + ' → ' + end : start || end}</div>`;
    }
    if (tripStartDate) {
      const td = new Date(); td.setHours(0,0,0,0);
      const sd = new Date(tripStartDate + 'T00:00:00');
      const ed = tripEndDate ? new Date(tripEndDate + 'T23:59:59') : null;
      const diff = Math.ceil((sd - td) / 86400000);
      if (diff > 0) bHtml += `<div class="trip-banner-countdown">🛫 出発まであと <span class="countdown-num">${diff}</span> 日</div>`;
      else if (diff === 0) bHtml += `<div class="trip-banner-countdown">🎉 いよいよ今日出発！</div>`;
      else if (ed && td <= ed) { const day = Math.floor((td - sd) / 86400000) + 1; bHtml += `<div class="trip-banner-countdown">✨ 旅行 <span class="countdown-num">${day}</span> 日目</div>`; }
      else bHtml += `<div class="trip-banner-countdown">📸 旅の思い出</div>`;
    }
    bHtml += `</div>`;
    bannerEl.innerHTML = `<div class="trip-banner">${bHtml}</div>`;
  } else {
    bannerEl.innerHTML = '';
    welcomeEl.hidden = false;
  }

  // --- Itinerary snapshot ---
  const todayStr = getTodayString();
  const now = new Date();
  const nowTime = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
  const allSorted = [...state.itinerary].sort((a,b) => {
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    return (a.time||'99:99').localeCompare(b.time||'99:99');
  });
  const todayEvents = allSorted.filter(ev => ev.date === todayStr);
  let nextUpEv = null;
  for (const ev of allSorted) {
    if (ev.date > todayStr || (ev.date === todayStr && (!ev.time || ev.time >= nowTime))) { nextUpEv = ev; break; }
  }
  const itinBody = document.getElementById('home-itinerary-body');
  if (state.itinerary.length === 0) {
    itinCard.hidden = true;
  } else {
    itinCard.hidden = false;
    // Update card title based on context
    const titleEl = itinCard.querySelector('.home-card-title');
    let iHtml = '';
    if (todayEvents.length > 0) {
      titleEl.innerHTML = '&#x1F5FA; 今日の予定';
      todayEvents.slice(0, 5).forEach(ev => {
        const icon = CATEGORY_ICONS[ev.category] || '📌';
        const isNext = nextUpEv && ev.id === nextUpEv.id;
        iHtml += `<div class="home-event${isNext ? ' next-up' : ''}">`;
        iHtml += `<span class="home-event-icon">${icon}</span>`;
        iHtml += `<span class="home-event-time">${ev.time ? escapeHtml(ev.time) : '--:--'}</span>`;
        iHtml += `<span class="home-event-title">${escapeHtml(ev.title)}${isNext ? '<span class="home-next-badge">NEXT</span>' : ''}</span></div>`;
      });
      if (todayEvents.length > 5) iHtml += `<div class="home-more-link">他 ${todayEvents.length - 5} 件の予定 ›</div>`;
    } else if (nextUpEv) {
      titleEl.innerHTML = '&#x1F5FA; 次の予定';
      const icon = CATEGORY_ICONS[nextUpEv.category] || '📌';
      iHtml += `<div class="home-event-empty">今日の予定はありません</div>`;
      iHtml += `<div style="font-size:var(--fs-xs);color:var(--c-text2);margin-bottom:4px">次の予定:</div>`;
      iHtml += `<div class="home-event next-up"><span class="home-event-icon">${icon}</span>`;
      iHtml += `<span class="home-event-time">${formatDate(nextUpEv.date)} ${nextUpEv.time||''}</span>`;
      iHtml += `<span class="home-event-title">${escapeHtml(nextUpEv.title)}<span class="home-next-badge">NEXT</span></span></div>`;
    } else {
      titleEl.innerHTML = '&#x1F5FA; 旅程';
      iHtml += `<div class="home-event-empty">予定はすべて終了しました 🎉</div>`;
    }
    itinBody.innerHTML = iHtml;
  }

  // --- Checklist progress ---
  const items = state.checklist || [];
  if (items.length === 0) {
    clCard.hidden = true;
  } else {
    clCard.hidden = false;
    let totalChecks = 0, doneChecks = 0;
    const mp = {};
    state.members.forEach(m => { mp[m.id] = { total:0, done:0 }; });
    items.forEach(item => {
      (item.members||[]).forEach(mid => {
        totalChecks++;
        if (item.checkedBy && item.checkedBy[String(mid)]) doneChecks++;
        if (mp[mid]) { mp[mid].total++; if (item.checkedBy && item.checkedBy[String(mid)]) mp[mid].done++; }
      });
    });
    const pct = totalChecks > 0 ? Math.round(doneChecks / totalChecks * 100) : 0;
    let cHtml = `<div class="home-cl-progress">`;
    cHtml += `<div class="home-cl-bar-track"><div class="home-cl-bar-fill" style="width:${pct}%"></div></div>`;
    cHtml += `<div class="home-cl-stats"><span class="home-cl-pct">${pct}%</span><span>${doneChecks}/${totalChecks} 完了</span></div></div>`;
    cHtml += `<div class="home-cl-members">`;
    state.members.forEach(m => {
      const p = mp[m.id];
      if (p && p.total > 0) {
        const done = p.done === p.total;
        cHtml += `<span class="home-cl-member-badge${done ? ' done' : ''}" style="background:${m.color||'#888'}">${escapeHtml(m.name)} ${p.done}/${p.total}${done ? ' ✓' : ''}</span>`;
      }
    });
    cHtml += `</div>`;
    document.getElementById('home-checklist-body').innerHTML = cHtml;
  }

  // --- Money summary ---
  if (!state.expenses || state.expenses.length === 0) {
    moneyCard.hidden = true;
  } else {
    moneyCard.hidden = false;
    const rate = state.exchangeRate || 95;
    const toJPY = (a, c) => c === 'AUD' ? a * rate : a;
    const totalJPY = state.expenses.reduce((s, e) => s + toJPY(e.amount, e.currency), 0);
    const perPerson = state.members.length > 0 ? totalJPY / state.members.length : totalJPY;
    const totalAUD = state.expenses.filter(e => e.currency === 'AUD').reduce((s, e) => s + e.amount, 0);

    let mHtml = `<div class="home-money-grid">`;
    mHtml += `<div class="home-money-stat"><div class="home-money-val">${formatAmount(Math.round(totalJPY),'JPY')}</div><div class="home-money-label">総支出(円換算)</div></div>`;
    mHtml += `<div class="home-money-stat"><div class="home-money-val">${state.expenses.length}件</div><div class="home-money-label">支払い回数</div></div>`;
    mHtml += `<div class="home-money-stat"><div class="home-money-val">${formatAmount(Math.round(perPerson),'JPY')}</div><div class="home-money-label">1人あたり</div></div>`;
    mHtml += `<div class="home-money-stat"><div class="home-money-val">${totalAUD > 0 ? formatAmount(totalAUD,'AUD') : '-'}</div><div class="home-money-label">AUD支出合計</div></div>`;
    mHtml += `</div>`;

    // Per-member bars
    const perMember = {};
    state.members.forEach(m => { perMember[m.id] = 0; });
    state.expenses.forEach(e => { if (perMember[e.payerId] !== undefined) perMember[e.payerId] += toJPY(e.amount, e.currency); });
    const maxSpent = Math.max(...Object.values(perMember), 0.01);
    mHtml += `<div class="home-money-bars">`;
    state.members.forEach(m => {
      const spent = perMember[m.id] || 0;
      const pctBar = maxSpent > 0 ? (spent / maxSpent * 100) : 0;
      mHtml += `<div class="home-money-bar-row"><span class="home-money-bar-name">${escapeHtml(m.name)}</span>`;
      mHtml += `<div class="home-money-bar-track"><div class="home-money-bar-fill" style="width:${pctBar}%;background:${m.color||'#888'}"></div></div>`;
      mHtml += `<span class="home-money-bar-val">${formatAmount(Math.round(spent),'JPY')}</span></div>`;
    });
    mHtml += `</div>`;
    document.getElementById('home-money-body').innerHTML = mHtml;
  }
}

/* ===== Trip Banner & Info ===== */
function renderTripBanner() {
  const banner = document.getElementById('trip-banner');
  if (!banner) return;
  const { tripTitle, tripDestination, tripStartDate, tripEndDate, tripImageUrl } = state;
  if (!tripTitle && !tripDestination) { banner.hidden = true; return; }
  banner.hidden = false;
  let html = '';
  if (tripImageUrl) {
    html += `<div class="trip-banner-bg" style="background-image:url('${escapeHtml(tripImageUrl)}')"></div>`;
  }
  html += `<div class="trip-banner-content">`;
  if (tripTitle) html += `<div class="trip-banner-title">${escapeHtml(tripTitle)}</div>`;
  if (tripDestination) html += `<div class="trip-banner-dest">${escapeHtml(tripDestination)}</div>`;
  if (tripStartDate || tripEndDate) {
    const start = tripStartDate ? formatDateFull(tripStartDate) : '';
    const end = tripEndDate ? formatDateFull(tripEndDate) : '';
    const dateStr = start && end ? `${start} → ${end}` : start || end;
    html += `<div class="trip-banner-dates">📅 ${dateStr}</div>`;
  }
  // Countdown to trip
  if (tripStartDate) {
    const today = new Date(); today.setHours(0,0,0,0);
    const startD = new Date(tripStartDate + 'T00:00:00');
    const endD = tripEndDate ? new Date(tripEndDate + 'T23:59:59') : null;
    const diffMs = startD - today;
    const diffDays = Math.ceil(diffMs / (1000*60*60*24));
    if (diffDays > 0) {
      html += `<div class="trip-banner-countdown">🛫 出発まであと <span class="countdown-num">${diffDays}</span> 日</div>`;
    } else if (diffDays === 0) {
      html += `<div class="trip-banner-countdown">🎉 いよいよ今日出発！</div>`;
    } else if (endD && today <= endD) {
      const tripDay = Math.floor((today - startD) / (1000*60*60*24)) + 1;
      html += `<div class="trip-banner-countdown">✨ 旅行 <span class="countdown-num">${tripDay}</span> 日目</div>`;
    } else {
      html += `<div class="trip-banner-countdown">📸 旅の思い出</div>`;
    }
  }
  html += `</div>`;
  banner.innerHTML = html;
}

function loadTripInfoForm() {
  const el = document.getElementById('trip-title');
  if (!el) return;
  el.value = state.tripTitle || '';
  document.getElementById('trip-destination').value = state.tripDestination || '';
  document.getElementById('trip-start-date').value = state.tripStartDate || '';
  document.getElementById('trip-end-date').value = state.tripEndDate || '';
  document.getElementById('trip-image-url').value = state.tripImageUrl || '';
}

function saveTripInfo() {
  const oldDest = state.tripDestination;
  state.tripTitle = document.getElementById('trip-title').value.trim();
  state.tripDestination = document.getElementById('trip-destination').value.trim();
  state.tripStartDate = document.getElementById('trip-start-date').value;
  state.tripEndDate = document.getElementById('trip-end-date').value;
  state.tripImageUrl = document.getElementById('trip-image-url').value.trim();
  saveState();
  renderTripBanner();
  renderHome();
  showToast('旅行基本情報を保存しました');
  if (state.tripDestination && state.tripDestination !== oldDest) {
    geocodeDestination(state.tripDestination);
  }
}

/* ===== Google Maps Auto Link ===== */
function generateMapUrl(location) {
  if (!location) return '';
  return 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(location);
}

/* ===== Geocoding for Weather ===== */
let geocodeCache = {};

async function geocodeDestination(destinationName) {
  if (!destinationName) return;
  if (geocodeCache[destinationName]) { applyGeocode(geocodeCache[destinationName]); return; }
  try {
    const res = await fetch(
      `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(destinationName)}&count=1&language=ja`,
      { signal: AbortSignal.timeout(5000) }
    );
    if (!res.ok) return;
    const data = await res.json();
    if (data.results && data.results.length > 0) {
      const r = data.results[0];
      const coords = { lat: r.latitude, lon: r.longitude, name: r.name };
      geocodeCache[destinationName] = coords;
      applyGeocode(coords);
      console.log(`[geocode] ${destinationName} -> ${coords.lat}, ${coords.lon} (${coords.name})`);
    }
  } catch (e) { console.warn('[geocode] Failed:', e); }
}

function applyGeocode(coords) {
  state.weatherLat = String(coords.lat);
  state.weatherLon = String(coords.lon);
  saveState();
  localStorage.setItem('travel-app-weather-lat', state.weatherLat);
  localStorage.setItem('travel-app-weather-lon', state.weatherLon);
  weatherCache = {};
  injectWeatherBadges();
}

function renderAll() {
  renderHome();
  renderMembers();
  renderPayerSelect();
  renderSplitCheckboxes();
  renderItinParticipants();
  renderExpenses();
  renderSettlement();
  renderItinerary();
  renderItinEditList();
  renderChecklist();
  renderTemplates();
  document.getElementById('exchange-rate').value = state.exchangeRate;
  updateCurrencyToggle(document.getElementById('settle-currency-toggle'), state.settleCurrency, 'settle');
  renderTripBanner();
  loadTripInfoForm();
  // Weather injection (async, non-blocking)
  injectWeatherBadges();
}

/* ===== Event Listeners ===== */
function initEventListeners() {
  // Tab switching
  document.querySelector('.tab-nav').addEventListener('click', function(e) {
    const btn = e.target.closest('.tab-btn');
    if (!btn) return;
    const tabId = btn.dataset.tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    if (tabId === 'home') { renderHome(); }
    if (tabId === 'itinerary') { renderItinerary(); renderItinEditList(); renderItinParticipants(); renderTemplates(); injectWeatherBadges(); }
    if (tabId === 'checklist') { renderChecklist(); }
    if (tabId === 'money') { renderPayerSelect(); renderSplitCheckboxes(); renderExpenses(); renderSettlement(); }
    if (tabId === 'settings') { renderMembers(); updateSpreadsheetLink(); document.getElementById('exchange-rate').value = state.exchangeRate; updateCurrencyToggle(document.getElementById('settle-currency-toggle'), state.settleCurrency, 'settle'); }
  });

  // Home card navigation — tap card to go to detail tab
  document.getElementById('tab-home').addEventListener('click', function(e) {
    const card = e.target.closest('[data-home-goto]');
    if (!card) return;
    const targetTab = card.dataset.homeGoto;
    const targetBtn = document.querySelector('.tab-btn[data-tab="' + targetTab + '"]');
    if (targetBtn) targetBtn.click();
  });
  // Home welcome CTA
  document.getElementById('tab-home').addEventListener('click', function(e) {
    const cta = e.target.closest('#home-goto-settings');
    if (!cta) return;
    const settingsBtn = document.querySelector('.tab-btn[data-tab="settings"]');
    if (settingsBtn) settingsBtn.click();
  });

  // Add member
  document.getElementById('form-add-member').addEventListener('submit', function(e) {
    e.preventDefault();
    const input = document.getElementById('input-member-name');
    if (addMember(input.value)) {
      input.value = '';
      renderMembers();
      renderPayerSelect();
      renderSplitCheckboxes();
      showToast('メンバーを追加しました');
    }
  });

  // Delete member & edit member name
  document.getElementById('member-list').addEventListener('click', function(e) {
    // Delete
    const btn = e.target.closest('[data-delete-member]');
    if (btn) {
      const id = btn.dataset.deleteMember;
      const name = getMemberName(id);
      showModal(`「${name}」を削除しますか？`, '削除する', function() {
        if (removeMember(id)) {
          renderMembers(); renderPayerSelect(); renderSplitCheckboxes();
          showToast('メンバーを削除しました');
        }
        closeModal();
      });
      return;
    }
    // Edit name — click on .member-name to start inline editing
    const nameEl = e.target.closest('.member-name');
    if (nameEl && !e.target.closest('.member-name-edit')) {
      const mid = nameEl.dataset.memberId;
      const member = state.members.find(m => String(m.id) === mid);
      if (!member) return;
      const oldName = member.name;
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'member-name-edit';
      input.value = oldName;
      input.maxLength = 20;
      input.style.color = member.color || '';
      nameEl.replaceWith(input);
      input.focus();
      input.select();
      function commitEdit() {
        const newName = input.value.trim();
        if (newName && newName !== oldName) {
          if (state.members.some(m => m.name === newName && m.id !== member.id)) {
            showToast('同じ名前のメンバーがいます');
          } else {
            member.name = newName;
            saveState();
            showToast('名前を変更しました');
          }
        }
        renderMembers();
        renderPayerSelect();
        renderSplitCheckboxes();
        renderExpenses();
        renderItinerary();
        renderItinEditList();
        renderChecklist();
      }
      input.addEventListener('blur', commitEdit);
      input.addEventListener('keydown', function(ev) {
        if (ev.key === 'Enter') { ev.preventDefault(); input.blur(); }
        if (ev.key === 'Escape') { input.value = oldName; input.blur(); }
      });
    }
  });

  // Member color picker change
  document.getElementById('member-list').addEventListener('input', function(e) {
    if (!e.target.matches('.member-color-picker')) return;
    const id = e.target.dataset.colorMember;
    const color = e.target.value;
    const m = state.members.find(m => m.id === id);
    if (m) {
      m.color = color;
      saveState();
      renderMembers();
      renderItinerary();
      renderItinFilter();
      renderItinEditList();
    }
  });

  // Expense form submit
  document.getElementById('form-expense').addEventListener('submit', function(e) {
    e.preventDefault();
    const editId = document.getElementById('expense-edit-id').value;
    const data = getExpenseFormData();
    if (editId) {
      if (updateExpense(Number(editId), data)) { resetExpenseForm(); renderExpenses(); showToast('支払いを更新しました'); }
    } else {
      if (addExpense(data)) { resetExpenseForm(); renderExpenses(); showToast('支払いを追加しました'); }
    }
  });

  // Expense list actions
  document.getElementById('expense-list').addEventListener('click', function(e) {
    // Show all / collapse toggle
    if (e.target.id === 'btn-exp-toggle') { expShowAll = !expShowAll; renderExpenses(); return; }
    const editBtn = e.target.closest('[data-edit-expense]');
    const deleteBtn = e.target.closest('[data-delete-expense]');
    if (editBtn) { startEditExpense(Number(editBtn.dataset.editExpense)); }
    else if (deleteBtn) {
      const id = Number(deleteBtn.dataset.deleteExpense);
      showModal('この支払い記録を削除しますか？', '削除する', function() { deleteExpense(id); renderExpenses(); closeModal(); showToast('支払いを削除しました'); });
    }
  });

  document.getElementById('btn-cancel-edit').addEventListener('click', resetExpenseForm);

  // Currency toggle
  document.getElementById('currency-toggle').addEventListener('click', function(e) {
    const btn = e.target.closest('.toggle-btn');
    if (!btn) return;
    currentCurrency = btn.dataset.currency;
    updateCurrencyToggle(this, currentCurrency, 'currency');
  });

  // Split member controls
  document.getElementById('btn-select-all').addEventListener('click', function() {
    document.querySelectorAll('#split-members input[type="checkbox"]').forEach(cb => cb.checked = true);
  });
  document.getElementById('btn-deselect-all').addEventListener('click', function() {
    document.querySelectorAll('#split-members input[type="checkbox"]').forEach(cb => cb.checked = false);
  });

  // Settlement currency toggle
  document.getElementById('settle-currency-toggle').addEventListener('click', function(e) {
    const btn = e.target.closest('.toggle-btn');
    if (!btn) return;
    state.settleCurrency = btn.dataset.settle;
    updateCurrencyToggle(this, state.settleCurrency, 'settle');
    saveState(); renderSettlement();
  });

  // Exchange rate
  document.getElementById('exchange-rate').addEventListener('input', function() {
    state.exchangeRate = Number(this.value) || 95;
    saveState(); renderSettlement();
  });

  // Itinerary form submit
  document.getElementById('form-itinerary').addEventListener('submit', function(e) {
    e.preventDefault();
    const editId = document.getElementById('itin-edit-id').value;
    const data = getItineraryFormData();
    if (editId) {
      if (updateItineraryEvent(Number(editId), data)) { resetItineraryForm(); renderItinerary(); renderItinEditList(); showToast('予定を更新しました'); }
    } else {
      if (addItineraryEvent(data)) { resetItineraryForm(); renderItinerary(); renderItinEditList(); showToast('予定を追加しました'); }
    }
  });

  document.getElementById('btn-cancel-itin-edit').addEventListener('click', resetItineraryForm);

  // Itinerary participant select all / deselect all
  document.getElementById('btn-itin-select-all').addEventListener('click', function() {
    document.querySelectorAll('#itin-participants input[type="checkbox"]').forEach(cb => cb.checked = true);
  });
  document.getElementById('btn-itin-deselect-all').addEventListener('click', function() {
    document.querySelectorAll('#itin-participants input[type="checkbox"]').forEach(cb => cb.checked = false);
  });

  // Itinerary filter (delegated)
  document.getElementById('itin-filter').addEventListener('click', function(e) {
    const btn = e.target.closest('.filter-btn');
    if (!btn) return;
    itinFilterMember = btn.dataset.filter;
    renderItinerary();
  });

  // Itinerary view: memo badge toggle + edit/delete from schedule tab
  document.getElementById('itinerary-list').addEventListener('click', function(e) {
    // Memo badge toggle
    const badge = e.target.closest('.itin-memo-badge');
    if (badge) {
      const id = badge.dataset.memoToggle;
      const memo = document.getElementById('itin-memo-' + id);
      if (memo) {
        memo.classList.toggle('open');
        badge.classList.toggle('open');
      }
      return;
    }

    // Edit from schedule view → open accordion and populate form
    const editBtn = e.target.closest('[data-view-edit-itin]');
    if (editBtn) {
      const id = Number(editBtn.dataset.viewEditItin);
      // Open the edit accordion if closed
      const editBody = document.getElementById('itin-edit-body');
      const editToggle = document.getElementById('itin-edit-toggle');
      if (!editBody.classList.contains('open')) {
        editBody.classList.add('open');
        editToggle.classList.add('open');
      }
      renderItinParticipants();
      // Populate form and scroll to it
      startEditItineraryEvent(id);
      return;
    }

    // Delete from schedule view
    const deleteBtn = e.target.closest('[data-view-delete-itin]');
    if (deleteBtn) {
      const id = Number(deleteBtn.dataset.viewDeleteItin);
      showModal('この予定を削除しますか？', '削除する', function() {
        deleteItineraryEvent(id);
        renderItinerary();
        renderItinEditList();
        closeModal();
        showToast('予定を削除しました');
      });
      return;
    }
  });

  // Itinerary edit list actions
  document.getElementById('itin-edit-list').addEventListener('click', function(e) {
    const editBtn = e.target.closest('[data-edit-itin]');
    const cloneBtn = e.target.closest('[data-clone-itin]');
    const deleteBtn = e.target.closest('[data-delete-itin]');
    if (editBtn) { startEditItineraryEvent(Number(editBtn.dataset.editItin)); }
    else if (cloneBtn) {
      const id = Number(cloneBtn.dataset.cloneItin);
      const src = state.itinerary.find(ev => ev.id === id);
      if (src) {
        const cloned = {
          date: src.date, time: src.time, endTime: src.endTime,
          title: src.title + '（コピー）', category: src.category,
          memo: src.memo, url: src.url, location: src.location,
          mapUrl: src.mapUrl, participants: [...(src.participants || [])]
        };
        if (addItineraryEvent(cloned)) {
          renderItinerary();
          renderItinEditList();
          showToast('予定を複製しました');
        }
      }
    }
    else if (deleteBtn) {
      const id = Number(deleteBtn.dataset.deleteItin);
      showModal('この予定を削除しますか？', '削除する', function() {
        deleteItineraryEvent(id);
        renderItinerary();
        renderItinEditList();
        closeModal();
        showToast('予定を削除しました');
      });
    }
  });

  // Modal
  document.getElementById('modal-confirm').addEventListener('click', function() { if (modalCallback) modalCallback(); });
  document.getElementById('modal-cancel').addEventListener('click', closeModal);
  document.getElementById('modal-overlay').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

  // Trip info form
  document.getElementById('form-trip-info').addEventListener('submit', function(e) {
    e.preventDefault();
    saveTripInfo();
  });

  // Map preview button
  document.getElementById('btn-map-preview').addEventListener('click', function() {
    const loc = document.getElementById('itin-location').value.trim();
    if (!loc) { showToast('場所名を入力してください'); return; }
    window.open(generateMapUrl(loc), '_blank', 'noopener');
  });

  // Export / Import
  document.getElementById('btn-export').addEventListener('click', handleExport);
  document.getElementById('btn-import').addEventListener('click', function() { document.getElementById('import-file').click(); });
  document.getElementById('import-file').addEventListener('change', handleImport);

  // Cloud sync button: タップ=クラウドから取得（クラウドが正）
  // 長押し=ローカルクリア＆クラウドから再取得
  {
    const syncBtn = document.getElementById('btn-sync');
    let pressTimer = null;
    let longPressed = false;
    syncBtn.addEventListener('pointerdown', function() {
      longPressed = false;
      pressTimer = setTimeout(async () => {
        longPressed = true;
        if (confirm('ローカルデータをクリアしてクラウドから再取得しますか？')) {
          localStorage.removeItem(APP_KEY);
          state = createDefaultState();
          showToast('クリア＆再取得中...');
          await syncFromCloud();
          showToast('クラウドから再取得完了！');
        }
      }, 1500);
    });
    syncBtn.addEventListener('pointerup', async function() {
      clearTimeout(pressTimer);
      if (!longPressed) {
        showToast('クラウドから取得中...');
        await syncFromCloud();
        showToast('クラウドから取得完了');
      }
    });
    syncBtn.addEventListener('pointerleave', function() { clearTimeout(pressTimer); });
  }

  // Cloud upload button: クラウドに保存（明示的操作のみ）
  document.getElementById('btn-cloud-upload').addEventListener('click', async function() {
    if (!confirm('現在のローカルデータをクラウド（Googleスプレッドシート）に保存しますか？\n\n⚠️ クラウドのデータが上書きされます。')) return;
    showToast('クラウドに保存中...');
    await syncToCloud();
    showToast('クラウドに保存完了！');
  });

  // Settings button → switch to settings tab
  document.getElementById('btn-cloud-settings').addEventListener('click', function() {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.tab-btn[data-tab="settings"]').classList.add('active');
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.getElementById('tab-settings').classList.add('active');
    renderMembers();
    updateSpreadsheetLink();
  });
  // GAS URL modal (開発者向け：スプレッドシートリンクを長押しで開く)
  document.getElementById('cloud-modal-cancel').addEventListener('click', function() {
    document.getElementById('cloud-modal-overlay').hidden = true;
  });
  document.getElementById('cloud-modal-overlay').addEventListener('click', function(e) {
    if (e.target === this) this.hidden = true;
  });

  // ===== Accordion toggles =====
  document.getElementById('itin-edit-toggle').addEventListener('click', function() {
    this.classList.toggle('open');
    document.getElementById('itin-edit-body').classList.toggle('open');
  });
  document.getElementById('cl-list-toggle').addEventListener('click', function() {
    this.classList.toggle('open');
    document.getElementById('cl-list-body').classList.toggle('open');
  });
  document.getElementById('money-list-toggle').addEventListener('click', function() {
    this.classList.toggle('open');
    document.getElementById('money-list-body').classList.toggle('open');
  });
  document.getElementById('money-settle-toggle').addEventListener('click', function() {
    this.classList.toggle('open');
    document.getElementById('money-settle-body').classList.toggle('open');
  });

  // ===== Feature 1: Checklist event listeners =====

  // Checklist category tabs
  document.getElementById('cl-cat-tabs').addEventListener('click', function(e) {
    const tab = e.target.closest('.cl-cat-tab');
    if (!tab) return;
    clFilterCat = tab.dataset.clCat;
    renderChecklist();
  });

  // Member filter (filter bar)
  document.getElementById('cl-member-filter').addEventListener('click', function(e) {
    const btn = e.target.closest('.cl-member-filter-btn');
    if (!btn) return;
    const val = btn.dataset.clMember;
    clFilterMember = val === 'all' ? 'all' : (isNaN(Number(val)) ? val : Number(val));
    renderChecklist();
  });

  // Member filter (progress badge tap)
  document.getElementById('cl-progress-summary').addEventListener('click', function(e) {
    const badge = e.target.closest('.cl-progress-member');
    if (!badge) return;
    const val = badge.dataset.clMember;
    if (!val) return;
    const mid = isNaN(Number(val)) ? val : Number(val);
    clFilterMember = clFilterMember === mid ? 'all' : mid;
    renderChecklist();
  });

  // Checklist: open/close add panel
  document.getElementById('cl-form-open-btn').addEventListener('click', function() {
    const panel = document.getElementById('cl-add-panel');
    panel.hidden = false;
    this.hidden = true;
    renderChecklistAddMembers();
    document.getElementById('cl-new-item').focus();
  });
  document.getElementById('cl-form-cancel-btn').addEventListener('click', function() {
    document.getElementById('cl-add-panel').hidden = true;
    document.getElementById('cl-form-open-btn').hidden = false;
    // Reset form
    document.getElementById('cl-new-item').value = '';
    document.getElementById('cl-cat-select').value = 'other';
    const addBtn = document.getElementById('cl-add-btn');
    addBtn.disabled = true;
    addBtn.classList.remove('enabled');
  });
  // Checklist add item
  document.getElementById('cl-add-btn').addEventListener('click', function() {
    const input = document.getElementById('cl-new-item');
    const catSelect = document.getElementById('cl-cat-select');
    if (addChecklistItem(input.value, catSelect.value)) {
      input.value = '';
      catSelect.value = 'other';
      this.disabled = true;
      this.classList.remove('enabled');
      renderChecklist();
      showToast('持ち物を追加しました ✓');
    } else {
      showToast('アイテム名を入力してください');
    }
  });
  document.getElementById('cl-new-item').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('cl-add-btn').click();
    }
  });
  // Auto-detect category on input + enable/disable add button
  document.getElementById('cl-new-item').addEventListener('input', function() {
    const text = this.value.trim();
    const addBtn = document.getElementById('cl-add-btn');
    if (text.length > 0) {
      document.getElementById('cl-cat-select').value = detectChecklistCategory(text);
      addBtn.disabled = false;
      addBtn.classList.add('enabled');
    } else {
      addBtn.disabled = true;
      addBtn.classList.remove('enabled');
    }
  });

  // Checklist toggle (member dot tap/click) & delete
  // Helper: handle dot toggle
  function handleDotToggle(dot) {
    if (!dot) return;
    const rawItemId = dot.dataset.clToggle;
    const memberId = dot.dataset.clMemberId;
    if (!rawItemId || !memberId) return;
    const itemId = isNaN(Number(rawItemId)) ? rawItemId : Number(rawItemId);
    toggleChecklistItem(itemId, memberId);
    const item = state.checklist.find(i => i.id === itemId);
    if (item) {
      const allDone = (item.members||[]).every(mid => item.checkedBy && item.checkedBy[String(mid)]);
      if (allDone) {
        showToast(`✅ 「${item.text}」全員完了！`);
      }
    }
    renderChecklist();
    renderHome();
  }

  // Use event delegation on checklist-list for both click and touchend
  var clList = document.getElementById('checklist-list');

  clList.addEventListener('click', function(e) {
    var dot = e.target.closest('.cl-member-dot');
    if (dot) { e.preventDefault(); e.stopPropagation(); handleDotToggle(dot); return; }
    var del = e.target.closest('[data-cl-delete]');
    if (del) { deleteChecklistItem(Number(del.dataset.clDelete)); renderChecklist(); }
  });

  // Also listen for touchend to catch mobile taps that don't fire click
  clList.addEventListener('touchend', function(e) {
    var dot = e.target.closest('.cl-member-dot');
    if (dot) {
      e.preventDefault();
      e.stopPropagation();
      handleDotToggle(dot);
    }
  }, { passive: false });

  // ===== Feature 2: Share schedule button =====
  document.getElementById('btn-share-schedule').addEventListener('click', shareSchedule);

  // ===== Feature 5: Template grid click =====
  document.getElementById('template-grid').addEventListener('click', function(e) {
    const card = e.target.closest('.tpl-card');
    if (!card) return;
    const idx = Number(card.dataset.tplIdx);
    applyTemplate(idx);
  });

}

/* ===== Fetch Live Exchange Rate ===== */
async function fetchExchangeRate() {
  const statusEl = document.getElementById('rate-status');
  statusEl.textContent = '最新レートを取得中...';
  statusEl.className = 'rate-status';
  const apis = [
    { url: 'https://api.exchangerate-api.com/v4/latest/AUD', parse: (data) => data.rates && data.rates.JPY },
    { url: 'https://open.er-api.com/v6/latest/AUD', parse: (data) => data.rates && data.rates.JPY }
  ];
  for (const api of apis) {
    try {
      const res = await fetch(api.url, { signal: AbortSignal.timeout(5000) });
      if (!res.ok) continue;
      const data = await res.json();
      const rate = api.parse(data);
      if (rate && rate > 0) {
        const rounded = Math.round(rate * 100) / 100;
        state.exchangeRate = rounded;
        document.getElementById('exchange-rate').value = rounded;
        saveState(); renderSettlement();
        const now = new Date();
        const timeStr = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');
        statusEl.textContent = `${timeStr} に最新レートを取得 (1 AUD = ${rounded} 円)`;
        statusEl.className = 'rate-status success';
        return;
      }
    } catch (e) { /* try next */ }
  }
  statusEl.textContent = '取得失敗 (オフライン？) - 手動で入力してください';
  statusEl.className = 'rate-status error';
}

/* ===== Init ===== */
function init() {
  loadState();

  // Restore weather coordinates from state to localStorage
  if (state.weatherLat && state.weatherLon) {
    localStorage.setItem('travel-app-weather-lat', state.weatherLat);
    localStorage.setItem('travel-app-weather-lon', state.weatherLon);
  }

  initEventListeners();
  document.getElementById('expense-date').value = getTodayString();
  document.getElementById('itin-date').value = getTodayString();
  renderAll();
  updateSpreadsheetLink();
  fetchExchangeRate();
  // Geocode destination if not yet done
  if (state.tripDestination && !state.weatherLat) {
    geocodeDestination(state.tripDestination);
  }
  // クラウド同期（設定済みなら）
  if (getGasUrl()) {
    syncFromCloud();
  } else {
    setSyncStatus('off');
    cloudSyncReady = true;
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
