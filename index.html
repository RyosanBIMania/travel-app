<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta name="version" content="2.0.0-5features">
<title>æ—…ã®ã—ãŠã‚Š</title>
<style>
/* ===== CSS Custom Properties â€” 2026 UX Refresh ===== */
/* Inspired by Apple Liquid Glass, Material You, modern soft-UI trends */
:root {
  --c-primary: #4466ce;
  --c-primary-light: #6b8df0;
  --c-primary-dark: #2c3a6e;
  --c-danger: #e5443a;
  --c-danger-dark: #c0362e;
  --c-success: #22c55e;
  --c-bg: #f0f2f5;
  --c-surface: rgba(255,255,255,0.78);
  --c-surface-solid: #ffffff;
  --c-text: #1a2233;
  --c-text2: #6d7a8a;
  --c-border: rgba(0,0,0,0.06);
  --c-jpy: #e5443a;
  --c-aud: #4466ce;
  --c-accent: #008db7;
  --sp-xs: 4px;
  --sp-sm: 8px;
  --sp-md: 16px;
  --sp-lg: 24px;
  --sp-xl: 32px;
  --font: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
  --fs-xs: 0.6875rem;
  --fs-sm: 0.8125rem;
  --fs-base: 0.9375rem;
  --fs-lg: 1.0625rem;
  --fs-xl: 1.25rem;
  --radius-xs: 8px;
  --radius-sm: 12px;
  --radius-md: 20px;
  --radius-lg: 28px;
  --radius-full: 9999px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.03), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 6px 18px -4px rgba(0,0,0,0.07), 0 2px 5px rgba(0,0,0,0.03);
  --shadow-lg: 0 12px 28px -6px rgba(0,0,0,0.10), 0 4px 10px rgba(0,0,0,0.03);
  --header-h: 56px;
  --tab-h: 64px;
  --max-w: 560px;
  --tap: 44px;
  --glass-blur: 18px;
  --t-fast: 0.18s cubic-bezier(0.4,0,0.2,1);
  --t-spring: 0.35s cubic-bezier(0.34,1.56,0.64,1);
  --t-smooth: 0.3s cubic-bezier(0.4,0,0.2,1);
}

/* ===== Reset & Base ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
body {
  font-family: var(--font);
  font-size: var(--fs-base);
  background: var(--c-bg);
  color: var(--c-text);
  padding-top: var(--header-h);
  padding-bottom: calc(var(--tab-h) + env(safe-area-inset-bottom, 0px));
  min-height: 100dvh;
  -webkit-tap-highlight-color: transparent;
  line-height: 1.55;
  -webkit-font-smoothing: antialiased;
}
input, select, button, textarea { font-family: inherit; font-size: inherit; }
a { color: var(--c-primary); text-decoration: none; }
a:hover { text-decoration: underline; }

/* ===== Header â€” frosted glass ===== */
.app-header {
  position: fixed; top: 0; left: 0; right: 0;
  height: var(--header-h);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 var(--sp-lg);
  background: linear-gradient(135deg, rgba(44,58,110,0.92) 0%, rgba(68,90,160,0.88) 100%);
  backdrop-filter: saturate(180%) blur(var(--glass-blur));
  -webkit-backdrop-filter: saturate(180%) blur(var(--glass-blur));
  color: #fff;
  z-index: 150;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 2px 16px -2px rgba(44,58,110,0.25);
}
.app-title {
  font-size: var(--fs-xl); font-weight: 800; letter-spacing: -0.01em;
  background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.8) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.header-actions { display: flex; align-items: center; gap: 8px; }
.icon-btn {
  width: 38px; height: 38px;
  display: flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  color: #fff; font-size: 1.1rem; cursor: pointer;
  transition: background var(--t-fast), transform var(--t-fast);
}
.icon-btn:hover { background: rgba(255,255,255,0.22); }
.icon-btn:active { transform: scale(0.92); }

/* ===== Tab Navigation â€” frosted glass ===== */
.tab-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  height: var(--tab-h);
  display: flex;
  background: rgba(255,255,255,0.72);
  backdrop-filter: saturate(180%) blur(var(--glass-blur));
  -webkit-backdrop-filter: saturate(180%) blur(var(--glass-blur));
  border-top: 1px solid rgba(0,0,0,0.05);
  padding-bottom: env(safe-area-inset-bottom, 0px);
  z-index: 100;
}
.tab-btn {
  flex: 1;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 3px;
  background: none; border: none;
  color: var(--c-text2);
  font-size: var(--fs-xs);
  cursor: pointer;
  transition: color var(--t-fast), transform var(--t-fast);
  position: relative;
  -webkit-tap-highlight-color: transparent;
  padding: 0 2px;
  font-weight: 500;
}
.tab-btn:active { transform: scale(0.93); }
.tab-btn.active { color: var(--c-primary); font-weight: 700; }
.tab-btn.active .tab-icon {
  background: rgba(68,102,206,0.12);
  border-radius: var(--radius-full);
  padding: 2px 12px;
}
.tab-btn::before {
  content: '';
  position: absolute; top: 0; left: 50%; transform: translateX(-50%) scaleX(0);
  width: 24px; height: 3px;
  background: var(--c-primary);
  border-radius: 0 0 3px 3px;
  transition: transform var(--t-spring);
}
.tab-btn.active::before { transform: translateX(-50%) scaleX(1); }
.tab-icon { font-size: 1.2rem; line-height: 1; transition: background var(--t-fast), padding var(--t-fast), transform var(--t-spring); padding: 2px 0; }
.tab-btn.active .tab-icon { transform: translateY(-1px); }

/* ===== Tab Content ===== */
.tab-content {
  display: none;
  max-width: var(--max-w);
  margin: 0 auto;
  padding: var(--sp-md);
  overflow-x: hidden;
  animation: fadeIn 0.25s ease;
}
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

/* ===== Card â€” glass surface ===== */
.card {
  background: var(--c-surface);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.5);
  border-radius: var(--radius-md);
  padding: var(--sp-lg);
  margin-bottom: var(--sp-md);
  box-shadow: var(--shadow-md);
  transition: box-shadow var(--t-smooth);
}
.card-title {
  font-size: var(--fs-lg);
  font-weight: 800;
  margin-bottom: var(--sp-md);
  display: flex; align-items: center; gap: var(--sp-sm);
  letter-spacing: -0.01em;
}
.card-desc { font-size: var(--fs-sm); color: var(--c-text2); margin-bottom: var(--sp-md); line-height: 1.5; }

/* ===== Forms â€” soft rounded ===== */
.form-input {
  width: 100%; max-width: 100%;
  min-height: var(--tap);
  padding: 10px 14px;
  border: 1.5px solid rgba(0,0,0,0.08);
  border-radius: var(--radius-sm);
  background: rgba(255,255,255,0.7);
  color: var(--c-text);
  transition: border-color var(--t-fast), box-shadow var(--t-fast), background var(--t-fast);
}
.form-input:focus {
  outline: none;
  border-color: var(--c-primary);
  box-shadow: 0 0 0 4px rgba(68,102,206,0.10);
  background: #fff;
}
.form-input::placeholder { color: #a0aab4; }
/* date/time inputs: Safari/WebKit overflow fix for all screen sizes */
input[type="date"].form-input,
input[type="time"].form-input {
  -webkit-appearance: none;
  appearance: none;
  min-width: 0;
  max-width: 100%;
}
textarea.form-input { min-height: 60px; resize: vertical; }
.inline-form { display: flex; gap: var(--sp-sm); }
.inline-form .form-input { flex: 1; }
.form-group { margin-bottom: var(--sp-md); }
.form-group > label {
  display: block; font-size: var(--fs-sm); font-weight: 600;
  color: var(--c-text2); margin-bottom: 6px;
  letter-spacing: 0.01em;
}
.form-row { display: flex; gap: var(--sp-md); align-items: flex-end; }
.form-row .form-group { margin-bottom: var(--sp-md); }
.flex-grow { flex: 1; min-width: 0; }
.form-actions { margin-top: var(--sp-md); display: flex; flex-direction: column; gap: var(--sp-sm); }

/* ===== Buttons â€” pill-shaped primary ===== */
.btn {
  display: inline-flex; align-items: center; justify-content: center;
  min-height: var(--tap);
  padding: 10px var(--sp-lg);
  border: none; border-radius: var(--radius-sm);
  font-weight: 700; cursor: pointer;
  transition: background var(--t-fast), transform 0.12s, box-shadow var(--t-fast);
  white-space: nowrap;
  letter-spacing: 0.01em;
}
.btn:active { transform: scale(0.96); }
.btn-primary {
  background: linear-gradient(135deg, var(--c-primary) 0%, var(--c-primary-light) 100%);
  color: #fff;
  box-shadow: 0 4px 12px -2px rgba(68,102,206,0.35);
}
.btn-primary:hover { box-shadow: 0 6px 16px -2px rgba(68,102,206,0.45); }
.btn-secondary { background: rgba(0,0,0,0.05); color: var(--c-text); border: 1px solid rgba(0,0,0,0.08); }
.btn-secondary:hover { background: rgba(0,0,0,0.08); }
.btn-danger {
  background: linear-gradient(135deg, var(--c-danger) 0%, #f06050 100%);
  color: #fff;
  box-shadow: 0 4px 12px -2px rgba(229,68,58,0.3);
}
.btn-danger:hover { box-shadow: 0 6px 16px -2px rgba(229,68,58,0.4); }
.btn-block { width: 100%; }
.btn-sm {
  min-height: 32px; padding: 6px 12px;
  font-size: var(--fs-sm); border-radius: var(--radius-xs);
  background: rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.06);
  cursor: pointer; font-weight: 600;
  transition: background var(--t-fast), transform 0.1s;
}
.btn-sm:hover { background: rgba(0,0,0,0.07); }
.btn-sm:active { transform: scale(0.96); }
.btn-icon-sm {
  width: 34px; height: 34px;
  display: inline-flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.06);
  border-radius: var(--radius-xs);
  cursor: pointer; font-size: 0.9rem; color: var(--c-text2);
  transition: background var(--t-fast), transform 0.1s, color var(--t-fast), border-color var(--t-fast);
}
.btn-icon-sm:hover { background: rgba(0,0,0,0.06); }
.btn-icon-sm:active { transform: scale(0.9); }
.btn-icon-sm.danger:hover { background: #fef2f2; color: var(--c-danger); border-color: var(--c-danger); }

/* ===== Currency Toggle â€” pill style ===== */
.currency-toggle {
  display: inline-flex;
  border-radius: var(--radius-sm);
  overflow: hidden;
  border: 2px solid rgba(0,0,0,0.06);
  background: rgba(0,0,0,0.03);
}
.toggle-btn {
  padding: 10px var(--sp-md);
  min-height: var(--tap);
  border: none;
  background: transparent;
  font-weight: 700;
  cursor: pointer;
  transition: background var(--t-fast), color var(--t-fast), transform 0.1s;
  font-size: var(--fs-base);
}
.toggle-btn:active { transform: scale(0.95); }
.toggle-btn.active-jpy { background: var(--c-jpy); color: #fff; border-radius: var(--radius-xs); }
.toggle-btn.active-aud { background: var(--c-aud); color: #fff; border-radius: var(--radius-xs); }

/* ===== Checkbox Grid â€” soft chips ===== */
.split-controls { display: flex; gap: var(--sp-sm); margin-bottom: var(--sp-sm); }
.checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: var(--sp-sm);
}
.checkbox-grid label {
  display: flex; align-items: center; gap: var(--sp-sm);
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  background: rgba(0,0,0,0.03);
  border: 1.5px solid transparent;
  min-height: var(--tap);
  cursor: pointer;
  font-weight: 600;
  transition: background var(--t-fast), border-color var(--t-fast), transform 0.1s;
}
.checkbox-grid label:active { transform: scale(0.97); }
.checkbox-grid label:has(input:checked) {
  background: rgba(68,102,206,0.08);
  border-color: rgba(68,102,206,0.3);
}
.checkbox-grid input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--c-primary); cursor: pointer; border-radius: 4px; }

/* ===== Item Lists ===== */
.item-list { list-style: none; }
.list-item {
  display: flex; align-items: center; gap: var(--sp-sm);
  padding: 14px 0;
  border-bottom: 1px solid rgba(0,0,0,0.04);
  transition: background var(--t-fast);
}
.list-item:last-child { border-bottom: none; }
.member-name { font-weight: 700; flex: 1; cursor:pointer; border-bottom:1px dashed transparent; transition:border-color var(--t-fast); }
.member-name:hover { border-bottom-color:rgba(0,0,0,0.2); }
.member-name-edit { flex:1; font-size:var(--fs-sm); font-weight:700; padding:2px 6px; border:1.5px solid var(--c-primary); border-radius:var(--radius-xs); outline:none; min-width:0; }
.member-color-dot {
  width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  transition: transform var(--t-fast), box-shadow var(--t-fast);
}
.list-item:hover .member-color-dot { transform: scale(1.2); }
.member-color-picker {
  width: 30px; height: 30px; border: none; padding: 0;
  border-radius: var(--radius-xs); cursor: pointer; background: none;
}
.member-badge {
  display: inline-block; padding: 3px 10px; border-radius: var(--radius-full);
  font-size: 0.7rem; font-weight: 700; color: #fff; margin-right: 4px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.12);
}
.empty-msg { text-align: center; color: var(--c-text2); padding: var(--sp-xl) 0; font-size: var(--fs-sm); }

/* ===== Expense Items ===== */
.expense-item {
  padding: 14px 0;
  border-bottom: 1px solid rgba(0,0,0,0.04);
  transition: background var(--t-fast);
}
.expense-item:last-child { border-bottom: none; }
.exp-show-all-btn { display:block; width:100%; padding:10px; margin-top:var(--sp-sm); background:rgba(68,102,206,0.06); color:var(--c-primary); border:none; border-radius:var(--radius-sm); font-size:var(--fs-sm); font-weight:700; cursor:pointer; transition:background var(--t-fast); }
.exp-show-all-btn:hover { background:rgba(68,102,206,0.12); }
.expense-top { display: flex; align-items: flex-start; justify-content: space-between; gap: var(--sp-sm); }
.expense-info { flex: 1; min-width: 0; }
.expense-memo { font-weight: 700; word-break: break-word; }
.expense-detail { font-size: var(--fs-sm); color: var(--c-text2); margin-top: 3px; }
.expense-right { text-align: right; flex-shrink: 0; }
.expense-amount { font-size: var(--fs-lg); font-weight: 800; letter-spacing: -0.02em; }
.expense-amount.jpy { color: var(--c-jpy); }
.expense-amount.aud { color: var(--c-aud); }
.expense-date { font-size: var(--fs-sm); color: var(--c-text2); }
.expense-actions { display: flex; gap: 6px; margin-top: var(--sp-sm); justify-content: flex-end; }
.summary-bar {
  background: rgba(68,102,206,0.06); border-radius: var(--radius-sm);
  padding: 10px var(--sp-md);
  margin-bottom: var(--sp-md);
  font-size: var(--fs-sm); font-weight: 700;
  text-align: center;
}
.summary-bar:empty { display: none; }

/* ===== Settlement â€” soft cards ===== */
.exchange-rate-form {
  display: flex; align-items: center; gap: var(--sp-sm);
  font-weight: 700;
}
.exchange-rate-form .form-input { width: 100px; text-align: center; }
.rate-status { font-size: var(--fs-sm); color: var(--c-text2); margin-top: var(--sp-sm); }
.rate-status.success { color: var(--c-success); }
.rate-status.error { color: var(--c-danger); }
.settlement-currency { margin-top: var(--sp-sm); }
.balance-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid rgba(0,0,0,0.04);
}
.balance-item:last-child { border-bottom: none; }
.balance-name { font-weight: 700; }
.balance-amount { font-weight: 800; font-size: var(--fs-lg); letter-spacing: -0.02em; }
.balance-amount.positive { color: var(--c-success); }
.balance-amount.negative { color: var(--c-danger); }
.settlement-item {
  display: flex; align-items: center;
  padding: 14px var(--sp-md);
  margin-bottom: var(--sp-sm);
  background: rgba(68,102,206,0.05);
  border-radius: var(--radius-sm);
  border-left: 4px solid var(--c-primary);
  gap: var(--sp-sm);
  flex-wrap: wrap;
  transition: background var(--t-fast);
}
.settlement-from, .settlement-to { font-weight: 700; }
.settlement-arrow { color: var(--c-text2); font-size: 1.2rem; }
.settlement-amount { margin-left: auto; font-weight: 800; color: var(--c-primary); font-size: var(--fs-lg); }

/* ===== Itinerary (ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«) â€” refined timeline ===== */
.itin-day-group { margin-bottom: var(--sp-lg); }
.itin-day-header {
  display: flex; align-items: center; gap: var(--sp-sm);
  padding: 10px var(--sp-md);
  background: linear-gradient(135deg, var(--c-primary) 0%, var(--c-primary-light) 100%);
  color: #fff;
  border-radius: var(--radius-sm);
  font-weight: 800;
  font-size: var(--fs-base);
  margin-bottom: var(--sp-sm);
  position: sticky; top: var(--header-h); z-index: 10;
  box-shadow: 0 4px 12px -3px rgba(68,102,206,0.3);
  letter-spacing: -0.01em;
}
.itin-day-header.today {
  background: linear-gradient(135deg, var(--c-success) 0%, #34d399 100%);
  box-shadow: 0 4px 12px -3px rgba(34,197,94,0.3);
}
.itin-day-label { font-size: var(--fs-sm); font-weight: 500; opacity: 0.9; margin-left: auto; }
.itin-timeline { position: relative; padding-left: 38px; }
.itin-timeline::before {
  content: '';
  position: absolute; left: 15px; top: 0; bottom: 0;
  width: 2px; background: rgba(0,0,0,0.06);
  border-radius: 1px;
}
.itin-event {
  position: relative;
  background: var(--c-surface);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.4);
  border-radius: var(--radius-md);
  padding: var(--sp-md);
  margin-bottom: 10px;
  box-shadow: var(--shadow-sm);
  border-left: 4px solid rgba(0,0,0,0.06);
  transition: box-shadow var(--t-smooth), transform var(--t-smooth);
}
.itin-event:active { transform: scale(0.99); }
.itin-event.next-up {
  border-left-color: var(--c-success);
  box-shadow: 0 0 0 2px rgba(34,197,94,0.15), var(--shadow-md);
}
.itin-event-dot {
  position: absolute;
  left: -30px; top: 16px;
  width: 26px; height: 26px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.8rem;
  background: var(--c-surface-solid);
  border: 2.5px solid rgba(0,0,0,0.08);
  border-radius: 50%;
  z-index: 1;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  transition: border-color var(--t-fast), box-shadow var(--t-fast);
}
.itin-event.next-up .itin-event-dot { border-color: var(--c-success); box-shadow: 0 0 0 3px rgba(34,197,94,0.15); }
.itin-event-cat-flight { border-left-color: #3b82f6; }
.itin-event-cat-flight .itin-event-dot { border-color: #3b82f6; }
.itin-event-cat-hotel { border-left-color: #a855f7; }
.itin-event-cat-hotel .itin-event-dot { border-color: #a855f7; }
.itin-event-cat-sightseeing { border-left-color: #f59e0b; }
.itin-event-cat-sightseeing .itin-event-dot { border-color: #f59e0b; }
.itin-event-cat-food { border-left-color: #ef4444; }
.itin-event-cat-food .itin-event-dot { border-color: #ef4444; }
.itin-event-cat-transport { border-left-color: #06b6d4; }
.itin-event-cat-transport .itin-event-dot { border-color: #06b6d4; }
.itin-event-cat-other { border-left-color: var(--c-text2); }
.itin-event-cat-other .itin-event-dot { border-color: var(--c-text2); }
.itin-event-top { display: flex; align-items: flex-start; gap: var(--sp-sm); }
.itin-event-body { flex: 1; min-width: 0; }
.itin-event-time { font-size: var(--fs-sm); color: var(--c-text2); font-weight: 700; }
.itin-event-title { font-weight: 800; margin-top: 3px; word-break: break-word; letter-spacing: -0.01em; }
.itin-event-location { font-size: var(--fs-sm); color: var(--c-text2); margin-top: 3px; }
.itin-event-participants { font-size: 0.75rem; color: var(--c-primary); margin-top: 6px; display: flex; align-items: center; flex-wrap: wrap; gap: 3px; }
.itin-event-memo {
  font-size: var(--fs-sm); color: var(--c-text2); margin-top: var(--sp-sm);
  white-space: pre-wrap; word-break: break-word;
  background: rgba(68,102,206,0.04); border-radius: var(--radius-sm);
  padding: 10px 14px;
  display: none; border-left: 3px solid var(--c-primary);
  animation: fadeIn 0.2s ease;
}
.itin-event-memo.open { display: block; }
.itin-memo-badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 6px 10px;
  background: rgba(68,102,206,0.06); border-radius: var(--radius-xs);
  font-size: var(--fs-sm); font-weight: 600;
  color: var(--c-primary); cursor: pointer; min-height: 32px;
  user-select: none; transition: background var(--t-fast), transform 0.1s;
}
.itin-memo-badge:hover { background: rgba(68,102,206,0.1); }
.itin-memo-badge:active { transform: scale(0.96); }
.itin-memo-badge.open { background: rgba(68,102,206,0.12); }
.itin-event-links { display: flex; gap: var(--sp-sm); margin-top: var(--sp-sm); flex-wrap: wrap; }
.itin-link {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 6px 10px;
  background: rgba(68,102,206,0.06);
  border-radius: var(--radius-xs);
  font-size: var(--fs-sm); font-weight: 600;
  color: var(--c-primary);
  text-decoration: none;
  min-height: 32px;
  transition: background var(--t-fast), transform 0.1s;
}
.itin-link:hover { background: rgba(68,102,206,0.1); text-decoration: none; }
.itin-link:active { transform: scale(0.96); }
.itin-event-actions { display: flex; gap: 6px; margin-top: var(--sp-sm); justify-content: flex-end; }
@keyframes badgePulse {
  0%, 100% { box-shadow: 0 2px 6px rgba(34,197,94,0.25); }
  50% { box-shadow: 0 2px 12px rgba(34,197,94,0.45); }
}
.next-badge {
  display: inline-block;
  background: linear-gradient(135deg, var(--c-success) 0%, #34d399 100%);
  color: #fff;
  font-size: 0.65rem; font-weight: 800;
  padding: 3px 10px; border-radius: var(--radius-full);
  animation: badgePulse 2s ease-in-out infinite;
  margin-left: var(--sp-sm);
  box-shadow: 0 2px 6px rgba(34,197,94,0.25);
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

/* ===== Itinerary Filter â€” pill chips ===== */
.itin-filter {
  display: flex; gap: 8px; margin-bottom: var(--sp-md);
  flex-wrap: wrap;
}
.filter-btn {
  padding: 6px 14px; border-radius: var(--radius-full);
  border: 1.5px solid rgba(0,0,0,0.08); background: rgba(255,255,255,0.6);
  font-size: var(--fs-sm); font-weight: 600; cursor: pointer;
  transition: background var(--t-fast), border-color var(--t-fast), transform 0.1s, box-shadow var(--t-fast);
}
.filter-btn:hover { background: rgba(255,255,255,0.9); }
.filter-btn:active { transform: scale(0.95); }
.filter-btn.active {
  font-weight: 800;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

/* ===== Sync Dot (inside button) ===== */
.sync-dot {
  position: absolute; top: 3px; right: 3px;
  width: 9px; height: 9px;
  border-radius: 50%;
  background: #64748b;
  border: 2px solid rgba(255,255,255,0.9);
  transition: background 0.3s;
  pointer-events: none;
}
.sync-dot.synced { background: #22c55e; }
.sync-dot.syncing { background: #f59e0b; animation: pulse 1s infinite; }
.sync-dot.error { background: #ef4444; }
.sync-dot.off { background: #94a3b8; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
@keyframes spin { to { transform: rotate(360deg); } }
.icon-btn.syncing { animation: spin 1s linear infinite; }

/* ===== Modal â€” glass card ===== */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  display: flex; align-items: center; justify-content: center;
  z-index: 200;
  padding: var(--sp-md);
  animation: fadeIn 0.2s ease;
}
.modal-overlay[hidden] { display: none !important; }
.modal {
  background: var(--c-surface-solid);
  border-radius: var(--radius-lg);
  padding: var(--sp-xl);
  max-width: 360px; width: 100%;
  box-shadow: var(--shadow-lg);
  max-height: calc(100vh - 40px);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  animation: modalPop 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes modalPop { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
.modal-message { font-size: var(--fs-base); font-weight: 600; margin-bottom: var(--sp-lg); line-height: 1.5; }
.modal-actions { display: flex; gap: var(--sp-sm); justify-content: flex-end; }

/* ===== Toast â€” pill with shadow ===== */
.toast {
  position: fixed;
  bottom: calc(var(--tab-h) + var(--sp-lg) + env(safe-area-inset-bottom, 0px));
  left: 50%; transform: translateX(-50%) translateY(20px);
  opacity: 0;
  background: rgba(26,34,51,0.9);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  color: #fff;
  padding: 10px var(--sp-lg);
  border-radius: var(--radius-full);
  font-size: var(--fs-sm); font-weight: 600;
  transition: opacity 0.3s, transform var(--t-spring);
  z-index: 300;
  pointer-events: none;
  white-space: nowrap;
  box-shadow: var(--shadow-lg);
}
.toast[hidden] { display: none; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ===== Mobile compact ===== */
@media (max-width: 480px) {
  :root {
    --sp-sm: 6px;
    --sp-md: 10px;
    --sp-lg: 14px;
    --sp-xl: 20px;
    --tap: 38px;
    --header-h: 48px;
    --tab-h: 52px;
    --fs-sm: 0.75rem;
    --fs-base: 0.8125rem;
    --fs-lg: 0.9375rem;
    --fs-xl: 1.0625rem;
    --radius-sm: 10px;
    --radius-md: 16px;
    --radius-lg: 24px;
  }
  body { font-size: 0.8125rem; }
  .tab-content { padding: 8px; }
  .card { padding: 14px; margin-bottom: 10px; overflow: hidden; }
  .card-title { font-size: 0.9rem; margin-bottom: 10px; }
  .card-desc { font-size: 0.7rem; margin-bottom: 8px; }
  .form-group { margin-bottom: 10px; }
  .form-group > label { font-size: 0.7rem; margin-bottom: 3px; }
  .form-input { min-height: 36px; padding: 7px 10px; font-size: 0.8rem; }
  input[type="date"].form-input,
  input[type="time"].form-input {
    padding: 7px 6px; font-size: 0.75rem;
    -webkit-appearance: none; appearance: none;
    min-width: 0 !important; max-width: 100% !important;
  }
  textarea.form-input { min-height: 48px; }
  .form-row { gap: 6px; }
  .form-row .form-group { margin-bottom: 10px; overflow: hidden; }
  .card > form, .card form { width: 100%; overflow: hidden; }
  .form-actions { margin-top: 10px; gap: 6px; }
  .btn { min-height: 36px; padding: 7px 14px; font-size: 0.8rem; }
  .btn-sm { min-height: 30px; padding: 4px 10px; font-size: 0.7rem; }
  .btn-icon-sm { width: 30px; height: 30px; font-size: 0.8rem; }
  .inline-form { gap: 6px; }
  .inline-form .btn { padding: 7px 14px; }
  .app-title { font-size: 1rem; }
  .icon-btn { width: 34px; height: 34px; font-size: 1rem; }
  .tab-btn { font-size: 0.6rem; }
  .tab-icon { font-size: 1.1rem; }
  .expense-item { padding: 10px 0; }
  .expense-memo { font-size: 0.8rem; }
  .expense-detail { font-size: 0.7rem; }
  .empty-msg { font-size: 0.8rem; padding: 20px 8px; }
  .item-list li { padding: 10px 0; }
  .modal { padding: 20px; border-radius: var(--radius-lg); }
  .modal-message { font-size: 0.85rem; }
  .itin-event { border-radius: var(--radius-sm); padding: 12px; }
  .itin-day-header { border-radius: var(--radius-xs); }
}

/* ===== Focus accessibility â€” soft glow ===== */
:focus-visible {
  outline: 2px solid var(--c-primary);
  outline-offset: 2px;
  border-radius: var(--radius-xs);
}
.btn:focus-visible, .btn-sm:focus-visible, .btn-icon-sm:focus-visible, .icon-btn:focus-visible {
  box-shadow: 0 0 0 3px rgba(68,102,206,0.25);
}

/* ===== Smooth entry for list items ===== */
@keyframes slideUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
.expense-item, .list-item, .balance-item, .settlement-item {
  animation: slideUp 0.3s ease both;
}
.itin-event {
  animation: slideUp 0.35s ease both;
}
.itin-day-group:nth-child(1) .itin-event:nth-child(1) { animation-delay: 0s; }
.itin-day-group:nth-child(1) .itin-event:nth-child(2) { animation-delay: 0.04s; }
.itin-day-group:nth-child(1) .itin-event:nth-child(3) { animation-delay: 0.08s; }
.itin-day-group:nth-child(1) .itin-event:nth-child(4) { animation-delay: 0.12s; }
.itin-day-group:nth-child(1) .itin-event:nth-child(5) { animation-delay: 0.16s; }

/* ===== Hover lift for cards (touch devices no-op) ===== */
@media (hover: hover) {
  .itin-event:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }
  .expense-item:hover {
    background: rgba(68,102,206,0.02);
    border-radius: var(--radius-sm);
  }
  .list-item:hover { background: rgba(0,0,0,0.015); }
  .settlement-item:hover { background: rgba(68,102,206,0.08); }
  .balance-item:hover { background: rgba(0,0,0,0.015); }
}

/* ===== Selection colors ===== */
::selection { background: rgba(68,102,206,0.18); color: inherit; }

/* ===== Scrollbar â€” thin & subtle ===== */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }

/* ===== Empty state illustration ===== */
.empty-msg {
  position: relative;
  padding: var(--sp-xl) var(--sp-md);
}
.empty-msg::before {
  content: '';
  display: block;
  width: 48px; height: 48px;
  margin: 0 auto 12px;
  background: rgba(68,102,206,0.06);
  border-radius: 50%;
}

/* ===== Card title emoji spacing ===== */
.card-title > :first-child { margin-right: 2px; }

/* ===== Day header shimmer for today ===== */
@keyframes todayShimmer {
  0% { background-position: -200% center; }
  100% { background-position: 200% center; }
}
.itin-day-header.today {
  background-size: 200% 100%;
  background-image: linear-gradient(
    90deg,
    #22c55e 0%, #34d399 25%, #6ee7b7 50%, #34d399 75%, #22c55e 100%
  );
  animation: todayShimmer 6s linear infinite;
}

/* ===== Settlement arrow animation ===== */
.settlement-arrow {
  transition: transform var(--t-fast);
}
@media (hover: hover) {
  .settlement-item:hover .settlement-arrow {
    transform: translateX(3px);
  }
}

/* ===== Improved toggle button transitions ===== */
.toggle-btn {
  position: relative;
  overflow: hidden;
}
.toggle-btn::after {
  content: '';
  position: absolute; inset: 0;
  background: rgba(255,255,255,0.15);
  transform: translateX(-100%);
  transition: transform 0.3s ease;
}
.toggle-btn:hover::after {
  transform: translateX(0);
}

/* ===== Checkbox smooth check ===== */
.checkbox-grid input[type="checkbox"] {
  transition: transform 0.15s ease;
}
.checkbox-grid input[type="checkbox"]:checked {
  transform: scale(1.1);
}

/* ===== Desktop ===== */
@media (min-width: 768px) {
  .tab-nav {
    position: static;
    border-top: none;
    border-bottom: 1px solid var(--c-border);
    max-width: var(--max-w);
    margin: 0 auto;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    background: var(--c-surface-solid);
  }
  body { padding-bottom: var(--sp-xl); }
  .toast { bottom: var(--sp-xl); }
  .tab-btn.active::after { top: auto; bottom: 0; border-radius: 3px 3px 0 0; }
  .tab-btn { font-size: var(--fs-sm); }
  .tab-icon { font-size: 1.1rem; }
  .card:hover { box-shadow: var(--shadow-lg); }
}

/* ===== Reduced motion ===== */
/* ===== Accordion (generic toggle) ===== */
.accordion-toggle { display:flex; align-items:center; gap:var(--sp-sm); cursor:pointer; padding:var(--sp-sm) 0; font-weight:600; color:var(--c-text); user-select:none; }
.accordion-toggle .arrow { transition:transform var(--t-fast); font-size:0.7em; }
.accordion-toggle.open .arrow { transform:rotate(90deg); }
.accordion-body { display:none; }
.accordion-body.open { display:block; }

/* ===== Checklist ===== */
.checklist-section { margin-top: var(--sp-md); }
.checklist-progress-bar { height:4px; background:rgba(0,0,0,0.06); border-radius:2px; margin-bottom:var(--sp-sm); overflow:hidden; }
.checklist-progress-fill { height:100%; background:linear-gradient(90deg, var(--c-success) 0%, #34d399 100%); border-radius:2px; transition:width var(--t-smooth); }
#tab-checklist .checklist-body { display:block; }
.checklist-add { display:flex; gap:var(--sp-sm); margin-bottom:var(--sp-sm); }
.checklist-add input { flex:1; min-height:36px; padding:6px 12px; border:1.5px solid rgba(0,0,0,0.08); border-radius:var(--radius-sm); background:rgba(255,255,255,0.7); font-size:var(--fs-sm); }
.checklist-add button { min-height:36px; padding:6px 14px; }
.cl-cat-tabs { display:flex; gap:4px; margin-bottom:var(--sp-sm); flex-wrap:wrap; }
.cl-cat-tab { padding:4px 10px; border-radius:var(--radius-full); border:1px solid rgba(0,0,0,0.08); background:rgba(0,0,0,0.03); font-size:var(--fs-xs); cursor:pointer; transition:background var(--t-fast); }
.cl-cat-tab.active { background:var(--c-primary); color:#fff; border-color:var(--c-primary); }
/* Member filter row */
.cl-member-filter { display:flex; gap:4px; margin-bottom:var(--sp-sm); flex-wrap:wrap; align-items:center; }
.cl-member-filter-btn { padding:5px 12px; border-radius:var(--radius-full); font-size:var(--fs-xs); cursor:pointer; transition:all var(--t-fast); color:#fff; font-weight:600; opacity:0.5; border:none; -webkit-tap-highlight-color:transparent; }
.cl-member-filter-btn.active { opacity:1; box-shadow:0 1px 4px rgba(0,0,0,0.15); }
/* Progress summary */
.cl-progress-summary { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:var(--sp-sm); align-items:center; }
.cl-progress-overall { font-size:var(--fs-sm); color:var(--c-text2); margin-right:auto; }
.cl-progress-member { display:inline-flex; align-items:center; gap:3px; padding:2px 8px; border-radius:var(--radius-full); font-size:var(--fs-xs); font-weight:600; color:#fff; opacity:0.75; cursor:pointer; -webkit-tap-highlight-color:transparent; }
.cl-progress-member.done { opacity:1; }
.cl-progress-member.filter-active { opacity:1; box-shadow:0 0 0 2px #fff, 0 0 0 4px currentColor; }
.cl-progress-member .cl-pm-count { font-weight:400; opacity:0.85; }
/* Add form meta (category + member select) */
.cl-add-meta { display:flex; flex-direction:column; gap:6px; padding:8px 0 4px; animation:cl-slide-down 0.2s ease; }
.cl-add-meta[hidden] { display:none; }
@keyframes cl-slide-down { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }
.cl-auto-cat { display:flex; align-items:center; gap:6px; }
.cl-auto-cat-label, .cl-add-members-label { font-size:var(--fs-xs); color:var(--c-text2); flex-shrink:0; }
.cl-cat-select { padding:4px 8px; border:1px solid rgba(0,0,0,0.1); border-radius:var(--radius-sm); font-size:var(--fs-xs); background:rgba(255,255,255,0.8); min-height:30px; }
.cl-add-member-checks { display:flex; flex-wrap:wrap; gap:4px; }
.cl-add-member-checks label { display:inline-flex; align-items:center; gap:3px; padding:3px 8px; border-radius:var(--radius-full); font-size:var(--fs-xs); background:rgba(0,0,0,0.04); cursor:pointer; }
.cl-add-member-checks input[type=checkbox] { width:16px; height:16px; accent-color:var(--c-success); }
/* Item v2 layout (2-row: main + member dots) */
.cl-item { display:flex; flex-direction:column; gap:4px; padding:8px 4px; border-bottom:1px solid rgba(0,0,0,0.04); }
.cl-item:last-child { border-bottom:none; }
.cl-item-main { display:flex; align-items:center; gap:var(--sp-sm); }
.cl-item .cl-text { flex:1; font-size:var(--fs-sm); transition:opacity var(--t-fast); }
.cl-item.cl-complete .cl-text { text-decoration:line-through; opacity:0.45; }
.cl-cat-badge { font-size:0.6rem; padding:1px 6px; border-radius:var(--radius-full); background:rgba(0,0,0,0.05); color:var(--c-text2); white-space:nowrap; flex-shrink:0; }
.cl-item .cl-del { width:24px; height:24px; border:none; background:none; color:var(--c-text2); cursor:pointer; font-size:0.8rem; opacity:0.5; flex-shrink:0; }
.cl-item .cl-del:hover { opacity:1; color:var(--c-danger); }
/* Member dot buttons */
.cl-member-checks { display:flex; gap:4px; padding-left:2px; flex-wrap:wrap; }
.cl-member-dot { width:28px; height:28px; border-radius:50%; border:2px solid rgba(255,255,255,0.6); display:flex; align-items:center; justify-content:center; font-size:0.65rem; font-weight:700; color:#fff; cursor:pointer; transition:all var(--t-fast); opacity:0.35; position:relative; -webkit-tap-highlight-color:transparent; padding:0; }
.cl-member-dot.checked { opacity:1; box-shadow:0 1px 4px rgba(0,0,0,0.2); }
.cl-member-dot .cl-dot-check { display:none; font-size:0.75rem; }
.cl-member-dot.checked .cl-dot-check { display:block; }
.cl-member-dot.checked .cl-dot-initial { display:none; }
.cl-member-dot:active { transform:scale(0.9); }

/* ===== Share / Copy Button ===== */
.btn-share { display:inline-flex; align-items:center; gap:4px; padding:6px 14px; border-radius:var(--radius-full); background:rgba(0,0,0,0.05); border:1px solid rgba(0,0,0,0.08); font-size:var(--fs-sm); cursor:pointer; color:var(--c-text); transition:background var(--t-fast); }
.btn-share:active { background:rgba(0,0,0,0.12); }

/* ===== Dashboard (spending chart) ===== */
.dashboard-grid { display:grid; grid-template-columns:1fr 1fr; gap:var(--sp-sm); margin-bottom:var(--sp-md); }
.dash-stat { text-align:center; padding:var(--sp-md); background:rgba(0,0,0,0.02); border-radius:var(--radius-sm); border:1px solid rgba(0,0,0,0.04); }
.dash-stat .dash-val { font-size:var(--fs-xl); font-weight:800; color:var(--c-primary); }
.dash-stat .dash-label { font-size:var(--fs-xs); color:var(--c-text2); margin-top:2px; }
.dash-section-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
.dash-section-title { font-size:var(--fs-sm); font-weight:600; margin:0; }
.dash-currency-toggle { display:flex; gap:2px; background:rgba(0,0,0,0.05); border-radius:var(--radius-full); padding:2px; flex-shrink:0; }
.dash-cur-btn { border:none; background:transparent; padding:2px 8px; border-radius:var(--radius-full); font-size:var(--fs-xs); font-weight:600; cursor:pointer; color:var(--c-text2); transition:all var(--t-fast); }
.dash-cur-btn.active { background:#fff; color:var(--c-primary); box-shadow:0 1px 3px rgba(0,0,0,0.1); }
.cat-bar-list { display:flex; flex-direction:column; gap:6px; }
.cat-bar-row { display:flex; align-items:center; gap:6px; font-size:var(--fs-sm); }
.cat-bar-label { width:60px; text-align:right; flex-shrink:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:var(--fs-xs); }
.cat-bar-track { flex:1; height:16px; background:rgba(0,0,0,0.04); border-radius:8px; overflow:hidden; min-width:40px; }
.cat-bar-fill { height:100%; border-radius:8px; transition:width var(--t-smooth); }
.cat-bar-val { width:70px; font-size:var(--fs-xs); color:var(--c-text2); flex-shrink:0; text-align:right; }
/* Stacked daily chart */
.daily-chart-stacked { display:flex; align-items:flex-end; gap:2px; margin-top:var(--sp-sm); padding-bottom:20px; padding-top:18px; position:relative; overflow:visible; }
.daily-col { flex:1; min-width:0; display:flex; flex-direction:column-reverse; align-items:stretch; position:relative; height:100%; justify-content:flex-start; }
.daily-seg { min-height:0; border-radius:0; transition:height var(--t-smooth); position:relative; }
.daily-col .daily-seg:last-child { border-radius:3px 3px 0 0; }
.daily-col .daily-seg:first-child { border-radius:0 0 3px 3px; }
.daily-col .daily-seg:only-child { border-radius:3px; }
.daily-col-label { position:absolute; bottom:-18px; left:50%; transform:translateX(-50%); font-size:0.5rem; color:var(--c-text2); white-space:nowrap; }
.daily-col-total { position:absolute; top:-16px; left:50%; transform:translateX(-50%); font-size:0.45rem; font-weight:700; color:var(--c-text); white-space:nowrap; }
.dash-legend { display:flex; flex-wrap:wrap; gap:8px; margin-top:var(--sp-sm); justify-content:center; }
.dash-legend-item { display:flex; align-items:center; gap:3px; font-size:var(--fs-xs); color:var(--c-text2); }
.dash-legend-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }

/* ===== Weather ===== */
.weather-badge { display:inline-flex; align-items:center; gap:3px; font-size:var(--fs-xs); padding:2px 8px; border-radius:var(--radius-full); background:rgba(255,255,255,0.6); margin-left:var(--sp-sm); vertical-align:middle; }
.weather-badge .w-temp { font-weight:600; }

/* ===== Templates ===== */
.tpl-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:var(--sp-sm); margin-bottom:var(--sp-md); }
.tpl-card { padding:var(--sp-sm) var(--sp-md); background:rgba(0,0,0,0.02); border:1.5px solid rgba(0,0,0,0.06); border-radius:var(--radius-sm); cursor:pointer; transition:border-color var(--t-fast), background var(--t-fast); text-align:center; }
.tpl-card:active, .tpl-card:hover { border-color:var(--c-primary); background:rgba(68,102,206,0.06); }
.tpl-card .tpl-icon { font-size:1.4rem; }
.tpl-card .tpl-name { font-size:var(--fs-xs); margin-top:2px; color:var(--c-text); }

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
</style>
</head>
<body>

<!-- ===== Header ===== -->
<header class="app-header">
  <h1 class="app-title">æ—…ã®ã—ãŠã‚Š</h1>
  <div class="header-actions">
    <button id="btn-sync" class="icon-btn" title="ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å–å¾—" style="position:relative;">
      &#x1F504;
      <span id="sync-status" class="sync-dot" title="åŒæœŸçŠ¶æ…‹"></span>
    </button>
    <button id="btn-cloud-upload" class="icon-btn" title="ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜">&#x2601;</button>
    <button id="btn-cloud-settings" class="icon-btn" title="è¨­å®š">&#x2699;</button>
  </div>
</header>

<!-- ===== Tab Navigation ===== -->
<nav class="tab-nav" role="tablist">
  <button class="tab-btn active" data-tab="itinerary" role="tab">
    <span class="tab-icon">&#x1F5FA;</span>
    <span class="tab-label">æ—…ç¨‹</span>
  </button>
  <button class="tab-btn" data-tab="checklist" role="tab">
    <span class="tab-icon">&#x1F9F3;</span>
    <span class="tab-label">æŒã¡ç‰©</span>
  </button>
  <button class="tab-btn" data-tab="money" role="tab">
    <span class="tab-icon">&#x1F4B0;</span>
    <span class="tab-label">ãŠé‡‘</span>
  </button>
  <button class="tab-btn" data-tab="settings" role="tab">
    <span class="tab-icon">&#x2699;</span>
    <span class="tab-label">è¨­å®š</span>
  </button>
</nav>

<!-- ===== Tab: æ—…ç¨‹ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é–²è¦§ï¼‹ç·¨é›†ï¼‰ ===== -->
<section id="tab-itinerary" class="tab-content active">
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--sp-sm);">
      <h2 class="card-title" style="margin-bottom:0;">ğŸ“‹ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
      <button id="btn-share-schedule" class="btn-share" title="ä»Šæ—¥ã®äºˆå®šã‚’ã‚³ãƒ”ãƒ¼">ğŸ“¤ å…±æœ‰</button>
    </div>
    <div id="itin-filter" class="itin-filter"></div>
    <div id="itinerary-list"></div>
    <p id="itinerary-empty" class="empty-msg">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“<br><small style="color:var(--c-text2)">ä¸‹ã®ã€Œâœï¸ äºˆå®šã‚’è¿½åŠ ãƒ»ç·¨é›†ã€ã‚’é–‹ã„ã¦è¿½åŠ ã—ã¦ãã ã•ã„</small></p>
  </div>

  <!-- äºˆå®šã®è¿½åŠ ãƒ»ç·¨é›†ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
  <div class="card">
    <div id="itin-edit-toggle" class="accordion-toggle">
      <span class="arrow">â–¶</span>
      âœï¸ äºˆå®šã‚’è¿½åŠ ãƒ»ç·¨é›†
      <span style="font-weight:400;font-size:var(--fs-sm);color:var(--c-text2);margin-left:auto;">(<span id="itin-count">0</span>ä»¶)</span>
    </div>
    <div id="itin-edit-body" class="accordion-body">
      <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
      <div style="margin-top:var(--sp-md);">
        <p style="font-size:var(--fs-sm);font-weight:600;margin-bottom:var(--sp-sm);">ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰è¿½åŠ </p>
        <div class="tpl-grid" id="template-grid"></div>
      </div>
      <!-- è¿½åŠ /ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div style="margin-top:var(--sp-md);">
        <p style="font-size:var(--fs-sm);font-weight:600;margin-bottom:var(--sp-sm);" id="itin-form-title">äºˆå®šã‚’è¿½åŠ </p>
        <form id="form-itinerary">
          <input type="hidden" id="itin-edit-id" value="">
          <div class="form-row">
            <div class="form-group flex-grow">
              <label for="itin-date">æ—¥ä»˜</label>
              <input type="date" id="itin-date" class="form-input" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group flex-grow">
              <label for="itin-time">é–‹å§‹æ™‚åˆ»</label>
              <input type="time" id="itin-time" class="form-input">
            </div>
            <div class="form-group flex-grow">
              <label for="itin-endtime">çµ‚äº†æ™‚åˆ»</label>
              <input type="time" id="itin-endtime" class="form-input">
            </div>
          </div>
          <div class="form-group">
            <label for="itin-title">ã‚¿ã‚¤ãƒˆãƒ«</label>
            <input type="text" id="itin-title" class="form-input" required placeholder="ä¾‹: æˆç”°â†’ã‚·ãƒ‰ãƒ‹ãƒ¼ JQ12" maxlength="100" autocomplete="off">
          </div>
          <div class="form-group">
            <label for="itin-category">ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="itin-category" class="form-input">
              <option value="flight">âœˆï¸ é£›è¡Œæ©Ÿ</option>
              <option value="hotel">ğŸ¨ å®¿æ³Š</option>
              <option value="sightseeing">ğŸ—ºï¸ è¦³å…‰</option>
              <option value="food">ğŸ½ï¸ é£Ÿäº‹</option>
              <option value="transport">ğŸšƒ äº¤é€š</option>
              <option value="other">ğŸ“Œ ãã®ä»–</option>
            </select>
          </div>
          <div class="form-group">
            <label>å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼</label>
            <div class="split-controls">
              <button type="button" id="btn-itin-select-all" class="btn-sm">å…¨é¸æŠ</button>
              <button type="button" id="btn-itin-deselect-all" class="btn-sm">å…¨è§£é™¤</button>
            </div>
            <div id="itin-participants" class="checkbox-grid"></div>
          </div>
          <div class="form-group">
            <label for="itin-memo">ãƒ¡ãƒ¢</label>
            <textarea id="itin-memo" class="form-input" placeholder="è©³ç´°ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰" maxlength="500" rows="2"></textarea>
          </div>
          <div class="form-group">
            <label for="itin-url">ãƒªãƒ³ã‚¯URL</label>
            <input type="url" id="itin-url" class="form-input" placeholder="Googleãƒ‰ãƒ©ã‚¤ãƒ–ç­‰ã®URLï¼ˆä»»æ„ï¼‰" autocomplete="off">
          </div>
          <div class="form-group">
            <label for="itin-location">å ´æ‰€å</label>
            <input type="text" id="itin-location" class="form-input" placeholder="ä¾‹: ã‚·ãƒ‰ãƒ‹ãƒ¼ãƒ»ã‚ªãƒšãƒ©ãƒã‚¦ã‚¹ï¼ˆä»»æ„ï¼‰" maxlength="100" autocomplete="off">
          </div>
          <div class="form-group">
            <label for="itin-mapurl">Google Maps URL</label>
            <input type="url" id="itin-mapurl" class="form-input" placeholder="Google Mapsã®å…±æœ‰URLï¼ˆä»»æ„ï¼‰" autocomplete="off">
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-block" id="itin-submit-btn">è¿½åŠ ã™ã‚‹</button>
            <button type="button" id="btn-cancel-itin-edit" class="btn btn-secondary btn-block" style="display:none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </form>
      </div>
      <!-- äºˆå®šä¸€è¦§ï¼ˆç·¨é›†ç”¨ï¼‰ -->
      <div style="margin-top:var(--sp-md);">
        <p style="font-size:var(--fs-sm);font-weight:600;margin-bottom:var(--sp-sm);">äºˆå®šä¸€è¦§</p>
        <div id="itin-edit-list"></div>
        <p id="itin-edit-empty" class="empty-msg">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</p>
      </div>
    </div>
  </div>
</section>

<!-- ===== Tab: æŒã¡ç‰©ï¼ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼‰ ===== -->
<section id="tab-checklist" class="tab-content">
  <div class="card">
    <h2 class="card-title">ğŸ§³ æŒã¡ç‰©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h2>
    <div class="checklist-progress-bar"><div id="checklist-progress-fill" class="checklist-progress-fill" style="width:0%"></div></div>
    <div id="cl-progress-summary" class="cl-progress-summary"></div>
    <div id="checklist-body" class="checklist-body">
      <!-- ãƒ¡ãƒ³ãƒãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ -->
      <div id="cl-member-filter" class="cl-member-filter"></div>
      <!-- ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ -->
      <div class="cl-cat-tabs" id="cl-cat-tabs">
        <span class="cl-cat-tab active" data-cl-cat="all">ã™ã¹ã¦</span>
        <span class="cl-cat-tab" data-cl-cat="essential">å¿…éœ€å“</span>
        <span class="cl-cat-tab" data-cl-cat="clothes">è¡£é¡</span>
        <span class="cl-cat-tab" data-cl-cat="electronics">é›»å­æ©Ÿå™¨</span>
        <span class="cl-cat-tab" data-cl-cat="toiletry">æ—¥ç”¨å“</span>
        <span class="cl-cat-tab" data-cl-cat="medicine">åŒ»è–¬å“</span>
        <span class="cl-cat-tab" data-cl-cat="food">é£Ÿå“</span>
        <span class="cl-cat-tab" data-cl-cat="other">ãã®ä»–</span>
      </div>
      <!-- è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="checklist-add-form" id="cl-add-form">
        <div class="checklist-add">
          <input type="text" id="cl-new-item" placeholder="ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ..." maxlength="50" autocomplete="off">
          <button class="btn btn-primary btn-sm" id="cl-add-btn">è¿½åŠ </button>
        </div>
        <div class="cl-add-meta" id="cl-add-meta" hidden>
          <div class="cl-auto-cat">
            <span class="cl-auto-cat-label">ã‚«ãƒ†ã‚´ãƒª:</span>
            <select id="cl-cat-select" class="cl-cat-select">
              <option value="essential">å¿…éœ€å“</option>
              <option value="clothes">è¡£é¡</option>
              <option value="electronics">é›»å­æ©Ÿå™¨</option>
              <option value="toiletry">æ—¥ç”¨å“</option>
              <option value="medicine">åŒ»è–¬å“</option>
              <option value="food">é£Ÿå“</option>
              <option value="other" selected>ãã®ä»–</option>
            </select>
          </div>
          <div class="cl-add-members">
            <span class="cl-add-members-label">å¯¾è±¡:</span>
            <div id="cl-add-member-checks" class="cl-add-member-checks"></div>
          </div>
        </div>
      </div>
      <div id="checklist-list"></div>
    </div>
  </div>
</section>

<!-- ===== Tab: ãŠé‡‘ï¼ˆæ”¯æ‰•ã„ï¼‹ç²¾ç®—ï¼‰ ===== -->
<section id="tab-money" class="tab-content">
  <!-- æ”¯æ‰•ã„ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card">
    <h2 class="card-title" id="expense-form-title">æ”¯æ‰•ã„ã‚’è¿½åŠ </h2>
    <form id="form-expense">
      <input type="hidden" id="expense-edit-id" value="">
      <div class="form-group">
        <label for="expense-date">æ—¥ä»˜</label>
        <input type="date" id="expense-date" class="form-input" required>
      </div>
      <div class="form-group">
        <label for="expense-payer">æ”¯æ‰•ã£ãŸäºº</label>
        <select id="expense-payer" class="form-input" required>
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group flex-grow">
          <label for="expense-amount">é‡‘é¡</label>
          <input type="number" id="expense-amount" class="form-input" min="0" step="any" required placeholder="0" inputmode="decimal">
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <div class="currency-toggle" id="currency-toggle">
            <button type="button" class="toggle-btn active-jpy" data-currency="JPY">JPY</button>
            <button type="button" class="toggle-btn" data-currency="AUD">AUD</button>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="expense-memo">ãƒ¡ãƒ¢</label>
        <input type="text" id="expense-memo" class="form-input" placeholder="ä½•ã«ä½¿ã£ãŸï¼Ÿ" maxlength="100" autocomplete="off">
      </div>
      <div class="form-group">
        <label>å‰²ã‚Šå‹˜ãƒ¡ãƒ³ãƒãƒ¼</label>
        <div class="split-controls">
          <button type="button" id="btn-select-all" class="btn-sm">å…¨é¸æŠ</button>
          <button type="button" id="btn-deselect-all" class="btn-sm">å…¨è§£é™¤</button>
        </div>
        <div id="split-members" class="checkbox-grid"></div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary btn-block" id="expense-submit-btn">è¿½åŠ ã™ã‚‹</button>
        <button type="button" id="btn-cancel-edit" class="btn btn-secondary btn-block" style="display:none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </form>
  </div>
  <!-- æ”¯æ‰•ã„ä¸€è¦§ -->
  <div class="card">
    <h2 class="card-title">æ”¯æ‰•ã„ä¸€è¦§</h2>
    <div id="expense-summary" class="summary-bar"></div>
    <div id="expense-list"></div>
    <p id="expense-empty" class="empty-msg">æ”¯æ‰•ã„è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
  </div>
  <!-- æ”¯å‡ºãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
  <div class="card">
    <h2 class="card-title">ğŸ“Š æ”¯å‡ºã‚µãƒãƒªãƒ¼</h2>
    <div id="dashboard-stats" class="dashboard-grid"></div>
    <div class="dash-section-header">
      <p class="dash-section-title">æ”¯æ‰•ã„è€…åˆ¥</p>
      <div id="dash-currency-payer" class="dash-currency-toggle" data-currency="JPY">
        <button class="dash-cur-btn active" data-cur="JPY">JPY</button>
        <button class="dash-cur-btn" data-cur="AUD">AUD</button>
      </div>
    </div>
    <div id="dashboard-category" class="cat-bar-list"></div>
    <div style="margin-top:var(--sp-md);">
      <div class="dash-section-header">
        <p class="dash-section-title">æ—¥åˆ¥æ”¯å‡º</p>
        <div id="dash-currency-daily" class="dash-currency-toggle" data-currency="JPY">
          <button class="dash-cur-btn active" data-cur="JPY">JPY</button>
          <button class="dash-cur-btn" data-cur="AUD">AUD</button>
        </div>
      </div>
      <div id="dashboard-daily" class="daily-chart-stacked"></div>
    </div>
    <div id="dash-legend" class="dash-legend"></div>
    <p id="dashboard-empty" class="empty-msg" hidden>æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
  </div>
  <!-- ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ -->
  <div class="card">
    <h2 class="card-title">ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ</h2>
    <div class="exchange-rate-form">
      <span>1 AUD =</span>
      <input type="number" id="exchange-rate" class="form-input" min="0.01" step="0.01" value="95" inputmode="decimal">
      <span>å††</span>
    </div>
    <div id="rate-status" class="rate-status"></div>
  </div>
  <!-- ç²¾ç®—é€šè²¨ -->
  <div class="card">
    <h2 class="card-title">ç²¾ç®—é€šè²¨</h2>
    <div class="currency-toggle" id="settle-currency-toggle">
      <button type="button" class="toggle-btn active-jpy" data-settle="JPY">JPY ã§ç²¾ç®—</button>
      <button type="button" class="toggle-btn" data-settle="AUD">AUD ã§ç²¾ç®—</button>
    </div>
  </div>
  <!-- å€‹äººåæ”¯ -->
  <div class="card">
    <h2 class="card-title">å€‹äººåæ”¯</h2>
    <div id="balance-list"></div>
    <p id="balance-empty" class="empty-msg">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
  </div>
  <!-- ç²¾ç®—ãƒ—ãƒ©ãƒ³ -->
  <div class="card">
    <h2 class="card-title">ç²¾ç®—ãƒ—ãƒ©ãƒ³</h2>
    <p class="card-desc">æœ€å°é™ã®é€é‡‘å›æ•°ã§ç²¾ç®—ã—ã¾ã™</p>
    <div id="settlement-plan"></div>
    <p id="settlement-empty" class="empty-msg">ç²¾ç®—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
  </div>
</section>

<!-- ===== Tab: è¨­å®š ===== -->
<section id="tab-settings" class="tab-content">
  <div class="card">
    <h2 class="card-title">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h2>
    <form id="form-add-member" class="inline-form" style="margin-bottom:var(--sp-md);">
      <input type="text" id="input-member-name" placeholder="åå‰ã‚’å…¥åŠ›" class="form-input" required maxlength="20" autocomplete="off">
      <button type="submit" class="btn btn-primary">è¿½åŠ </button>
    </form>
    <h3 style="font-size:var(--fs-sm);font-weight:600;color:var(--c-text2);margin-bottom:var(--sp-sm);">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ <span style="font-weight:400">(<span id="member-count">0</span>äºº)</span></h3>
    <ul id="member-list" class="item-list"></ul>
    <p id="member-empty" class="empty-msg">ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</p>
  </div>
  <div class="card">
    <h2 class="card-title">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h2>
    <p style="font-size:0.75rem;color:var(--c-text2);margin-bottom:12px;line-height:1.4;">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨åŒæœŸä¸­ã€‚ğŸ”„ã§å–å¾—ã€â˜ã§ä¿å­˜ã§ãã¾ã™ã€‚</p>
    <div id="spreadsheet-link-area" style="margin-bottom:8px;">
      <a id="spreadsheet-link" href="#" target="_blank" rel="noopener" class="btn btn-secondary" style="width:100%;font-size:var(--fs-sm);text-decoration:none;text-align:center;display:none;">ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã</a>
    </div>
  </div>
  <div class="card">
    <h2 class="card-title">ğŸ“ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
    <div style="display:flex;gap:8px;">
      <button id="btn-export" class="btn btn-secondary" style="flex:1;font-size:var(--fs-sm);">ğŸ“¤ æ›¸ãå‡ºã—</button>
      <button id="btn-import" class="btn btn-secondary" style="flex:1;font-size:var(--fs-sm);">ğŸ“¥ èª­ã¿è¾¼ã¿</button>
    </div>
    <input type="file" id="import-file" accept=".json" hidden>
  </div>
</section>

<!-- ===== Modal ===== -->
<div id="modal-overlay" class="modal-overlay" hidden>
  <div class="modal" role="dialog" aria-modal="true">
    <p id="modal-message" class="modal-message"></p>
    <div class="modal-actions">
      <button id="modal-cancel" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="modal-confirm" class="btn btn-danger">å‰Šé™¤ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- ===== GAS URL Settings Modal (é–‹ç™ºè€…å‘ã‘) ===== -->
<div id="cloud-modal-overlay" class="modal-overlay" hidden>
  <div class="modal" role="dialog" aria-modal="true" style="max-width:400px;">
    <p class="modal-message" style="font-weight:700;margin-bottom:12px;">GAS URLè¨­å®š</p>
    <div class="form-group" style="margin-bottom:8px;">
      <input type="url" id="gas-url-input" class="form-input" placeholder="https://script.google.com/macros/s/..." autocomplete="off" style="font-size:0.75rem;">
    </div>
    <div style="display:flex;gap:6px;margin-bottom:16px;">
      <button id="cloud-modal-save" class="btn btn-primary" style="flex:1;font-size:var(--fs-sm);">URLä¿å­˜</button>
      <button id="cloud-modal-clear" class="btn btn-danger" style="font-size:0.75rem;padding:6px 10px;">å‰Šé™¤</button>
    </div>
    <div class="modal-actions">
      <button id="cloud-modal-cancel" class="btn btn-secondary" style="width:100%;">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- ===== Toast ===== -->
<div id="toast" class="toast" hidden></div>

<script>
/* ===== Constants ===== */
const APP_KEY = 'travel-expense-splitter-v1';

const CATEGORY_ICONS = {
  flight: 'âœˆï¸', hotel: 'ğŸ¨', sightseeing: 'ğŸ—ºï¸',
  food: 'ğŸ½ï¸', transport: 'ğŸšƒ', other: 'ğŸ“Œ'
};
const CATEGORY_LABELS = {
  flight: 'é£›è¡Œæ©Ÿ', hotel: 'å®¿æ³Š', sightseeing: 'è¦³å…‰',
  food: 'é£Ÿäº‹', transport: 'äº¤é€š', other: 'ãã®ä»–'
};
const DAY_NAMES = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
const MEMBER_COLORS = ['#4466ce','#e05688','#16a34a','#e97c1f','#8b5cf6','#0891b2','#dc2626','#6d28d9'];

/* ===== State ===== */
let state = createDefaultState();
let modalCallback = null;
let currentCurrency = 'JPY';

function createDefaultState() {
  return {
    members: [],
    expenses: [],
    itinerary: [],
    checklist: [],
    exchangeRate: 95,
    settleCurrency: 'JPY',
    nextMemberId: 1,
    nextExpenseId: 1,
    nextItineraryId: 1,
    nextChecklistId: 1
  };
}

/* ===== Persistence ===== */
function loadState() {
  try {
    const raw = localStorage.getItem(APP_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      if (parsed && Array.isArray(parsed.members) && Array.isArray(parsed.expenses)) {
        state = parsed;
        if (!Array.isArray(state.itinerary)) state.itinerary = [];
        if (!Array.isArray(state.checklist)) state.checklist = [];
        if (!state.nextItineraryId) state.nextItineraryId = 1;
        const maxClIdLocal = state.checklist.length > 0 ? Math.max(...state.checklist.map(i => Number(i.id) || 0)) : 0;
        if (!state.nextChecklistId || state.nextChecklistId <= maxClIdLocal) state.nextChecklistId = maxClIdLocal + 1;
        // IDå‹ã‚’æ•°å€¤ã«çµ±ä¸€
        state.members.forEach(m => { m.id = Number(m.id) || m.id; });
        state.checklist.forEach(item => {
          if (Array.isArray(item.members)) item.members = item.members.map(mid => Number(mid) || mid);
        });
        state.expenses.forEach(e => {
          e.payerId = Number(e.payerId) || e.payerId;
          if (Array.isArray(e.splitWith)) e.splitWith = e.splitWith.map(id => Number(id) || id);
        });
        state.itinerary.forEach(e => {
          if (Array.isArray(e.participants)) e.participants = e.participants.map(id => Number(id) || id);
        });
        // Ensure all members have a color
        state.members.forEach((m, i) => {
          if (!m.color) m.color = MEMBER_COLORS[i % MEMBER_COLORS.length];
        });
        // Migrate old checklist format to per-member format
        migrateChecklistItems();
      }
    }
  } catch (e) { /* keep default */ }
}

let cloudSyncReady = false; // syncFromCloudå®Œäº†ã¾ã§ã¯syncToCloudã‚’æŠ‘åˆ¶
function saveState() {
  localStorage.setItem(APP_KEY, JSON.stringify(state));
  // ã‚¯ãƒ©ã‚¦ãƒ‰åˆå›èª­ã¿è¾¼ã¿å®Œäº†å¾Œã¯è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆ1.5ç§’ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
  if (cloudSyncReady) debouncedSyncToCloud();
}

/* ===== Cloud Sync (GAS) ===== */
const GAS_URL_KEY = 'travel-app-gas-url';
const DEFAULT_GAS_URL = 'https://script.google.com/macros/s/AKfycbzo12iDyjWtcCDx6bEHjhcD5JOezgxb6fShI38HMlzggPjLiEfk337oESeBVTBTDIQ/exec';
const DEFAULT_SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/1p3axqRtW8ePEyhFHh0KSIcCfn9Zil-9krnvXBAZt0do/edit';
let syncTimer = null;

function getGasUrl() {
  return localStorage.getItem(GAS_URL_KEY) || DEFAULT_GAS_URL;
}

function setGasUrl(url) {
  if (url) localStorage.setItem(GAS_URL_KEY, url);
  else localStorage.removeItem(GAS_URL_KEY);
}

function setSyncStatus(status) {
  const el = document.getElementById('sync-status');
  if (!el) return;
  el.className = 'sync-dot ' + status;
  const titles = { off: 'æœªè¨­å®š', syncing: 'åŒæœŸä¸­...', synced: 'åŒæœŸæ¸ˆ', error: 'åŒæœŸã‚¨ãƒ©ãƒ¼' };
  el.title = titles[status] || '';
  // Sync button spin animation
  const btn = document.getElementById('btn-sync');
  if (btn) {
    if (status === 'syncing') btn.classList.add('syncing');
    else btn.classList.remove('syncing');
  }
}

function debouncedSyncToCloud() {
  if (!getGasUrl()) return;
  clearTimeout(syncTimer);
  syncTimer = setTimeout(() => syncToCloud(), 1500);
}

async function syncToCloud() {
  const url = getGasUrl();
  if (!url) return;
  setSyncStatus('syncing');
  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(state),
      signal: AbortSignal.timeout(15000)
    });
    const result = await res.json();
    if (result.success) {
      setSyncStatus('synced');
    } else {
      setSyncStatus('error');
      console.error('Sync save error:', result.error);
    }
  } catch (e) {
    setSyncStatus('error');
    console.error('Sync save failed:', e);
  }
}

async function syncFromCloud() {
  const url = getGasUrl();
  if (!url) { setSyncStatus('off'); return; }
  setSyncStatus('syncing');
  try {
    const res = await fetch(url + '?action=load', { signal: AbortSignal.timeout(15000) });
    const result = await res.json();
    if (result.success && result.data) {
      const cloud = result.data;
      // Save spreadsheet URL if provided
      if (cloud.spreadsheetUrl) {
        localStorage.setItem('travel-app-spreadsheet-url', cloud.spreadsheetUrl);
        updateSpreadsheetLink();
      }
      // === ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’æ­£ã¨ã™ã‚‹: ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å¸¸ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ä¸Šæ›¸ã ===
      // Workaround: GASã®ãƒ˜ãƒƒãƒ€ãƒ¼ãšã‚Œã§participantsåˆ—ãŒç©ºæ–‡å­—ã‚­ãƒ¼""ã«æ ¼ç´ã•ã‚Œã‚‹å•é¡Œã¸ã®å¯¾ç­–
      if (Array.isArray(cloud.itinerary)) {
        cloud.itinerary.forEach(e => {
          if ((!e.participants || e.participants.length === 0) && e[''] && typeof e[''] === 'string') {
            try { e.participants = JSON.parse(e['']); } catch(ex) {}
            delete e[''];
          }
          if (typeof e.participants === 'string' && e.participants) {
            try { e.participants = JSON.parse(e.participants); } catch(ex) { e.participants = []; }
          }
          if (!Array.isArray(e.participants)) e.participants = [];
        });
      }
      // åŒæ§˜ã«expensesã®splitWithã‚‚ä¿®å¾©
      if (Array.isArray(cloud.expenses)) {
        cloud.expenses.forEach(e => {
          if ((!e.splitWith || e.splitWith.length === 0) && e[''] && typeof e[''] === 'string') {
            try { e.splitWith = JSON.parse(e['']); } catch(ex) {}
            delete e[''];
          }
          if (typeof e.splitWith === 'string' && e.splitWith) {
            try { e.splitWith = JSON.parse(e.splitWith); } catch(ex) { e.splitWith = []; }
          }
          if (!Array.isArray(e.splitWith)) e.splitWith = [];
        });
      }
      // checklistã‚‚ä¿®å¾© (new per-member format: members[], checkedBy{})
      if (Array.isArray(cloud.checklist)) {
        cloud.checklist.forEach(e => {
          // Parse members if JSON string from GAS
          if (typeof e.members === 'string') {
            try { e.members = JSON.parse(e.members); } catch(ex) { e.members = []; }
          }
          if (!Array.isArray(e.members)) e.members = [];
          // Parse checkedBy if JSON string from GAS
          if (typeof e.checkedBy === 'string') {
            try { e.checkedBy = JSON.parse(e.checkedBy); } catch(ex) { e.checkedBy = {}; }
          }
          if (!e.checkedBy || typeof e.checkedBy !== 'object' || Array.isArray(e.checkedBy)) e.checkedBy = {};
          // Legacy: old boolean checked field â†’ will be handled by migrateChecklistItems()
          if (typeof e.checked === 'string') e.checked = e.checked === 'true' || e.checked === 'TRUE';
        });
      }

      // ã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã§stateã‚’å®Œå…¨ä¸Šæ›¸ã
      state = cloud;
      if (!Array.isArray(state.members)) state.members = [];
      if (!Array.isArray(state.expenses)) state.expenses = [];
      if (!Array.isArray(state.itinerary)) state.itinerary = [];
      if (!Array.isArray(state.checklist)) state.checklist = [];
      // members.id ã‚’æ•°å€¤ã«çµ±ä¸€ï¼ˆGASã‹ã‚‰ã¯æ–‡å­—åˆ—ã§æ¥ã‚‹å ´åˆãŒã‚ã‚‹ï¼‰
      state.members.forEach(m => { m.id = Number(m.id) || m.id; });
      // checklist.members[] / checkedBy ã®ã‚­ãƒ¼ã‚‚æ•°å€¤ã«çµ±ä¸€
      state.checklist.forEach(item => {
        if (Array.isArray(item.members)) item.members = item.members.map(mid => Number(mid) || mid);
      });
      // expenses.payerId / splitWith ã‚‚æ•°å€¤ã«çµ±ä¸€
      state.expenses.forEach(e => {
        e.payerId = Number(e.payerId) || e.payerId;
        if (Array.isArray(e.splitWith)) e.splitWith = e.splitWith.map(id => Number(id) || id);
      });
      // itinerary.participants ã‚‚æ•°å€¤ã«çµ±ä¸€
      state.itinerary.forEach(e => {
        if (Array.isArray(e.participants)) e.participants = e.participants.map(id => Number(id) || id);
      });
      // nextChecklistId: GASã‹ã‚‰æ­£ã—ãè¿”ã‚‰ãªã„å ´åˆã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç®—å‡º
      const maxClId = state.checklist.length > 0 ? Math.max(...state.checklist.map(i => Number(i.id) || 0)) : 0;
      if (!state.nextChecklistId || state.nextChecklistId <= maxClId) state.nextChecklistId = maxClId + 1;
      // Ensure all members have a color
      state.members.forEach((m, i) => {
        if (!m.color) m.color = MEMBER_COLORS[i % MEMBER_COLORS.length];
      });
      console.log('[sync] checklist items:', state.checklist.length, 'members:', state.members.length);
      // Migrate old checklist format to per-member format
      migrateChecklistItems();
      localStorage.setItem(APP_KEY, JSON.stringify(state));
      renderAll();
      setSyncStatus('synced');
      console.log('[sync] ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº† (ã‚¯ãƒ©ã‚¦ãƒ‰=æ­£)');
    } else {
      setSyncStatus('error');
    }
  } catch (e) {
    setSyncStatus('error');
    console.error('Sync load failed:', e);
  }
  cloudSyncReady = true;
}

/* ===== Utilities ===== */
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function getTodayString() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const [y, m, d] = dateStr.split('-');
  return `${Number(m)}/${Number(d)}`;
}

function formatDateFull(dateStr) {
  if (!dateStr) return '';
  const [y, m, d] = dateStr.split('-');
  const date = new Date(Number(y), Number(m) - 1, Number(d));
  return `${Number(m)}/${Number(d)}(${DAY_NAMES[date.getDay()]})`;
}

function getMemberName(id) {
  const m = state.members.find(m => m.id === id);
  return m ? m.name : 'ä¸æ˜';
}

function roundForCurrency(amount, currency) {
  if (currency === 'JPY') return Math.round(amount);
  return Math.round(amount * 100) / 100;
}

function formatAmount(amount, currency) {
  if (currency === 'JPY') return 'Â¥' + Math.round(amount).toLocaleString('ja-JP');
  return 'A$' + amount.toFixed(2);
}

function generateMemberId() { return 'm' + (state.nextMemberId++); }
function generateExpenseId() { return state.nextExpenseId++; }
function generateItineraryId() { return state.nextItineraryId++; }

/* ===== Toast ===== */
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.hidden = false;
  requestAnimationFrame(() => { toast.classList.add('show'); });
  clearTimeout(toast._timer);
  toast._timer = setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => { toast.hidden = true; }, 300);
  }, 2200);
}

/* ===== Modal ===== */
function showModal(message, confirmLabel, onConfirm) {
  document.getElementById('modal-message').textContent = message;
  document.getElementById('modal-confirm').textContent = confirmLabel || 'å‰Šé™¤ã™ã‚‹';
  document.getElementById('modal-overlay').hidden = false;
  modalCallback = onConfirm;
}

function closeModal() {
  document.getElementById('modal-overlay').hidden = true;
  modalCallback = null;
}

/* ===== Member Management ===== */
function addMember(name) {
  const trimmed = name.trim();
  if (!trimmed) { showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return false; }
  if (state.members.some(m => m.name === trimmed)) { showToast('åŒã˜åå‰ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã™'); return false; }
  const colorIdx = state.members.length % MEMBER_COLORS.length;
  state.members.push({ id: generateMemberId(), name: trimmed, color: MEMBER_COLORS[colorIdx] });
  saveState();
  return true;
}

function getMemberColor(memberId) {
  const m = state.members.find(m => m.id === memberId);
  if (m && m.color) return m.color;
  const idx = state.members.findIndex(m => m.id === memberId);
  return MEMBER_COLORS[idx >= 0 ? idx % MEMBER_COLORS.length : 0];
}

function removeMember(memberId) {
  const hasExpenses = state.expenses.some(e => e.payerId === memberId || e.splitWith.includes(memberId));
  if (hasExpenses) {
    showToast('æ”¯æ‰•ã„è¨˜éŒ²ã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“');
    return false;
  }
  state.members = state.members.filter(m => m.id !== memberId);
  saveState();
  return true;
}

/* ===== Expense Management ===== */
function addExpense(data) {
  if (!data.payerId) { showToast('æ”¯æ‰•ã£ãŸäººã‚’é¸æŠã—ã¦ãã ã•ã„'); return false; }
  if (!data.amount || data.amount <= 0) { showToast('é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return false; }
  if (!data.splitWith || data.splitWith.length === 0) { showToast('å‰²ã‚Šå‹˜ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„'); return false; }
  state.expenses.push({
    id: generateExpenseId(),
    date: data.date || getTodayString(),
    payerId: data.payerId,
    amount: Number(data.amount),
    currency: data.currency || 'JPY',
    memo: data.memo || '',
    splitWith: [...data.splitWith]
  });
  saveState();
  return true;
}

function updateExpense(expenseId, data) {
  const idx = state.expenses.findIndex(e => e.id === expenseId);
  if (idx === -1) return false;
  if (!data.payerId) { showToast('æ”¯æ‰•ã£ãŸäººã‚’é¸æŠã—ã¦ãã ã•ã„'); return false; }
  if (!data.amount || data.amount <= 0) { showToast('é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return false; }
  if (!data.splitWith || data.splitWith.length === 0) { showToast('å‰²ã‚Šå‹˜ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„'); return false; }
  state.expenses[idx] = { ...state.expenses[idx], ...data, amount: Number(data.amount) };
  saveState();
  return true;
}

function deleteExpense(expenseId) {
  state.expenses = state.expenses.filter(e => e.id !== expenseId);
  saveState();
}

/* ===== Itinerary Management ===== */
function addItineraryEvent(data) {
  if (!data.date) { showToast('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return false; }
  if (!data.title || !data.title.trim()) { showToast('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return false; }
  state.itinerary.push({
    id: generateItineraryId(),
    date: data.date,
    time: data.time || '',
    endTime: data.endTime || '',
    title: data.title.trim(),
    category: data.category || 'other',
    memo: data.memo || '',
    url: data.url || '',
    location: data.location || '',
    mapUrl: data.mapUrl || '',
    participants: data.participants || []
  });
  saveState();
  return true;
}

function updateItineraryEvent(eventId, data) {
  const idx = state.itinerary.findIndex(e => e.id === eventId);
  if (idx === -1) return false;
  if (!data.date) { showToast('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return false; }
  if (!data.title || !data.title.trim()) { showToast('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return false; }
  state.itinerary[idx] = { ...state.itinerary[idx], ...data, title: data.title.trim() };
  saveState();
  return true;
}

function deleteItineraryEvent(eventId) {
  state.itinerary = state.itinerary.filter(e => e.id !== eventId);
  saveState();
}

/* ===== Settlement Algorithm ===== */
function calculateNetBalances() {
  const rate = state.exchangeRate || 95;
  const sc = state.settleCurrency || 'JPY';
  const balances = {};
  state.members.forEach(m => { balances[m.id] = 0; });
  state.expenses.forEach(exp => {
    let amt;
    if (sc === 'JPY') { amt = exp.currency === 'JPY' ? exp.amount : exp.amount * rate; }
    else { amt = exp.currency === 'AUD' ? exp.amount : exp.amount / rate; }
    if (balances[exp.payerId] !== undefined) { balances[exp.payerId] += amt; }
    const share = amt / exp.splitWith.length;
    exp.splitWith.forEach(mid => { if (balances[mid] !== undefined) { balances[mid] -= share; } });
  });
  return balances;
}

function calculateSettlementPlan(balances) {
  const sc = state.settleCurrency || 'JPY';
  const debtors = [], creditors = [];
  Object.entries(balances).forEach(([id, bal]) => {
    const r = roundForCurrency(bal, sc);
    if (r < (sc === 'JPY' ? -0.5 : -0.005)) debtors.push({ id, amount: Math.abs(r) });
    else if (r > (sc === 'JPY' ? 0.5 : 0.005)) creditors.push({ id, amount: r });
  });
  debtors.sort((a, b) => b.amount - a.amount);
  creditors.sort((a, b) => b.amount - a.amount);
  const transactions = [];
  let di = 0, ci = 0;
  while (di < debtors.length && ci < creditors.length) {
    const d = debtors[di], c = creditors[ci];
    const transfer = Math.min(d.amount, c.amount);
    if (transfer > (sc === 'JPY' ? 0.5 : 0.005)) {
      transactions.push({ from: d.id, fromName: getMemberName(d.id), to: c.id, toName: getMemberName(c.id), amount: roundForCurrency(transfer, sc), currency: sc });
    }
    d.amount -= transfer; c.amount -= transfer;
    if (d.amount < (sc === 'JPY' ? 0.5 : 0.005)) di++;
    if (c.amount < (sc === 'JPY' ? 0.5 : 0.005)) ci++;
  }
  return transactions;
}

/* ===== Rendering: Members ===== */
function renderMembers() {
  const list = document.getElementById('member-list');
  const empty = document.getElementById('member-empty');
  document.getElementById('member-count').textContent = state.members.length;
  if (state.members.length === 0) { list.innerHTML = ''; empty.hidden = false; return; }
  empty.hidden = true;
  list.innerHTML = state.members.map(m => {
    const color = m.color || getMemberColor(m.id);
    return `
    <li class="list-item">
      <span class="member-color-dot" style="background:${color}"></span>
      <span class="member-name" data-member-id="${m.id}" style="color:${color};font-weight:700;" title="ã‚¿ãƒƒãƒ—ã§åå‰ã‚’ç·¨é›†">${escapeHtml(m.name)}</span>
      <input type="color" class="member-color-picker" data-color-member="${m.id}" value="${color}" title="ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼å¤‰æ›´">
      <button class="btn-icon-sm danger" data-delete-member="${m.id}" title="å‰Šé™¤">&#x2716;</button>
    </li>`;
  }).join('');
}

/* ===== Rendering: Expenses ===== */
function renderPayerSelect() {
  const sel = document.getElementById('expense-payer');
  const current = sel.value;
  sel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
    state.members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
  if (current && state.members.some(m => m.id === current)) sel.value = current;
}

function renderSplitCheckboxes(selected) {
  const container = document.getElementById('split-members');
  const allIds = selected || state.members.map(m => m.id);
  container.innerHTML = state.members.map(m => `
    <label><input type="checkbox" name="split" value="${m.id}" ${allIds.includes(m.id) ? 'checked' : ''}> ${escapeHtml(m.name)}</label>
  `).join('');
}

function renderItinParticipants(selected) {
  const container = document.getElementById('itin-participants');
  const allIds = selected || state.members.map(m => m.id);
  container.innerHTML = state.members.map(m => `
    <label><input type="checkbox" name="itin-participant" value="${m.id}" ${allIds.includes(m.id) ? 'checked' : ''}> ${escapeHtml(m.name)}</label>
  `).join('');
}

function getParticipantNames(participantIds) {
  if (!participantIds || participantIds.length === 0) return '';
  if (participantIds.length === state.members.length) return '';
  return participantIds.map(id => {
    const m = state.members.find(m => m.id === id);
    return m ? m.name : '';
  }).filter(Boolean).join(', ');
}

function getParticipantBadges(participantIds) {
  if (!participantIds || participantIds.length === 0) return '';
  if (participantIds.length === state.members.length) return '';
  return participantIds.map(id => {
    const m = state.members.find(m => m.id === id);
    if (!m) return '';
    const color = getMemberColor(m.id);
    return `<span class="member-badge" style="background:${color}">${escapeHtml(m.name)}</span>`;
  }).filter(Boolean).join('');
}

const EXP_PREVIEW_COUNT = 3;
let expShowAll = false;

function renderExpenses() {
  const container = document.getElementById('expense-list');
  const empty = document.getElementById('expense-empty');
  const summary = document.getElementById('expense-summary');
  if (state.expenses.length === 0) { container.innerHTML = ''; empty.hidden = false; summary.innerHTML = ''; expShowAll = false; return; }
  empty.hidden = true;
  const totalJPY = state.expenses.filter(e => e.currency === 'JPY').reduce((s, e) => s + e.amount, 0);
  const totalAUD = state.expenses.filter(e => e.currency === 'AUD').reduce((s, e) => s + e.amount, 0);
  const parts = [];
  if (totalJPY > 0) parts.push(`<span style="color:var(--c-jpy)">${formatAmount(totalJPY, 'JPY')}</span>`);
  if (totalAUD > 0) parts.push(`<span style="color:var(--c-aud)">${formatAmount(totalAUD, 'AUD')}</span>`);
  summary.innerHTML = parts.length > 0 ? `åˆè¨ˆ: ${parts.join(' / ')} (${state.expenses.length}ä»¶)` : '';
  const sorted = [...state.expenses].sort((a, b) => {
    if (a.date !== b.date) return b.date.localeCompare(a.date);
    return b.id - a.id;
  });
  const needCollapse = sorted.length > EXP_PREVIEW_COUNT;
  const visible = (needCollapse && !expShowAll) ? sorted.slice(0, EXP_PREVIEW_COUNT) : sorted;
  let html = visible.map(e => {
    const splitNames = e.splitWith.map(id => getMemberName(id)).join(', ');
    return `
    <div class="expense-item">
      <div class="expense-top">
        <div class="expense-info">
          <div class="expense-memo">${escapeHtml(e.memo || '(ãƒ¡ãƒ¢ãªã—)')}</div>
          <div class="expense-detail">${escapeHtml(getMemberName(e.payerId))} ãŒæ”¯æ‰•ã„ â†’ ${escapeHtml(splitNames)}</div>
        </div>
        <div class="expense-right">
          <div class="expense-amount ${e.currency.toLowerCase()}">${formatAmount(e.amount, e.currency)}</div>
          <div class="expense-date">${formatDate(e.date)}</div>
        </div>
      </div>
      <div class="expense-actions">
        <button class="btn-icon-sm" data-edit-expense="${e.id}" title="ç·¨é›†">&#x270E;</button>
        <button class="btn-icon-sm danger" data-delete-expense="${e.id}" title="å‰Šé™¤">&#x2716;</button>
      </div>
    </div>`;
  }).join('');
  if (needCollapse) {
    if (expShowAll) {
      html += `<button class="exp-show-all-btn" id="btn-exp-toggle">â–² æŠ˜ã‚ŠãŸãŸã‚€</button>`;
    } else {
      const remaining = sorted.length - EXP_PREVIEW_COUNT;
      html += `<button class="exp-show-all-btn" id="btn-exp-toggle">â–¼ ã™ã¹ã¦è¡¨ç¤ºï¼ˆæ®‹ã‚Š${remaining}ä»¶ï¼‰</button>`;
    }
  }
  container.innerHTML = html;
}

/* ===== Rendering: Settlement ===== */
function renderSettlement() {
  const rateInput = document.getElementById('exchange-rate');
  state.exchangeRate = Number(rateInput.value) || 95;
  saveState();
  const sc = state.settleCurrency;
  const balances = calculateNetBalances();
  const plan = calculateSettlementPlan(balances);
  const balanceEl = document.getElementById('balance-list');
  const balanceEmpty = document.getElementById('balance-empty');
  if (state.members.length === 0) { balanceEl.innerHTML = ''; balanceEmpty.hidden = false; }
  else {
    balanceEmpty.hidden = true;
    balanceEl.innerHTML = state.members.map(m => {
      const bal = roundForCurrency(balances[m.id] || 0, sc);
      const cls = bal >= 0 ? 'positive' : 'negative';
      const sign = bal > 0 ? '+' : '';
      return `<div class="balance-item"><span class="balance-name">${escapeHtml(m.name)}</span><span class="balance-amount ${cls}">${sign}${formatAmount(bal, sc)}</span></div>`;
    }).join('');
  }
  const planEl = document.getElementById('settlement-plan');
  const settleEmpty = document.getElementById('settlement-empty');
  if (plan.length === 0) {
    planEl.innerHTML = '';
    if (state.expenses.length > 0 && state.members.length > 0) { settleEmpty.hidden = false; settleEmpty.textContent = 'ç²¾ç®—ä¸è¦ã§ã™ï¼ˆå…¨å“¡å‡ç­‰ã§ã™ï¼‰'; }
    else { settleEmpty.hidden = state.expenses.length === 0 && state.members.length === 0; settleEmpty.textContent = 'ç²¾ç®—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'; }
    return;
  }
  settleEmpty.hidden = true;
  planEl.innerHTML = plan.map(t => `
    <div class="settlement-item">
      <span class="settlement-from">${escapeHtml(t.fromName)}</span>
      <span class="settlement-arrow">&#x27A1;</span>
      <span class="settlement-to">${escapeHtml(t.toName)}</span>
      <span class="settlement-amount">${formatAmount(t.amount, t.currency)}</span>
    </div>
  `).join('');
}

/* ===== Rendering: Itinerary ===== */
let itinFilterMember = 'all';

function renderItinFilter() {
  const container = document.getElementById('itin-filter');
  if (state.members.length === 0) { container.innerHTML = ''; return; }
  let html = `<button class="filter-btn ${itinFilterMember === 'all' ? 'active' : ''}" data-filter="all">å…¨å“¡</button>`;
  state.members.forEach(m => {
    const color = getMemberColor(m.id);
    const isActive = itinFilterMember === m.id;
    const style = isActive
      ? `background:${color};color:#fff;border-color:${color}`
      : `border-color:${color};color:${color}`;
    html += `<button class="filter-btn ${isActive ? 'active' : ''}" data-filter="${m.id}" style="${style}">${escapeHtml(m.name)}</button>`;
  });
  container.innerHTML = html;
}

function isEventForMember(ev, memberId) {
  if (memberId === 'all') return true;
  if (!ev.participants || ev.participants.length === 0) return true;
  return ev.participants.includes(memberId);
}

function renderItinerary() {
  const container = document.getElementById('itinerary-list');
  const empty = document.getElementById('itinerary-empty');

  renderItinFilter();

  // Filter by selected member
  const filtered = state.itinerary.filter(ev => isEventForMember(ev, itinFilterMember));

  if (filtered.length === 0) {
    container.innerHTML = '';
    empty.hidden = false;
    if (state.itinerary.length > 0 && itinFilterMember !== 'all') {
      empty.innerHTML = 'ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“';
    } else {
      empty.innerHTML = 'äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“<br><small style="color:var(--c-text2)">ã€Œâœï¸ ç·¨é›†ã€ã‚¿ãƒ–ã‹ã‚‰äºˆå®šã‚’è¿½åŠ ã—ã¦ãã ã•ã„</small>';
    }
    return;
  }
  empty.hidden = true;

  const today = getTodayString();
  const now = new Date();
  const nowTime = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');

  // Sort by date then time
  const sorted = [...filtered].sort((a, b) => {
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    return (a.time || '99:99').localeCompare(b.time || '99:99');
  });

  // Group by date
  const groups = {};
  sorted.forEach(ev => {
    if (!groups[ev.date]) groups[ev.date] = [];
    groups[ev.date].push(ev);
  });

  // Find "next up" event: first event today/future whose time hasn't passed
  let nextUpId = null;
  for (const ev of sorted) {
    if (ev.date > today || (ev.date === today && (!ev.time || ev.time >= nowTime))) {
      nextUpId = ev.id;
      break;
    }
  }

  // Calculate day numbers from first date
  const dates = Object.keys(groups).sort();
  const firstDate = dates[0];

  let html = '';
  dates.forEach(date => {
    const isToday = date === today;
    const dayNum = Math.floor((new Date(date) - new Date(firstDate)) / 86400000) + 1;

    html += `<div class="itin-day-group">`;
    html += `<div class="itin-day-header ${isToday ? 'today' : ''}">`;
    html += `Day ${dayNum} - ${formatDateFull(date)}`;
    if (isToday) html += `<span class="itin-day-label">TODAY</span>`;
    html += `</div>`;
    html += `<div class="itin-timeline">`;

    groups[date].forEach(ev => {
      const isNext = ev.id === nextUpId;
      const catClass = 'itin-event-cat-' + (ev.category || 'other');
      const icon = CATEGORY_ICONS[ev.category] || 'ğŸ“Œ';

      html += `<div class="itin-event ${catClass} ${isNext ? 'next-up' : ''}">`;
      html += `<div class="itin-event-dot">${icon}</div>`;
      html += `<div class="itin-event-top">`;
      html += `<div class="itin-event-body">`;

      // Time
      if (ev.time) {
        let timeStr = ev.time;
        if (ev.endTime) timeStr += ' - ' + ev.endTime;
        html += `<div class="itin-event-time">${escapeHtml(timeStr)}`;
        if (isNext) html += `<span class="next-badge">NEXT</span>`;
        html += `</div>`;
      } else if (isNext) {
        html += `<div class="itin-event-time"><span class="next-badge">NEXT</span></div>`;
      }

      // Title
      html += `<div class="itin-event-title">${escapeHtml(ev.title)}</div>`;

      // Participants (show only when not all members)
      const pBadges = getParticipantBadges(ev.participants);
      if (pBadges) {
        html += `<div class="itin-event-participants">ğŸ‘¥ ${pBadges}</div>`;
      }

      // Location
      if (ev.location) {
        html += `<div class="itin-event-location">ğŸ“ ${escapeHtml(ev.location)}</div>`;
      }

      // Links & Memo badge row
      const hasLinks = ev.url || ev.mapUrl;
      if (hasLinks || ev.memo) {
        html += `<div class="itin-event-links">`;
        if (ev.url) html += `<a href="${escapeHtml(ev.url)}" target="_blank" rel="noopener" class="itin-link">ğŸ“ ãƒªãƒ³ã‚¯</a>`;
        if (ev.mapUrl) html += `<a href="${escapeHtml(ev.mapUrl)}" target="_blank" rel="noopener" class="itin-link">ğŸ“ åœ°å›³</a>`;
        if (ev.memo) html += `<span class="itin-memo-badge" data-memo-toggle="${ev.id}">ğŸ“ ãƒ¡ãƒ¢ã‚ã‚Š</span>`;
        html += `</div>`;
      }

      // Memo (hidden by default, toggled by badge tap)
      if (ev.memo) {
        html += `<div class="itin-event-memo" id="itin-memo-${ev.id}">${escapeHtml(ev.memo)}</div>`;
      }

      html += `</div></div>`; // close body, top

      // Edit / Delete actions on schedule view
      html += `<div class="itin-event-actions">`;
      html += `<button class="btn-icon-sm" data-view-edit-itin="${ev.id}" title="ç·¨é›†">&#x270E;</button>`;
      html += `<button class="btn-icon-sm danger" data-view-delete-itin="${ev.id}" title="å‰Šé™¤">&#x2716;</button>`;
      html += `</div>`;

      html += `</div>`; // close event
    });

    html += `</div></div>`; // close timeline, day-group
  });

  container.innerHTML = html;

  // Auto-scroll to today or next-up
  if (nextUpId) {
    const nextEl = container.querySelector('.itin-event.next-up');
    if (nextEl) {
      setTimeout(() => nextEl.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
    }
  }

  // Inject weather badges (async, non-blocking)
  injectWeatherBadges();
}

/* ===== Rendering: Itinerary Edit List ===== */
function renderItinEditList() {
  const container = document.getElementById('itin-edit-list');
  const empty = document.getElementById('itin-edit-empty');
  const countEl = document.getElementById('itin-count');
  countEl.textContent = state.itinerary.length;

  if (state.itinerary.length === 0) {
    container.innerHTML = '';
    empty.hidden = false;
    return;
  }
  empty.hidden = true;

  const sorted = [...state.itinerary].sort((a, b) => {
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    return (a.time || '99:99').localeCompare(b.time || '99:99');
  });

  container.innerHTML = sorted.map(ev => {
    const icon = CATEGORY_ICONS[ev.category] || 'ğŸ“Œ';
    const timeStr = ev.time ? ev.time + (ev.endTime ? '-' + ev.endTime : '') : '';
    return `
    <div class="expense-item">
      <div class="expense-top">
        <div class="expense-info">
          <div class="expense-memo">${icon} ${escapeHtml(ev.title)}</div>
          <div class="expense-detail">${formatDate(ev.date)} ${timeStr ? timeStr : ''} ${ev.location ? 'ğŸ“' + escapeHtml(ev.location) : ''}${getParticipantBadges(ev.participants) ? '<br>ğŸ‘¥ ' + getParticipantBadges(ev.participants) : ''}</div>
        </div>
      </div>
      <div class="expense-actions">
        <button class="btn-icon-sm" data-edit-itin="${ev.id}" title="ç·¨é›†">&#x270E;</button>
        <button class="btn-icon-sm" data-clone-itin="${ev.id}" title="è¤‡è£½ã—ã¦ä½œæˆ">&#x1F4CB;</button>
        <button class="btn-icon-sm danger" data-delete-itin="${ev.id}" title="å‰Šé™¤">&#x2716;</button>
      </div>
    </div>`;
  }).join('');
}

/* ===== Currency Toggle Helper ===== */
function updateCurrencyToggle(container, activeCurrency, dataAttr) {
  container.querySelectorAll('.toggle-btn').forEach(btn => {
    const val = btn.dataset[dataAttr];
    btn.classList.remove('active-jpy', 'active-aud');
    if (val === activeCurrency) {
      btn.classList.add(activeCurrency === 'JPY' ? 'active-jpy' : 'active-aud');
    }
  });
}

/* ===== Expense Form Helpers ===== */
function getExpenseFormData() {
  const splitChecks = document.querySelectorAll('#split-members input[type="checkbox"]:checked');
  return {
    date: document.getElementById('expense-date').value,
    payerId: document.getElementById('expense-payer').value,
    amount: document.getElementById('expense-amount').value,
    currency: currentCurrency,
    memo: document.getElementById('expense-memo').value,
    splitWith: Array.from(splitChecks).map(cb => cb.value)
  };
}

function resetExpenseForm() {
  document.getElementById('expense-edit-id').value = '';
  document.getElementById('expense-date').value = getTodayString();
  document.getElementById('expense-payer').value = '';
  document.getElementById('expense-amount').value = '';
  document.getElementById('expense-memo').value = '';
  currentCurrency = 'JPY';
  updateCurrencyToggle(document.getElementById('currency-toggle'), 'JPY', 'currency');
  renderSplitCheckboxes();
  document.getElementById('expense-form-title').textContent = 'æ”¯æ‰•ã„ã‚’è¿½åŠ ';
  document.getElementById('expense-submit-btn').textContent = 'è¿½åŠ ã™ã‚‹';
  document.getElementById('btn-cancel-edit').style.display = 'none';
}

function startEditExpense(expenseId) {
  const exp = state.expenses.find(e => e.id === expenseId);
  if (!exp) return;
  document.getElementById('expense-edit-id').value = expenseId;
  document.getElementById('expense-date').value = exp.date;
  document.getElementById('expense-payer').value = exp.payerId;
  document.getElementById('expense-amount').value = exp.amount;
  document.getElementById('expense-memo').value = exp.memo;
  currentCurrency = exp.currency;
  updateCurrencyToggle(document.getElementById('currency-toggle'), currentCurrency, 'currency');
  renderSplitCheckboxes(exp.splitWith);
  document.getElementById('expense-form-title').textContent = 'æ”¯æ‰•ã„ã‚’ç·¨é›†';
  document.getElementById('expense-submit-btn').textContent = 'æ›´æ–°ã™ã‚‹';
  document.getElementById('btn-cancel-edit').style.display = '';
  document.getElementById('expense-form-title').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* ===== Itinerary Form Helpers ===== */
function getItineraryFormData() {
  const participantChecks = document.querySelectorAll('#itin-participants input[type="checkbox"]:checked');
  const participants = Array.from(participantChecks).map(cb => cb.value);
  return {
    date: document.getElementById('itin-date').value,
    time: document.getElementById('itin-time').value,
    endTime: document.getElementById('itin-endtime').value,
    title: document.getElementById('itin-title').value,
    category: document.getElementById('itin-category').value,
    memo: document.getElementById('itin-memo').value,
    url: document.getElementById('itin-url').value,
    location: document.getElementById('itin-location').value,
    mapUrl: document.getElementById('itin-mapurl').value,
    participants: participants
  };
}

function resetItineraryForm() {
  document.getElementById('itin-edit-id').value = '';
  document.getElementById('itin-date').value = getTodayString();
  document.getElementById('itin-time').value = '';
  document.getElementById('itin-endtime').value = '';
  document.getElementById('itin-title').value = '';
  document.getElementById('itin-category').value = 'other';
  document.getElementById('itin-memo').value = '';
  document.getElementById('itin-url').value = '';
  document.getElementById('itin-location').value = '';
  document.getElementById('itin-mapurl').value = '';
  document.getElementById('itin-form-title').textContent = 'äºˆå®šã‚’è¿½åŠ ';
  document.getElementById('itin-submit-btn').textContent = 'è¿½åŠ ã™ã‚‹';
  document.getElementById('btn-cancel-itin-edit').style.display = 'none';
  renderItinParticipants(); // å…¨é¸æŠ
}

function startEditItineraryEvent(eventId) {
  const ev = state.itinerary.find(e => e.id === eventId);
  if (!ev) return;
  document.getElementById('itin-edit-id').value = eventId;
  document.getElementById('itin-date').value = ev.date;
  document.getElementById('itin-time').value = ev.time || '';
  document.getElementById('itin-endtime').value = ev.endTime || '';
  document.getElementById('itin-title').value = ev.title;
  document.getElementById('itin-category').value = ev.category || 'other';
  document.getElementById('itin-memo').value = ev.memo || '';
  document.getElementById('itin-url').value = ev.url || '';
  document.getElementById('itin-location').value = ev.location || '';
  document.getElementById('itin-mapurl').value = ev.mapUrl || '';
  document.getElementById('itin-form-title').textContent = 'äºˆå®šã‚’ç·¨é›†';
  document.getElementById('itin-submit-btn').textContent = 'æ›´æ–°ã™ã‚‹';
  document.getElementById('btn-cancel-itin-edit').style.display = '';
  renderItinParticipants(ev.participants && ev.participants.length > 0 ? ev.participants : null);
  document.getElementById('itin-form-title').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* ===== Export / Import ===== */
function handleExport() {
  const dataStr = JSON.stringify(state, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'travel-expenses-' + getTodayString() + '.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ');
}

function handleImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const imported = JSON.parse(ev.target.result);
      if (!imported.members || !imported.expenses) throw new Error('Invalid');
      state = imported;
      if (!Array.isArray(state.itinerary)) state.itinerary = [];
      if (!state.nextItineraryId) state.nextItineraryId = 1;
      saveState();
      renderAll();
      showToast('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
    } catch (err) {
      showToast('èª­ã¿è¾¼ã¿å¤±æ•—: ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

/* ===== Spreadsheet Link ===== */
function updateSpreadsheetLink() {
  const url = localStorage.getItem('travel-app-spreadsheet-url') || DEFAULT_SPREADSHEET_URL;
  const link = document.getElementById('spreadsheet-link');
  link.href = url;
  link.style.display = 'block';
}

/* ===== Feature 1: Checklist (æŒã¡ç‰©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ) ===== */
let clFilterCat = 'all';
let clFilterMember = 'all';

function generateChecklistId() { return state.nextChecklistId++; }

/* --- Auto-category keyword dictionary (~170 words) --- */
const CL_CATEGORY_KEYWORDS = {
  essential: [
    'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ','è²¡å¸ƒ','ã•ã„ãµ','éµ','ã‹ã','ã‚­ãƒ¼','ãƒã‚±ãƒƒãƒˆ','èˆªç©ºåˆ¸','å…è¨±è¨¼',
    'ä¿é™ºè¨¼','ãƒ“ã‚¶','ç¾é‡‘','ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰','ã‚«ãƒ¼ãƒ‰','èº«åˆ†è¨¼','è¨¼æ˜æ›¸',
    'ã‚¹ãƒãƒ›','æºå¸¯','ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ','æ­ä¹—åˆ¸','äºˆç´„ç¢ºèª','æ—…åˆ¸','ETASã‚¤ãƒ¼ã‚¿ã‚¹'
  ],
  clothes: [
    'Tã‚·ãƒ£ãƒ„','ã‚·ãƒ£ãƒ„','ãƒ‘ãƒ³ãƒ„','ã‚ºãƒœãƒ³','é´ä¸‹','ãã¤ã—ãŸ','ä¸‹ç€','ã—ãŸã',
    'ã‚¸ãƒ£ã‚±ãƒƒãƒˆ','ã‚³ãƒ¼ãƒˆ','ãƒ‘ãƒ¼ã‚«ãƒ¼','ã‚»ãƒ¼ã‚¿ãƒ¼','ãƒ‹ãƒƒãƒˆ','ã‚¹ã‚«ãƒ¼ãƒˆ','ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹',
    'æ°´ç€','ãƒ‘ã‚¸ãƒ£ãƒ','é´','ãã¤','ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼','ã‚µãƒ³ãƒ€ãƒ«','å¸½å­','ã¼ã†ã—',
    'ãƒãƒ•ãƒ©ãƒ¼','æ‰‹è¢‹','ã¦ã¶ãã‚','ãƒ™ãƒ«ãƒˆ','ãƒã‚¯ã‚¿ã‚¤','ã‚¹ãƒ¼ãƒ„','ãƒ‰ãƒ¬ã‚¹',
    'ã‚·ãƒ§ãƒ¼ãƒˆãƒ‘ãƒ³ãƒ„','çŸ­ãƒ‘ãƒ³','ãƒ¬ã‚¤ãƒ³ã‚³ãƒ¼ãƒˆ','ã‚«ãƒ¼ãƒ‡ã‚£ã‚¬ãƒ³','ä¸Šç€','ç¾½ç¹”',
    'ã‚¢ã‚¦ã‚¿ãƒ¼','ã‚¤ãƒ³ãƒŠãƒ¼','è‚Œç€','ã‚¹ãƒˆãƒƒã‚­ãƒ³ã‚°','ã‚¿ã‚¤ãƒ„'
  ],
  electronics: [
    'å……é›»å™¨','ã˜ã‚…ã†ã§ã‚“ã','ã‚«ãƒ¡ãƒ©','ã‚¤ãƒ¤ãƒ›ãƒ³','ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³','PC','ãƒ‘ã‚½ã‚³ãƒ³',
    'ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³','ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ','iPad','ãƒ¢ãƒã‚¤ãƒ«ãƒãƒƒãƒ†ãƒªãƒ¼','ãƒãƒƒãƒ†ãƒªãƒ¼',
    'ã‚±ãƒ¼ãƒ–ãƒ«','USBã‚±ãƒ¼ãƒ–ãƒ«','USB','å¤‰æ›ã‚¢ãƒ€ãƒ—ã‚¿','å¤‰æ›ãƒ—ãƒ©ã‚°','ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼',
    'ã‚³ãƒ³ã‚»ãƒ³ãƒˆå¤‰æ›','ä¸‰è„š','ã•ã‚“ãã‚ƒã','SDã‚«ãƒ¼ãƒ‰','ãƒ¡ãƒ¢ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰',
    'Kindle','ã‚­ãƒ³ãƒ‰ãƒ«','ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼','ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼','ãƒ˜ã‚¢ã‚¢ã‚¤ãƒ­ãƒ³','é›»æºã‚¿ãƒƒãƒ—',
    'WiFi','ãƒã‚±ãƒƒãƒˆWiFi','ãƒ«ãƒ¼ã‚¿ãƒ¼','GoPro','è‡ªæ’®ã‚Šæ£’','å»¶é•·ã‚³ãƒ¼ãƒ‰'
  ],
  toiletry: [
    'æ­¯ãƒ–ãƒ©ã‚·','ã¯ã¶ã‚‰ã—','æ­¯ç£¨ãç²‰','ã¯ã¿ãŒã','ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼','ãƒªãƒ³ã‚¹',
    'ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒŠãƒ¼','ãƒœãƒ‡ã‚£ã‚½ãƒ¼ãƒ—','çŸ³é¹¸','ã›ã£ã‘ã‚“','ã‚¿ã‚ªãƒ«','ãŸãŠã‚‹',
    'ãƒã‚¹ã‚¿ã‚ªãƒ«','åŒ–ç²§å“','ã‘ã—ã‚‡ã†ã²ã‚“','ãƒ¡ã‚¤ã‚¯','ã‚¹ã‚­ãƒ³ã‚±ã‚¢','æ—¥ç„¼ã‘æ­¢ã‚',
    'ã²ã‚„ã‘ã©ã‚','ãƒªãƒƒãƒ—','ã‚¯ãƒªãƒ¼ãƒ ','æ´—é¡”','ã›ã‚“ãŒã‚“','ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ',
    'ã‚³ãƒ³ã‚¿ã‚¯ãƒˆãƒ¬ãƒ³ã‚º','çœ¼é¡','ã‚ãŒã­','ãƒ˜ã‚¢ãƒ–ãƒ©ã‚·','ãã—','é«­å‰ƒã‚Š',
    'ã²ã’ãã‚Š','ã‚«ãƒŸã‚½ãƒª','åˆ¶æ±—å‰¤','ãƒ‡ã‚ªãƒ‰ãƒ©ãƒ³ãƒˆ','ãƒ†ã‚£ãƒƒã‚·ãƒ¥',
    'ã‚¦ã‚§ãƒƒãƒˆãƒ†ã‚£ãƒƒã‚·ãƒ¥','ç¶¿æ£’','ã‚ã‚“ã¼ã†','ãƒãƒ³ã‚«ãƒ','ç”Ÿç†ç”¨å“','çˆªåˆ‡ã‚Š','ã¤ã‚ãã‚Š'
  ],
  medicine: [
    'è–¬','ãã™ã‚Š','å¸¸å‚™è–¬','é¢¨é‚ªè–¬','ã‹ãœãã™ã‚Š','é ­ç—›è–¬','èƒƒè–¬',
    'é…”ã„æ­¢ã‚','ã‚ˆã„ã©ã‚','é®ç—›å‰¤','ç›®è–¬','ã‚ãã™ã‚Š','çµ†å‰µè†','ã°ã‚“ãã†ã“ã†',
    'æ¶ˆæ¯’æ¶²','ä½“æ¸©è¨ˆ','è™«é™¤ã‘','ã‚€ã—ã‚ˆã‘','è™«åˆºã•ã‚Œ','ã‚µãƒ—ãƒª','ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ',
    'ãƒ“ã‚¿ãƒŸãƒ³','ãƒã‚¹ã‚¯','åŒ…å¸¯','å¡—ã‚Šè–¬','è»Ÿè†','ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼è–¬','ä¸‹ç—¢æ­¢ã‚','æ•´è…¸å‰¤'
  ],
  food: [
    'ãŠè“å­','ãŠã‹ã—','æ°´ç­’','ã™ã„ã¨ã†','ãƒœãƒˆãƒ«','ãŠã«ãã‚Š','ãƒ‘ãƒ³',
    'ã‚«ãƒƒãƒ—éºº','ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆ','ãƒ¬ãƒˆãƒ«ãƒˆ','ãµã‚Šã‹ã‘','ãŠèŒ¶','ãŠã¡ã‚ƒ',
    'ã‚³ãƒ¼ãƒ’ãƒ¼','é£´','ã‚ã‚','ã‚¬ãƒ ','ãƒãƒ§ã‚³','ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ','ãƒŠãƒƒãƒ„',
    'ãƒ‰ãƒ©ã‚¤ãƒ•ãƒ«ãƒ¼ãƒ„','ã‚¨ãƒŠã‚¸ãƒ¼ãƒãƒ¼','ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ãƒãƒ¼','ç®¸','ã¯ã—','ã‚¹ãƒ—ãƒ¼ãƒ³',
    'ãƒ•ã‚©ãƒ¼ã‚¯','å¼å½“ç®±','ã‚¿ãƒƒãƒ‘ãƒ¼','ä¿å†·ãƒãƒƒã‚°','æ°´','ãƒŸãƒãƒ©ãƒ«ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼'
  ]
};

const CL_CAT_LABELS = {
  essential:'å¿…éœ€å“', clothes:'è¡£é¡', electronics:'é›»å­æ©Ÿå™¨',
  toiletry:'æ—¥ç”¨å“', medicine:'åŒ»è–¬å“', food:'é£Ÿå“', other:'ãã®ä»–'
};

function detectChecklistCategory(text) {
  const n = text.trim().toLowerCase();
  for (const [cat, keywords] of Object.entries(CL_CATEGORY_KEYWORDS)) {
    for (const kw of keywords) {
      if (n.includes(kw.toLowerCase())) return cat;
    }
  }
  return 'other';
}

/* --- Data migration: old format â†’ new per-member format --- */
function migrateChecklistItems() {
  if (!Array.isArray(state.checklist)) return;
  const allMemberIds = state.members.map(m => m.id);
  state.checklist.forEach(item => {
    // Already migrated?
    if (Array.isArray(item.members) && item.checkedBy && typeof item.checkedBy === 'object' && !Array.isArray(item.checkedBy)) {
      delete item.checked; delete item.assignee;
      return;
    }
    const wasChecked = !!item.checked;
    // Determine members
    if (item.assignee) {
      const aid = Number(item.assignee) || item.assignee;
      item.members = allMemberIds.includes(aid) ? [aid] : [...allMemberIds];
    } else {
      item.members = [...allMemberIds];
    }
    // Build checkedBy
    item.checkedBy = {};
    item.members.forEach(mid => { item.checkedBy[String(mid)] = wasChecked; });
    // Validate category
    if (!item.category || !Object.keys(CL_CAT_LABELS).includes(item.category)) {
      item.category = 'other';
    }
    delete item.checked; delete item.assignee;
  });
}

/* --- Render helpers --- */
function renderChecklistMemberFilter() {
  const c = document.getElementById('cl-member-filter');
  if (!c) return;
  if (state.members.length === 0) { c.innerHTML = ''; return; }
  const allCls = clFilterMember === 'all' ? 'active' : '';
  let h = `<span class="cl-member-filter-btn ${allCls}" data-cl-member="all" style="background:var(--c-text)">å…¨å“¡</span>`;
  state.members.forEach(m => {
    const active = clFilterMember === m.id ? 'active' : '';
    h += `<span class="cl-member-filter-btn ${active}" data-cl-member="${m.id}" style="background:${m.color||'#888'}">${escapeHtml(m.name)}</span>`;
  });
  c.innerHTML = h;
}

function renderChecklistAddMembers() {
  const c = document.getElementById('cl-add-member-checks');
  if (!c) return;
  c.innerHTML = state.members.map(m =>
    `<label style="border-left:3px solid ${m.color||'#888'}"><input type="checkbox" name="cl-member" value="${m.id}" checked> ${escapeHtml(m.name)}</label>`
  ).join('');
}

function renderChecklist() {
  const list = document.getElementById('checklist-list');
  const fillEl = document.getElementById('checklist-progress-fill');
  const summaryEl = document.getElementById('cl-progress-summary');
  const items = state.checklist || [];

  // Filter by category
  let filtered = clFilterCat === 'all' ? [...items] : items.filter(i => i.category === clFilterCat);
  // Filter by member
  if (clFilterMember !== 'all') {
    filtered = filtered.filter(i => (i.members || []).includes(clFilterMember));
  }

  // Calculate overall progress (total member-checks across all items)
  let totalChecks = 0, doneChecks = 0;
  items.forEach(item => {
    (item.members || []).forEach(mid => {
      totalChecks++;
      if (item.checkedBy && item.checkedBy[String(mid)]) doneChecks++;
    });
  });

  // Per-member progress
  const memberProgress = {};
  state.members.forEach(m => { memberProgress[m.id] = { total: 0, done: 0 }; });
  items.forEach(item => {
    (item.members || []).forEach(mid => {
      if (memberProgress[mid]) {
        memberProgress[mid].total++;
        if (item.checkedBy && item.checkedBy[String(mid)]) memberProgress[mid].done++;
      }
    });
  });

  // Render progress
  const pct = totalChecks > 0 ? Math.round(doneChecks / totalChecks * 100) : 0;
  fillEl.style.width = pct + '%';
  let sumH = `<span class="cl-progress-overall">${doneChecks}/${totalChecks}</span>`;
  state.members.forEach(m => {
    const mp = memberProgress[m.id];
    if (mp && mp.total > 0) {
      const done = mp.done === mp.total;
      const filterActive = clFilterMember === m.id ? ' filter-active' : '';
      sumH += `<span class="cl-progress-member${done ? ' done' : ''}${filterActive}" data-cl-member="${m.id}" style="background:${m.color||'#888'}">${escapeHtml(m.name)} <span class="cl-pm-count">${mp.done}/${mp.total}</span></span>`;
    }
  });
  if (summaryEl) summaryEl.innerHTML = sumH;

  // Render member filter & add-form members
  renderChecklistMemberFilter();

  // Update active category tab
  document.querySelectorAll('.cl-cat-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.clCat === clFilterCat);
  });

  // Render items
  if (filtered.length === 0) {
    const msg = items.length === 0 ? 'ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„' : 'ã“ã®ãƒ•ã‚£ãƒ«ã‚¿ã«è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“';
    list.innerHTML = `<p style="text-align:center;color:var(--c-text2);font-size:var(--fs-sm);padding:var(--sp-md) 0;">${msg}</p>`;
    return;
  }

  list.innerHTML = filtered.map(item => {
    const memberIds = item.members || [];
    const allChecked = memberIds.length > 0 && memberIds.every(mid => item.checkedBy && item.checkedBy[String(mid)]);
    const catLabel = CL_CAT_LABELS[item.category] || 'ãã®ä»–';

    const dotsHtml = memberIds.map(mid => {
      const member = state.members.find(m => m.id === mid);
      if (!member) return '';
      const isChecked = item.checkedBy && item.checkedBy[String(mid)];
      const initial = member.name.charAt(0);
      return `<button class="cl-member-dot${isChecked ? ' checked' : ''}" data-cl-toggle="${item.id}" data-cl-member-id="${mid}" style="background:${member.color||'#888'}" title="${escapeHtml(member.name)}${isChecked ? ' âœ“' : ''}"><span class="cl-dot-check">âœ“</span><span class="cl-dot-initial">${escapeHtml(initial)}</span></button>`;
    }).join('');

    return `<div class="cl-item${allChecked ? ' cl-complete' : ''}" data-cl-id="${item.id}">
      <div class="cl-item-main">
        <span class="cl-text">${escapeHtml(item.text)}</span>
        <span class="cl-cat-badge">${catLabel}</span>
        <button class="cl-del" data-cl-delete="${item.id}" title="å‰Šé™¤">&times;</button>
      </div>
      <div class="cl-member-checks">${dotsHtml}</div>
    </div>`;
  }).join('');
}

function addChecklistItem(text, category) {
  const trimmed = (text || '').trim();
  if (!trimmed) return false;
  // Auto-detect category
  const detectedCat = detectChecklistCategory(trimmed);
  const finalCat = (category && category !== 'all' && category !== 'other') ? category : detectedCat;
  // Gather selected members from form
  const cbs = document.querySelectorAll('#cl-add-member-checks input[type=checkbox]');
  let selectedMembers = [];
  cbs.forEach(cb => { if (cb.checked) selectedMembers.push(Number(cb.value)); });
  if (selectedMembers.length === 0) selectedMembers = state.members.map(m => m.id);
  // Init checkedBy
  const checkedBy = {};
  selectedMembers.forEach(mid => { checkedBy[String(mid)] = false; });
  state.checklist.push({
    id: generateChecklistId(),
    text: trimmed,
    members: selectedMembers,
    checkedBy: checkedBy,
    category: finalCat
  });
  saveState();
  return true;
}

function toggleChecklistItem(itemId, memberId) {
  const item = state.checklist.find(i => i.id === itemId);
  if (!item || !item.checkedBy) return;
  const key = String(memberId);
  item.checkedBy[key] = !item.checkedBy[key];
  saveState();
}

function deleteChecklistItem(id) {
  state.checklist = state.checklist.filter(i => i.id !== id);
  saveState();
}

/* ===== Feature 2: Share Today's Schedule (ä»Šæ—¥ã®äºˆå®šã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼) ===== */
function shareSchedule() {
  const today = getTodayString();
  const todayEvents = state.itinerary
    .filter(ev => ev.date === today)
    .sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));

  if (todayEvents.length === 0) {
    showToast('ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  const dates = [...new Set(state.itinerary.map(e => e.date))].sort();
  const firstDate = dates[0];
  const dayNum = firstDate ? Math.floor((new Date(today) - new Date(firstDate)) / 86400000) + 1 : 1;

  let text = `ğŸ“‹ Day ${dayNum} - ${formatDateFull(today)} ã®äºˆå®š\n`;
  text += 'â”'.repeat(24) + '\n\n';

  todayEvents.forEach(ev => {
    const icon = CATEGORY_ICONS[ev.category] || 'ğŸ“Œ';
    let line = icon + ' ';
    if (ev.time) {
      line += ev.time;
      if (ev.endTime) line += 'ã€œ' + ev.endTime;
      line += '  ';
    }
    line += ev.title;
    text += line + '\n';
    if (ev.location) text += `   ğŸ“ ${ev.location}\n`;
    if (ev.memo) text += `   ğŸ“ ${ev.memo}\n`;
    text += '\n';
  });

  text += 'â”'.repeat(24) + '\n';
  text += `âœ¨ æ—…ã®ã—ãŠã‚Šã‚¢ãƒ—ãƒª ã‚ˆã‚Š`;

  if (navigator.share) {
    navigator.share({ title: `Day ${dayNum} ã®äºˆå®š`, text: text }).catch(() => {
      copyToClipboard(text);
    });
  } else {
    copyToClipboard(text);
  }
}

function copyToClipboard(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => {
      showToast('ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    }).catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.select();
  try { document.execCommand('copy'); showToast('ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
  catch(e) { showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  document.body.removeChild(ta);
}

/* ===== Feature 3: Spending Dashboard (æ”¯å‡ºã‚µãƒãƒªãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰) ===== */
let dashPayerCurrency = 'JPY';
let dashDailyCurrency = 'JPY';

function renderDashboard() {
  const statsEl = document.getElementById('dashboard-stats');
  const catEl = document.getElementById('dashboard-category');
  const dailyEl = document.getElementById('dashboard-daily');
  const emptyEl = document.getElementById('dashboard-empty');
  const legendEl = document.getElementById('dash-legend');

  if (!state.expenses || state.expenses.length === 0) {
    statsEl.innerHTML = ''; catEl.innerHTML = ''; dailyEl.innerHTML = '';
    if (legendEl) legendEl.innerHTML = '';
    emptyEl.hidden = false;
    return;
  }
  emptyEl.hidden = true;

  const rate = state.exchangeRate || 95;
  const barColors = ['#4466ce', '#e05688', '#16a34a', '#e97c1f', '#8b5cf6', '#0891b2', '#dc2626', '#6d28d9'];

  // Currency conversion helpers
  function toJPY(amount, currency) { return currency === 'AUD' ? amount * rate : amount; }
  function toAUD(amount, currency) { return currency === 'JPY' ? amount / rate : amount; }
  function convertTo(amount, currency, target) { return target === 'AUD' ? toAUD(amount, currency) : toJPY(amount, currency); }
  function fmtCur(val, cur) { return cur === 'AUD' ? formatAmount(Math.round(val * 100) / 100, 'AUD') : formatAmount(Math.round(val), 'JPY'); }
  function fmtShort(val, cur) {
    if (cur === 'AUD') return '$' + (Math.round(val * 10) / 10);
    if (val >= 10000) return 'Â¥' + (Math.round(val / 1000)) + 'k';
    return 'Â¥' + Math.round(val);
  }

  // === Stats grid (always JPY-based summary) ===
  const totalJPY = state.expenses.reduce((s, e) => s + toJPY(e.amount, e.currency), 0);
  const perPerson = state.members.length > 0 ? totalJPY / state.members.length : totalJPY;
  const totalAUD = state.expenses.filter(e => e.currency === 'AUD').reduce((s, e) => s + e.amount, 0);

  statsEl.innerHTML = `
    <div class="dash-stat"><div class="dash-val">${formatAmount(Math.round(totalJPY), 'JPY')}</div><div class="dash-label">ç·æ”¯å‡º(å††æ›ç®—)</div></div>
    <div class="dash-stat"><div class="dash-val">${state.expenses.length}ä»¶</div><div class="dash-label">æ”¯æ‰•ã„å›æ•°</div></div>
    <div class="dash-stat"><div class="dash-val">${formatAmount(Math.round(perPerson), 'JPY')}</div><div class="dash-label">1äººã‚ãŸã‚Š</div></div>
    <div class="dash-stat"><div class="dash-val">${totalAUD > 0 ? formatAmount(totalAUD, 'AUD') : '-'}</div><div class="dash-label">AUDæ”¯å‡ºåˆè¨ˆ</div></div>
  `;

  // === Update currency toggle active state ===
  document.querySelectorAll('#dash-currency-payer .dash-cur-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.cur === dashPayerCurrency);
  });
  document.querySelectorAll('#dash-currency-daily .dash-cur-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.cur === dashDailyCurrency);
  });

  // === Per-person horizontal bars ===
  const pCur = dashPayerCurrency;
  const perPersonMap = {};
  state.members.forEach(m => { perPersonMap[m.id] = 0; });
  state.expenses.forEach(e => {
    if (perPersonMap[e.payerId] !== undefined) {
      perPersonMap[e.payerId] += convertTo(e.amount, e.currency, pCur);
    }
  });
  const maxSpent = Math.max(...Object.values(perPersonMap), 0.01);

  catEl.innerHTML = state.members.map((m, i) => {
    const spent = perPersonMap[m.id] || 0;
    const pct = maxSpent > 0 ? (spent / maxSpent * 100) : 0;
    const color = m.color || barColors[i % barColors.length];
    return `<div class="cat-bar-row">
      <span class="cat-bar-label">${escapeHtml(m.name)}</span>
      <div class="cat-bar-track"><div class="cat-bar-fill" style="width:${pct}%;background:${color}"></div></div>
      <span class="cat-bar-val">${fmtCur(spent, pCur)}</span>
    </div>`;
  }).join('');

  // === Daily stacked bar chart ===
  const dCur = dashDailyCurrency;
  // Build per-day per-member data
  const dailyPersonMap = {}; // { date: { memberId: amount } }
  state.expenses.forEach(e => {
    if (!e.date) return;
    if (!dailyPersonMap[e.date]) dailyPersonMap[e.date] = {};
    const mid = e.payerId;
    if (!dailyPersonMap[e.date][mid]) dailyPersonMap[e.date][mid] = 0;
    dailyPersonMap[e.date][mid] += convertTo(e.amount, e.currency, dCur);
  });
  const dailyDates = Object.keys(dailyPersonMap).sort();
  if (dailyDates.length === 0) { dailyEl.innerHTML = ''; if (legendEl) legendEl.innerHTML = ''; return; }

  // Compute daily totals and find max
  const dailyTotals = {};
  dailyDates.forEach(d => {
    dailyTotals[d] = Object.values(dailyPersonMap[d]).reduce((s, v) => s + v, 0);
  });
  const maxDaily = Math.max(...Object.values(dailyTotals), 0.01);

  // Build stacked columns - adapt height to column count
  const colCount = dailyDates.length;
  const chartHeight = colCount <= 5 ? 130 : colCount <= 8 ? 110 : 90;
  dailyEl.style.height = chartHeight + 'px';
  // Shorter format for many columns (no currency symbol)
  function fmtDailyLabel(val, cur) {
    if (cur === 'AUD') return Math.round(val) + '';
    if (val >= 10000) return Math.round(val / 1000) + 'k';
    if (val >= 1000) return (Math.round(val / 100) / 10) + 'k';
    return Math.round(val) + '';
  }

  dailyEl.innerHTML = dailyDates.map(d => {
    const total = dailyTotals[d];
    const colH = Math.max(4, total / maxDaily * 100);
    const [, mo, day] = d.split('-');
    // Segments for each member (bottom to top)
    const segs = state.members.map((m, i) => {
      const val = (dailyPersonMap[d] && dailyPersonMap[d][m.id]) || 0;
      if (val <= 0) return '';
      const segH = (val / total) * colH;
      const color = m.color || barColors[i % barColors.length];
      return `<div class="daily-seg" style="height:${segH}%;background:${color}" title="${escapeHtml(m.name)}: ${fmtCur(val, dCur)}"></div>`;
    }).join('');
    const topLabel = colCount <= 7 ? fmtShort(total, dCur) : fmtDailyLabel(total, dCur);
    return `<div class="daily-col" style="height:100%;">
      <div style="display:flex;flex-direction:column-reverse;height:${colH}%;width:100%;">${segs}</div>
      <span class="daily-col-total">${topLabel}</span>
      <span class="daily-col-label">${Number(day)}</span>
    </div>`;
  }).join('');

  // === Legend ===
  if (legendEl) {
    legendEl.innerHTML = state.members.map((m, i) => {
      const color = m.color || barColors[i % barColors.length];
      return `<span class="dash-legend-item"><span class="dash-legend-dot" style="background:${color}"></span>${escapeHtml(m.name)}</span>`;
    }).join('');
  }
}

/* ===== Feature 4: Weather (å¤©æ°—äºˆå ±é€£æº) ===== */
let weatherCache = {};

async function fetchWeather(date) {
  // Only fetch for dates within 7 days from now
  const now = new Date();
  const target = new Date(date);
  const diffDays = Math.floor((target - now) / 86400000);
  if (diffDays < -1 || diffDays > 6) return null;

  if (weatherCache[date]) return weatherCache[date];

  try {
    // Open-Meteo free API (no key needed)
    // Default: Sydney coordinates (can be customized)
    const lat = localStorage.getItem('travel-app-weather-lat') || '-33.87';
    const lon = localStorage.getItem('travel-app-weather-lon') || '151.21';
    const res = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&start_date=${date}&end_date=${date}`,
      { signal: AbortSignal.timeout(5000) }
    );
    if (!res.ok) return null;
    const data = await res.json();
    if (data.daily && data.daily.time && data.daily.time.includes(date)) {
      const idx = data.daily.time.indexOf(date);
      const wcode = data.daily.weathercode[idx];
      const tmax = Math.round(data.daily.temperature_2m_max[idx]);
      const tmin = Math.round(data.daily.temperature_2m_min[idx]);
      const weather = { icon: weatherCodeToEmoji(wcode), tmax, tmin, code: wcode };
      weatherCache[date] = weather;
      return weather;
    }
  } catch(e) { /* ignore */ }
  return null;
}

function weatherCodeToEmoji(code) {
  if (code === 0) return 'â˜€ï¸';
  if (code <= 3) return 'â›…';
  if (code <= 48) return 'ğŸŒ«ï¸';
  if (code <= 57) return 'ğŸŒ¦ï¸';
  if (code <= 67) return 'ğŸŒ§ï¸';
  if (code <= 77) return 'â„ï¸';
  if (code <= 82) return 'ğŸŒ§ï¸';
  if (code <= 86) return 'â„ï¸';
  if (code <= 99) return 'â›ˆï¸';
  return 'ğŸŒ¤ï¸';
}

async function injectWeatherBadges() {
  const headers = document.querySelectorAll('.itin-day-header');
  for (const header of headers) {
    // Extract date from header text
    const text = header.textContent;
    // Find the date by matching against itinerary dates
    const dates = [...new Set(state.itinerary.map(e => e.date))].sort();
    const dayMatch = text.match(/Day\s+(\d+)/);
    if (!dayMatch) continue;
    const dayNum = parseInt(dayMatch[1]);
    const firstDate = dates[0];
    if (!firstDate) continue;
    const targetDate = new Date(firstDate);
    targetDate.setDate(targetDate.getDate() + dayNum - 1);
    const dateStr = targetDate.getFullYear() + '-' + String(targetDate.getMonth() + 1).padStart(2, '0') + '-' + String(targetDate.getDate()).padStart(2, '0');

    // Remove existing weather badge
    const existing = header.querySelector('.weather-badge');
    if (existing) existing.remove();

    const weather = await fetchWeather(dateStr);
    if (weather) {
      const badge = document.createElement('span');
      badge.className = 'weather-badge';
      badge.innerHTML = `${weather.icon} <span class="w-temp">${weather.tmin}Â°ã€œ${weather.tmax}Â°</span>`;
      header.appendChild(badge);
    }
  }
}

/* ===== Feature 5: Templates (ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½) ===== */
const TEMPLATES = [
  { icon: 'âœˆï¸', name: 'ç©ºæ¸¯â†’ãƒ›ãƒ†ãƒ«', events: [
    { time: '08:00', endTime: '12:00', title: 'ç©ºæ¸¯å‡ºç™º â†’ åˆ°ç€', category: 'flight' },
    { time: '13:00', endTime: '14:00', title: 'ãƒ›ãƒ†ãƒ«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³', category: 'hotel' }
  ]},
  { icon: 'ğŸ—ºï¸', name: 'è¦³å…‰1æ—¥', events: [
    { time: '09:00', endTime: '12:00', title: 'åˆå‰ã®è¦³å…‰ã‚¹ãƒãƒƒãƒˆ', category: 'sightseeing' },
    { time: '12:00', endTime: '13:00', title: 'ãƒ©ãƒ³ãƒ', category: 'food' },
    { time: '13:30', endTime: '17:00', title: 'åˆå¾Œã®è¦³å…‰ã‚¹ãƒãƒƒãƒˆ', category: 'sightseeing' },
    { time: '18:00', endTime: '19:30', title: 'ãƒ‡ã‚£ãƒŠãƒ¼', category: 'food' }
  ]},
  { icon: 'ğŸ–ï¸', name: 'ãƒ“ãƒ¼ãƒæ—¥', events: [
    { time: '09:00', endTime: '12:00', title: 'ãƒ“ãƒ¼ãƒã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£', category: 'sightseeing' },
    { time: '12:30', endTime: '13:30', title: 'ã‚·ãƒ¼ã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ', category: 'food' },
    { time: '14:00', endTime: '16:00', title: 'è‡ªç”±æ™‚é–“', category: 'other' }
  ]},
  { icon: 'ğŸ›ï¸', name: 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°', events: [
    { time: '10:00', endTime: '12:30', title: 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ«', category: 'sightseeing' },
    { time: '12:30', endTime: '13:30', title: 'ãƒ©ãƒ³ãƒ', category: 'food' },
    { time: '14:00', endTime: '17:00', title: 'ãƒãƒ¼ã‚±ãƒƒãƒˆå·¡ã‚Š', category: 'sightseeing' }
  ]},
  { icon: 'ğŸ¨', name: 'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ', events: [
    { time: '08:00', endTime: '09:00', title: 'æœé£Ÿ', category: 'food' },
    { time: '10:00', endTime: '10:30', title: 'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ', category: 'hotel' },
    { time: '11:00', endTime: '15:00', title: 'ç©ºæ¸¯ã¸ç§»å‹• â†’ å‡ºç™º', category: 'flight' }
  ]},
  { icon: 'ğŸ½ï¸', name: 'ã‚°ãƒ«ãƒ¡ãƒ„ã‚¢ãƒ¼', events: [
    { time: '09:00', endTime: '10:00', title: 'ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã‚«ãƒ•ã‚§', category: 'food' },
    { time: '11:30', endTime: '13:00', title: 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ãƒ¼ãƒ‰å·¡ã‚Š', category: 'food' },
    { time: '15:00', endTime: '16:00', title: 'ã‚¹ã‚¤ãƒ¼ãƒ„ï¼†ã‚«ãƒ•ã‚§', category: 'food' },
    { time: '18:30', endTime: '20:00', title: 'ãƒ‡ã‚£ãƒŠãƒ¼ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', category: 'food' }
  ]}
];

function renderTemplates() {
  const grid = document.getElementById('template-grid');
  grid.innerHTML = TEMPLATES.map((tpl, i) => `
    <div class="tpl-card" data-tpl-idx="${i}">
      <div class="tpl-icon">${tpl.icon}</div>
      <div class="tpl-name">${escapeHtml(tpl.name)}</div>
    </div>
  `).join('');
}

function applyTemplate(idx) {
  const tpl = TEMPLATES[idx];
  if (!tpl) return;
  const dateInput = document.getElementById('itin-date');
  const date = dateInput.value || getTodayString();
  const allMembers = state.members.map(m => m.id);

  tpl.events.forEach(ev => {
    addItineraryEvent({
      date: date,
      time: ev.time || '',
      endTime: ev.endTime || '',
      title: ev.title,
      category: ev.category || 'other',
      memo: '',
      url: '',
      location: ev.location || '',
      mapUrl: '',
      participants: [...allMembers]
    });
  });

  renderItinerary();
  renderItinEditList();
  showToast(`ã€Œ${tpl.name}ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ (${tpl.events.length}ä»¶)`);
}

/* ===== Render All ===== */
function renderAll() {
  renderMembers();
  renderPayerSelect();
  renderSplitCheckboxes();
  renderItinParticipants();
  renderExpenses();
  renderSettlement();
  renderItinerary();
  renderItinEditList();
  renderChecklist();
  renderDashboard();
  renderTemplates();
  document.getElementById('exchange-rate').value = state.exchangeRate;
  updateCurrencyToggle(document.getElementById('settle-currency-toggle'), state.settleCurrency, 'settle');
  // Weather injection (async, non-blocking)
  injectWeatherBadges();
}

/* ===== Event Listeners ===== */
function initEventListeners() {
  // Tab switching
  document.querySelector('.tab-nav').addEventListener('click', function(e) {
    const btn = e.target.closest('.tab-btn');
    if (!btn) return;
    const tabId = btn.dataset.tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    if (tabId === 'itinerary') { renderItinerary(); renderItinEditList(); renderItinParticipants(); renderTemplates(); injectWeatherBadges(); }
    if (tabId === 'checklist') { renderChecklist(); }
    if (tabId === 'money') { renderPayerSelect(); renderSplitCheckboxes(); renderExpenses(); renderSettlement(); renderDashboard(); }
    if (tabId === 'settings') { renderMembers(); updateSpreadsheetLink(); }
  });

  // Add member
  document.getElementById('form-add-member').addEventListener('submit', function(e) {
    e.preventDefault();
    const input = document.getElementById('input-member-name');
    if (addMember(input.value)) {
      input.value = '';
      renderMembers();
      renderPayerSelect();
      renderSplitCheckboxes();
      showToast('ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    }
  });

  // Delete member & edit member name
  document.getElementById('member-list').addEventListener('click', function(e) {
    // Delete
    const btn = e.target.closest('[data-delete-member]');
    if (btn) {
      const id = btn.dataset.deleteMember;
      const name = getMemberName(id);
      showModal(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, 'å‰Šé™¤ã™ã‚‹', function() {
        if (removeMember(id)) {
          renderMembers(); renderPayerSelect(); renderSplitCheckboxes();
          showToast('ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }
        closeModal();
      });
      return;
    }
    // Edit name â€” click on .member-name to start inline editing
    const nameEl = e.target.closest('.member-name');
    if (nameEl && !e.target.closest('.member-name-edit')) {
      const mid = nameEl.dataset.memberId;
      const member = state.members.find(m => String(m.id) === mid);
      if (!member) return;
      const oldName = member.name;
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'member-name-edit';
      input.value = oldName;
      input.maxLength = 20;
      input.style.color = member.color || '';
      nameEl.replaceWith(input);
      input.focus();
      input.select();
      function commitEdit() {
        const newName = input.value.trim();
        if (newName && newName !== oldName) {
          if (state.members.some(m => m.name === newName && m.id !== member.id)) {
            showToast('åŒã˜åå‰ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã™');
          } else {
            member.name = newName;
            saveState();
            showToast('åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
          }
        }
        renderMembers();
        renderPayerSelect();
        renderSplitCheckboxes();
        renderExpenses();
        renderItinerary();
        renderItinEditList();
        renderChecklist();
      }
      input.addEventListener('blur', commitEdit);
      input.addEventListener('keydown', function(ev) {
        if (ev.key === 'Enter') { ev.preventDefault(); input.blur(); }
        if (ev.key === 'Escape') { input.value = oldName; input.blur(); }
      });
    }
  });

  // Member color picker change
  document.getElementById('member-list').addEventListener('input', function(e) {
    if (!e.target.matches('.member-color-picker')) return;
    const id = e.target.dataset.colorMember;
    const color = e.target.value;
    const m = state.members.find(m => m.id === id);
    if (m) {
      m.color = color;
      saveState();
      renderMembers();
      renderItinerary();
      renderItinFilter();
      renderItinEditList();
    }
  });

  // Expense form submit
  document.getElementById('form-expense').addEventListener('submit', function(e) {
    e.preventDefault();
    const editId = document.getElementById('expense-edit-id').value;
    const data = getExpenseFormData();
    if (editId) {
      if (updateExpense(Number(editId), data)) { resetExpenseForm(); renderExpenses(); showToast('æ”¯æ‰•ã„ã‚’æ›´æ–°ã—ã¾ã—ãŸ'); }
    } else {
      if (addExpense(data)) { resetExpenseForm(); renderExpenses(); showToast('æ”¯æ‰•ã„ã‚’è¿½åŠ ã—ã¾ã—ãŸ'); }
    }
  });

  // Expense list actions
  document.getElementById('expense-list').addEventListener('click', function(e) {
    // Show all / collapse toggle
    if (e.target.id === 'btn-exp-toggle') { expShowAll = !expShowAll; renderExpenses(); return; }
    const editBtn = e.target.closest('[data-edit-expense]');
    const deleteBtn = e.target.closest('[data-delete-expense]');
    if (editBtn) { startEditExpense(Number(editBtn.dataset.editExpense)); }
    else if (deleteBtn) {
      const id = Number(deleteBtn.dataset.deleteExpense);
      showModal('ã“ã®æ”¯æ‰•ã„è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', 'å‰Šé™¤ã™ã‚‹', function() { deleteExpense(id); renderExpenses(); closeModal(); showToast('æ”¯æ‰•ã„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); });
    }
  });

  document.getElementById('btn-cancel-edit').addEventListener('click', resetExpenseForm);

  // Currency toggle
  document.getElementById('currency-toggle').addEventListener('click', function(e) {
    const btn = e.target.closest('.toggle-btn');
    if (!btn) return;
    currentCurrency = btn.dataset.currency;
    updateCurrencyToggle(this, currentCurrency, 'currency');
  });

  // Split member controls
  document.getElementById('btn-select-all').addEventListener('click', function() {
    document.querySelectorAll('#split-members input[type="checkbox"]').forEach(cb => cb.checked = true);
  });
  document.getElementById('btn-deselect-all').addEventListener('click', function() {
    document.querySelectorAll('#split-members input[type="checkbox"]').forEach(cb => cb.checked = false);
  });

  // Settlement currency toggle
  document.getElementById('settle-currency-toggle').addEventListener('click', function(e) {
    const btn = e.target.closest('.toggle-btn');
    if (!btn) return;
    state.settleCurrency = btn.dataset.settle;
    updateCurrencyToggle(this, state.settleCurrency, 'settle');
    saveState(); renderSettlement();
  });

  // Exchange rate
  document.getElementById('exchange-rate').addEventListener('input', function() {
    state.exchangeRate = Number(this.value) || 95;
    saveState(); renderSettlement();
  });

  // Itinerary form submit
  document.getElementById('form-itinerary').addEventListener('submit', function(e) {
    e.preventDefault();
    const editId = document.getElementById('itin-edit-id').value;
    const data = getItineraryFormData();
    if (editId) {
      if (updateItineraryEvent(Number(editId), data)) { resetItineraryForm(); renderItinerary(); renderItinEditList(); showToast('äºˆå®šã‚’æ›´æ–°ã—ã¾ã—ãŸ'); }
    } else {
      if (addItineraryEvent(data)) { resetItineraryForm(); renderItinerary(); renderItinEditList(); showToast('äºˆå®šã‚’è¿½åŠ ã—ã¾ã—ãŸ'); }
    }
  });

  document.getElementById('btn-cancel-itin-edit').addEventListener('click', resetItineraryForm);

  // Itinerary participant select all / deselect all
  document.getElementById('btn-itin-select-all').addEventListener('click', function() {
    document.querySelectorAll('#itin-participants input[type="checkbox"]').forEach(cb => cb.checked = true);
  });
  document.getElementById('btn-itin-deselect-all').addEventListener('click', function() {
    document.querySelectorAll('#itin-participants input[type="checkbox"]').forEach(cb => cb.checked = false);
  });

  // Itinerary filter (delegated)
  document.getElementById('itin-filter').addEventListener('click', function(e) {
    const btn = e.target.closest('.filter-btn');
    if (!btn) return;
    itinFilterMember = btn.dataset.filter;
    renderItinerary();
  });

  // Itinerary view: memo badge toggle + edit/delete from schedule tab
  document.getElementById('itinerary-list').addEventListener('click', function(e) {
    // Memo badge toggle
    const badge = e.target.closest('.itin-memo-badge');
    if (badge) {
      const id = badge.dataset.memoToggle;
      const memo = document.getElementById('itin-memo-' + id);
      if (memo) {
        memo.classList.toggle('open');
        badge.classList.toggle('open');
      }
      return;
    }

    // Edit from schedule view â†’ open accordion and populate form
    const editBtn = e.target.closest('[data-view-edit-itin]');
    if (editBtn) {
      const id = Number(editBtn.dataset.viewEditItin);
      // Open the edit accordion if closed
      const editBody = document.getElementById('itin-edit-body');
      const editToggle = document.getElementById('itin-edit-toggle');
      if (!editBody.classList.contains('open')) {
        editBody.classList.add('open');
        editToggle.classList.add('open');
      }
      renderItinParticipants();
      // Populate form and scroll to it
      startEditItineraryEvent(id);
      return;
    }

    // Delete from schedule view
    const deleteBtn = e.target.closest('[data-view-delete-itin]');
    if (deleteBtn) {
      const id = Number(deleteBtn.dataset.viewDeleteItin);
      showModal('ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', 'å‰Šé™¤ã™ã‚‹', function() {
        deleteItineraryEvent(id);
        renderItinerary();
        renderItinEditList();
        closeModal();
        showToast('äºˆå®šã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      });
      return;
    }
  });

  // Itinerary edit list actions
  document.getElementById('itin-edit-list').addEventListener('click', function(e) {
    const editBtn = e.target.closest('[data-edit-itin]');
    const cloneBtn = e.target.closest('[data-clone-itin]');
    const deleteBtn = e.target.closest('[data-delete-itin]');
    if (editBtn) { startEditItineraryEvent(Number(editBtn.dataset.editItin)); }
    else if (cloneBtn) {
      const id = Number(cloneBtn.dataset.cloneItin);
      const src = state.itinerary.find(ev => ev.id === id);
      if (src) {
        const cloned = {
          date: src.date, time: src.time, endTime: src.endTime,
          title: src.title + 'ï¼ˆã‚³ãƒ”ãƒ¼ï¼‰', category: src.category,
          memo: src.memo, url: src.url, location: src.location,
          mapUrl: src.mapUrl, participants: [...(src.participants || [])]
        };
        if (addItineraryEvent(cloned)) {
          renderItinerary();
          renderItinEditList();
          showToast('äºˆå®šã‚’è¤‡è£½ã—ã¾ã—ãŸ');
        }
      }
    }
    else if (deleteBtn) {
      const id = Number(deleteBtn.dataset.deleteItin);
      showModal('ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', 'å‰Šé™¤ã™ã‚‹', function() {
        deleteItineraryEvent(id);
        renderItinerary();
        renderItinEditList();
        closeModal();
        showToast('äºˆå®šã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      });
    }
  });

  // Modal
  document.getElementById('modal-confirm').addEventListener('click', function() { if (modalCallback) modalCallback(); });
  document.getElementById('modal-cancel').addEventListener('click', closeModal);
  document.getElementById('modal-overlay').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

  // Export / Import
  document.getElementById('btn-export').addEventListener('click', handleExport);
  document.getElementById('btn-import').addEventListener('click', function() { document.getElementById('import-file').click(); });
  document.getElementById('import-file').addEventListener('change', handleImport);

  // Cloud sync button: ã‚¿ãƒƒãƒ—=ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å–å¾—ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ãŒæ­£ï¼‰
  // é•·æŠ¼ã—=ãƒ­ãƒ¼ã‚«ãƒ«ã‚¯ãƒªã‚¢ï¼†ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å†å–å¾—
  {
    const syncBtn = document.getElementById('btn-sync');
    let pressTimer = null;
    let longPressed = false;
    syncBtn.addEventListener('pointerdown', function() {
      longPressed = false;
      pressTimer = setTimeout(async () => {
        longPressed = true;
        if (confirm('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å†å–å¾—ã—ã¾ã™ã‹ï¼Ÿ')) {
          localStorage.removeItem(APP_KEY);
          state = createDefaultState();
          showToast('ã‚¯ãƒªã‚¢ï¼†å†å–å¾—ä¸­...');
          await syncFromCloud();
          showToast('ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å†å–å¾—å®Œäº†ï¼');
        }
      }, 1500);
    });
    syncBtn.addEventListener('pointerup', async function() {
      clearTimeout(pressTimer);
      if (!longPressed) {
        showToast('ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å–å¾—ä¸­...');
        await syncFromCloud();
        showToast('ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å–å¾—å®Œäº†');
      }
    });
    syncBtn.addEventListener('pointerleave', function() { clearTimeout(pressTimer); });
  }

  // Cloud upload button: ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ï¼ˆæ˜ç¤ºçš„æ“ä½œã®ã¿ï¼‰
  document.getElementById('btn-cloud-upload').addEventListener('click', async function() {
    if (!confirm('ç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ï¼ˆGoogleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼‰ã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) return;
    showToast('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ä¸­...');
    await syncToCloud();
    showToast('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜å®Œäº†ï¼');
  });

  // Settings button â†’ switch to settings tab
  document.getElementById('btn-cloud-settings').addEventListener('click', function() {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.tab-btn[data-tab="settings"]').classList.add('active');
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.getElementById('tab-settings').classList.add('active');
    renderMembers();
    updateSpreadsheetLink();
  });
  // GAS URL modal (é–‹ç™ºè€…å‘ã‘ï¼šã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒªãƒ³ã‚¯ã‚’é•·æŠ¼ã—ã§é–‹ã)
  document.getElementById('cloud-modal-cancel').addEventListener('click', function() {
    document.getElementById('cloud-modal-overlay').hidden = true;
  });
  document.getElementById('cloud-modal-overlay').addEventListener('click', function(e) {
    if (e.target === this) this.hidden = true;
  });

  // ===== Itinerary edit accordion toggle =====
  document.getElementById('itin-edit-toggle').addEventListener('click', function() {
    this.classList.toggle('open');
    document.getElementById('itin-edit-body').classList.toggle('open');
  });

  // ===== Feature 1: Checklist event listeners =====

  // Checklist category tabs
  document.getElementById('cl-cat-tabs').addEventListener('click', function(e) {
    const tab = e.target.closest('.cl-cat-tab');
    if (!tab) return;
    clFilterCat = tab.dataset.clCat;
    renderChecklist();
  });

  // Member filter (filter bar)
  document.getElementById('cl-member-filter').addEventListener('click', function(e) {
    const btn = e.target.closest('.cl-member-filter-btn');
    if (!btn) return;
    const val = btn.dataset.clMember;
    clFilterMember = val === 'all' ? 'all' : Number(val);
    renderChecklist();
  });

  // Member filter (progress badge tap)
  document.getElementById('cl-progress-summary').addEventListener('click', function(e) {
    const badge = e.target.closest('.cl-progress-member');
    if (!badge) return;
    const val = badge.dataset.clMember;
    if (!val) return;
    const mid = Number(val);
    clFilterMember = clFilterMember === mid ? 'all' : mid;
    renderChecklist();
  });

  // Checklist add item
  document.getElementById('cl-add-btn').addEventListener('click', function() {
    const input = document.getElementById('cl-new-item');
    const catSelect = document.getElementById('cl-cat-select');
    if (addChecklistItem(input.value, catSelect.value)) {
      input.value = '';
      catSelect.value = 'other';
      document.getElementById('cl-add-meta').hidden = true;
      renderChecklist();
    } else {
      showToast('ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
  });
  document.getElementById('cl-new-item').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('cl-add-btn').click();
    }
  });
  // Show meta panel on focus, auto-detect category on input
  document.getElementById('cl-new-item').addEventListener('focus', function() {
    document.getElementById('cl-add-meta').hidden = false;
    renderChecklistAddMembers();
  });
  document.getElementById('cl-new-item').addEventListener('input', function() {
    const text = this.value.trim();
    if (text.length > 0) {
      document.getElementById('cl-cat-select').value = detectChecklistCategory(text);
    }
  });

  // Checklist toggle (member dot click) & delete
  document.getElementById('checklist-list').addEventListener('click', function(e) {
    const dot = e.target.closest('.cl-member-dot');
    if (dot) {
      toggleChecklistItem(Number(dot.dataset.clToggle), Number(dot.dataset.clMemberId));
      renderChecklist();
      return;
    }
    const del = e.target.closest('[data-cl-delete]');
    if (del) {
      deleteChecklistItem(Number(del.dataset.clDelete));
      renderChecklist();
    }
  });

  // ===== Feature 2: Share schedule button =====
  document.getElementById('btn-share-schedule').addEventListener('click', shareSchedule);

  // ===== Feature 5: Template grid click =====
  document.getElementById('template-grid').addEventListener('click', function(e) {
    const card = e.target.closest('.tpl-card');
    if (!card) return;
    const idx = Number(card.dataset.tplIdx);
    applyTemplate(idx);
  });

  // ===== Feature 3: Dashboard currency toggles =====
  document.getElementById('dash-currency-payer').addEventListener('click', function(e) {
    const btn = e.target.closest('.dash-cur-btn');
    if (!btn) return;
    dashPayerCurrency = btn.dataset.cur;
    renderDashboard();
  });
  document.getElementById('dash-currency-daily').addEventListener('click', function(e) {
    const btn = e.target.closest('.dash-cur-btn');
    if (!btn) return;
    dashDailyCurrency = btn.dataset.cur;
    renderDashboard();
  });
}

/* ===== Fetch Live Exchange Rate ===== */
async function fetchExchangeRate() {
  const statusEl = document.getElementById('rate-status');
  statusEl.textContent = 'æœ€æ–°ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—ä¸­...';
  statusEl.className = 'rate-status';
  const apis = [
    { url: 'https://api.exchangerate-api.com/v4/latest/AUD', parse: (data) => data.rates && data.rates.JPY },
    { url: 'https://open.er-api.com/v6/latest/AUD', parse: (data) => data.rates && data.rates.JPY }
  ];
  for (const api of apis) {
    try {
      const res = await fetch(api.url, { signal: AbortSignal.timeout(5000) });
      if (!res.ok) continue;
      const data = await res.json();
      const rate = api.parse(data);
      if (rate && rate > 0) {
        const rounded = Math.round(rate * 100) / 100;
        state.exchangeRate = rounded;
        document.getElementById('exchange-rate').value = rounded;
        saveState(); renderSettlement();
        const now = new Date();
        const timeStr = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');
        statusEl.textContent = `${timeStr} ã«æœ€æ–°ãƒ¬ãƒ¼ãƒˆã‚’å–å¾— (1 AUD = ${rounded} å††)`;
        statusEl.className = 'rate-status success';
        return;
      }
    } catch (e) { /* try next */ }
  }
  statusEl.textContent = 'å–å¾—å¤±æ•— (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼Ÿ) - æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
  statusEl.className = 'rate-status error';
}

/* ===== Init ===== */
function init() {
  loadState();

  // === ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯GASã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æŠ•å…¥æ¸ˆã¿ ===
  // ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸæ™‚ã«è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã™
  // å¾©å…ƒã™ã‚‹å ´åˆ: ./restore-data.sh ã‚’å®Ÿè¡Œ

  initEventListeners();
  document.getElementById('expense-date').value = getTodayString();
  document.getElementById('itin-date').value = getTodayString();
  renderAll();
  updateSpreadsheetLink();
  fetchExchangeRate();
  // ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼ˆè¨­å®šæ¸ˆã¿ãªã‚‰ï¼‰
  if (getGasUrl()) {
    syncFromCloud();
  } else {
    setSyncStatus('off');
    cloudSyncReady = true;
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
